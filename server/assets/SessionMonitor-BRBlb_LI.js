import{W as ve,r as _,d as w,X as fe,Y as me,w as ge,cj as pe,C as k,D as l,a0 as y,G as t,z as s,aY as f,a2 as n,$ as b,B as Q,a4 as _e,a3 as ye,n as we,a7 as xe,F as v}from"./vendor-Cpjz-SYi.js";import{a5 as h,k as F,h as U,i as B,c as m,s as z,g as i,j as M,a4 as W,q as I,N as Se,t as ke,I as Y,V as be,f as he,_ as qe}from"./index-DvMw0XIj.js";import{d as G}from"./en-US-CEnKpqyg.js";import{f as J}from"./format-BraVObjy.js";import{f as Ce}from"./formatDistanceToNow-B6Nhz5gL.js";const Fe={class:"d-flex align-center"},Le={class:"ml-3"},Ve={class:"text-h5"},Ue={class:"text-subtitle-2 text-grey"},Ie={key:0,class:"ml-2"},Re={class:"d-flex align-center gap-2"},Ae={class:"stat-box success-stat"},De={class:"stat-value"},Ne={class:"stat-box error-stat"},Te={class:"stat-value"},Be={class:"metric-value"},ze={class:"metric-value"},Me={class:"metric-value"},Pe={class:"d-flex align-center"},$e={class:"d-flex align-center gap-2"},He={class:"queue-stat pending"},je={class:"queue-stat-value"},Ee={class:"queue-stat processing"},Oe={class:"queue-stat-value"},Qe={class:"queue-stat done"},We={class:"queue-stat-value"},Ye={class:"queue-stat failed"},Ge={class:"queue-stat-value"},Je={class:"queue-stat blocked"},Xe={class:"queue-stat-value"},Ke={class:"queue-stat total"},Ze={class:"queue-stat-value"},es={class:"mt-4"},ss={class:"d-flex align-center"},ts={class:"d-flex align-center gap-2"},ls={class:"log-timestamp"},as={class:"log-level"},os={class:"log-message"},rs={key:0,class:"log-context"},ns={key:0,class:"text-center pa-4 text-grey"},is={key:1,class:"text-center pa-4"},us=ve({__name:"SessionMonitor",setup(ds){const X=xe(),P=pe();let r=!1;const o=_(null),p=_([]),c=_({pending:0,processing:0,done:0,failed:0,blocked:0}),u=_({session:!1,logs:!1,queue:!1,resetStale:!1,resetFailed:!1}),R=_(!1),L=_(null),g=_(!0),q=_("all"),x=_(null);let A=null,D=null,N=null;const $=w(()=>!o.value||!o.value.total_urls?0:Math.round(o.value.processed_count/o.value.total_urls*100)),T=w(()=>c.value.pending+c.value.processing+c.value.done+c.value.failed+c.value.blocked),H=w(()=>T.value===0?0:Math.round(c.value.done/T.value*100)),K=w(()=>{if(!o.value?.started_at)return"N/A";try{return Ce(new Date(o.value.started_at),{includeSeconds:!0})}catch{return"N/A"}}),S=w(()=>{if(!o.value||o.value.status!=="running"||!o.value.started_at||o.value.processed_count===0)return 0;const a=G(new Date,new Date(o.value.started_at)),e=o.value.total_urls-o.value.processed_count,d=o.value.processed_count/a;return d===0?0:Math.round(e/d/60)}),Z=w(()=>{if(!o.value||o.value.status!=="running")return"N/A";if(S.value===0)return"Calculating...";if(S.value>60){const a=Math.floor(S.value/60),e=S.value%60;return`${a}h ${e}m`}return`${S.value}m`}),ee=w(()=>{if(!o.value?.started_at||o.value.processed_count===0)return"N/A";const a=G(new Date,new Date(o.value.started_at));return a===0?"N/A":`${(o.value.processed_count/a).toFixed(2)} items/sec`}),se=w(()=>q.value==="all"?p.value:q.value==="error"?p.value.filter(a=>a.level==="error"||a.level==="critical"):q.value==="warning"?p.value.filter(a=>a.level==="warning"):p.value);fe(()=>{r=!1,te(),A=window.setInterval(V,5e3),D=window.setInterval(j,2e3),N=window.setInterval(C,1e4)}),me(()=>{r=!0,A&&clearInterval(A),D&&clearInterval(D),N&&clearInterval(N)}),ge(()=>p.value.length,()=>{g.value&&!r&&O()});async function te(){r||await Promise.all([V(),j(),C()])}async function V(){if(!r)try{u.value.session=!0,L.value=null;const a=Number(P.params.id),e=await h.getSession(a);r||(o.value=e)}catch(a){r||(L.value=a.message||"Unknown error",console.error("Failed to load session:",a))}finally{r||(u.value.session=!1)}}async function j(){if(!r)try{u.value.logs=!0;const a=Number(P.params.id),e=await h.getSessionLogs(a,{per_page:500});r||(p.value=e.data)}catch(a){r||console.error("Failed to load logs:",a)}finally{r||(u.value.logs=!1)}}async function le(){if(!(r||!o.value)&&confirm("Are you sure you want to force stop this session?"))try{R.value=!0,await h.stopSession(o.value.id),r||await V()}catch(a){if(!r){const e=a?.response?.data?.message||"Failed to stop session";console.error("Failed to stop session:",a),alert(e)}}finally{r||(R.value=!1)}}async function C(){if(!(r||!o.value))try{u.value.queue=!0;const a=await h.getQueueStats(o.value.supplier);r||(c.value=a)}catch(a){r||console.error("Failed to load queue stats:",a)}finally{r||(u.value.queue=!1)}}async function ae(){if(!r)try{u.value.resetStale=!0;const a=await h.resetStaleUrls();r||(alert(`Reset ${a.reset_count} stale URLs`),await C())}catch(a){r||(console.error("Failed to reset stale URLs:",a),alert("Failed to reset stale URLs"))}finally{r||(u.value.resetStale=!1)}}async function oe(){if(!(r||!o.value)&&confirm("Reset all failed URLs back to pending? This will retry them."))try{u.value.resetFailed=!0;const a=await h.resetFailedUrls(o.value.supplier);r||(alert(`Reset ${a.reset_count} failed URLs`),await C())}catch(a){r||(console.error("Failed to reset failed URLs:",a),alert("Failed to reset failed URLs"))}finally{r||(u.value.resetFailed=!1)}}function E(a){switch(a){case"completed":return"success";case"running":return"primary";case"failed":return"error";case"stopped":return"warning";case"pending":return"grey";default:return"grey"}}function re(a){if(!a)return"N/A";try{return J(new Date(a),"MMM dd, HH:mm:ss")}catch{return"Invalid date"}}function ne(a){try{return J(new Date(a),"HH:mm:ss.SSS")}catch{return""}}function ie(){g.value=!g.value,g.value&&O()}function ue(){p.value=[]}function O(){we(()=>{x.value&&!r&&(x.value.scrollTop=x.value.scrollHeight)})}function de(){if(!x.value)return;const{scrollTop:a,scrollHeight:e,clientHeight:d}=x.value;!(a+d>=e-10)&&g.value&&(g.value=!1)}function ce(){X.push("/parser")}return(a,e)=>(v(),k(he,{fluid:"",class:"session-monitor"},{default:l(()=>[o.value?(v(),k(F,{key:0},{default:l(()=>[t(i,{cols:"12"},{default:l(()=>[t(U,{class:"session-header",elevation:"2"},{default:l(()=>[t(B,{class:"d-flex align-center justify-space-between"},{default:l(()=>[s("div",Fe,[t(m,{icon:"mdi-arrow-left",variant:"text",onClick:ce}),s("div",Le,[s("div",Ve,[f(n(o.value.supplier)+" ",1),t(z,{color:E(o.value.status),class:"ml-2",size:"small"},{default:l(()=>[f(n(o.value.status.toUpperCase()),1)]),_:1},8,["color"])]),s("div",Ue,[f(" Session #"+n(o.value.id)+" | Started: "+n(re(o.value.started_at))+" ",1),o.value.pid?(v(),b("span",Ie,"| PID: "+n(o.value.pid),1)):y("",!0)])])]),s("div",Re,[o.value.status==="running"?(v(),k(m,{key:0,color:"error",variant:"elevated","prepend-icon":"mdi-stop",onClick:le,loading:R.value},{default:l(()=>[...e[1]||(e[1]=[f(" Force Stop ",-1)])]),_:1},8,["loading"])):y("",!0),t(m,{icon:"mdi-refresh",variant:"text",onClick:V,loading:u.value.session},null,8,["loading"])])]),_:1})]),_:1})]),_:1}),t(i,{cols:"12"},{default:l(()=>[t(U,{class:"metrics-card",elevation:"2"},{default:l(()=>[t(M,null,{default:l(()=>[t(F,{align:"center"},{default:l(()=>[t(i,{cols:"12",md:"6"},{default:l(()=>[e[2]||(e[2]=s("div",{class:"metric-label mb-2"},"Processing Progress",-1)),t(W,{"model-value":$.value,color:E(o.value.status),height:"30",class:"progress-bar"},{default:l(()=>[s("strong",null,n(o.value.processed_count)+" / "+n(o.value.total_urls||"?")+" ("+n($.value)+"%) ",1)]),_:1},8,["model-value","color"])]),_:1}),t(i,{cols:"6",md:"3"},{default:l(()=>[s("div",Ae,[t(I,{icon:"mdi-check-circle",size:"large",color:"success"}),s("div",De,n(o.value.success_count),1),e[3]||(e[3]=s("div",{class:"stat-label"},"Success",-1))])]),_:1}),t(i,{cols:"6",md:"3"},{default:l(()=>[s("div",Ne,[t(I,{icon:"mdi-alert-circle",size:"large",color:"error"}),s("div",Te,n(o.value.error_count),1),e[4]||(e[4]=s("div",{class:"stat-label"},"Errors",-1))])]),_:1}),t(i,{cols:"6",md:"3"},{default:l(()=>[e[5]||(e[5]=s("div",{class:"metric-label"},"Runtime",-1)),s("div",Be,n(K.value),1)]),_:1}),t(i,{cols:"6",md:"3"},{default:l(()=>[e[6]||(e[6]=s("div",{class:"metric-label"},"ETA",-1)),s("div",{class:Q(["metric-value",{"text-warning":S.value>30}])},n(Z.value),3)]),_:1}),t(i,{cols:"6",md:"3"},{default:l(()=>[e[7]||(e[7]=s("div",{class:"metric-label"},"Speed",-1)),s("div",ze,n(ee.value),1)]),_:1}),t(i,{cols:"6",md:"3"},{default:l(()=>[e[8]||(e[8]=s("div",{class:"metric-label"},"Screenshots",-1)),s("div",Me,n(o.value.screenshots_taken),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(i,{cols:"12"},{default:l(()=>[t(U,{class:"queue-stats-card",elevation:"2"},{default:l(()=>[t(B,{class:"d-flex align-center justify-space-between"},{default:l(()=>[s("div",Pe,[t(I,{icon:"mdi-database",class:"mr-2"}),e[9]||(e[9]=s("span",null,"URL Queue Status",-1))]),s("div",$e,[t(m,{size:"small",variant:"outlined",color:"warning","prepend-icon":"mdi-refresh",onClick:ae,loading:u.value.resetStale},{default:l(()=>[...e[10]||(e[10]=[f(" Reset Stale ",-1)])]),_:1},8,["loading"]),t(m,{size:"small",variant:"outlined",color:"error","prepend-icon":"mdi-restart",onClick:oe,loading:u.value.resetFailed},{default:l(()=>[...e[11]||(e[11]=[f(" Reset Failed ",-1)])]),_:1},8,["loading"]),t(m,{icon:"mdi-refresh",variant:"text",size:"small",onClick:C,loading:u.value.queue},null,8,["loading"])])]),_:1}),t(M,null,{default:l(()=>[t(F,null,{default:l(()=>[t(i,{cols:"6",sm:"4",md:"2"},{default:l(()=>[s("div",He,[s("div",je,n(c.value.pending),1),e[12]||(e[12]=s("div",{class:"queue-stat-label"},"Pending",-1))])]),_:1}),t(i,{cols:"6",sm:"4",md:"2"},{default:l(()=>[s("div",Ee,[s("div",Oe,n(c.value.processing),1),e[13]||(e[13]=s("div",{class:"queue-stat-label"},"Processing",-1))])]),_:1}),t(i,{cols:"6",sm:"4",md:"2"},{default:l(()=>[s("div",Qe,[s("div",We,n(c.value.done),1),e[14]||(e[14]=s("div",{class:"queue-stat-label"},"Done",-1))])]),_:1}),t(i,{cols:"6",sm:"4",md:"2"},{default:l(()=>[s("div",Ye,[s("div",Ge,n(c.value.failed),1),e[15]||(e[15]=s("div",{class:"queue-stat-label"},"Failed",-1))])]),_:1}),t(i,{cols:"6",sm:"4",md:"2"},{default:l(()=>[s("div",Je,[s("div",Xe,n(c.value.blocked),1),e[16]||(e[16]=s("div",{class:"queue-stat-label"},"Blocked",-1))])]),_:1}),t(i,{cols:"6",sm:"4",md:"2"},{default:l(()=>[s("div",Ke,[s("div",Ze,n(T.value),1),e[17]||(e[17]=s("div",{class:"queue-stat-label"},"Total",-1))])]),_:1})]),_:1}),s("div",es,[e[18]||(e[18]=s("div",{class:"metric-label mb-2"},"Queue Completion",-1)),t(W,{"model-value":H.value,color:"success",height:"24",class:"queue-progress"},{default:l(()=>[s("strong",null,n(H.value)+"% done",1)]),_:1},8,["model-value"])])]),_:1})]),_:1})]),_:1}),t(i,{cols:"12"},{default:l(()=>[t(U,{class:"logs-terminal",elevation:"2"},{default:l(()=>[t(B,{class:"d-flex align-center justify-space-between"},{default:l(()=>[s("div",ss,[t(I,{icon:"mdi-console",class:"mr-2"}),e[20]||(e[20]=s("span",null,"Live Logs",-1)),g.value?(v(),k(z,{key:0,color:"primary",size:"small",class:"ml-2"},{default:l(()=>[...e[19]||(e[19]=[f(" AUTO-SCROLL ",-1)])]),_:1})):y("",!0),t(z,{size:"small",class:"ml-2"},{default:l(()=>[f(n(p.value.length)+" entries ",1)]),_:1})]),s("div",ts,[t(Se,{modelValue:q.value,"onUpdate:modelValue":e[0]||(e[0]=d=>q.value=d),variant:"outlined",density:"compact",mandatory:""},{default:l(()=>[t(m,{value:"all"},{default:l(()=>[...e[21]||(e[21]=[f("All",-1)])]),_:1}),t(m,{value:"error",color:"error"},{default:l(()=>[...e[22]||(e[22]=[f("Errors",-1)])]),_:1}),t(m,{value:"warning",color:"warning"},{default:l(()=>[...e[23]||(e[23]=[f("Warnings",-1)])]),_:1})]),_:1},8,["modelValue"]),t(m,{icon:g.value?"mdi-pause":"mdi-play",color:g.value?"primary":"grey",variant:"text",onClick:ie,title:g.value?"Disable Auto-scroll":"Enable Auto-scroll"},null,8,["icon","color","title"]),t(m,{icon:"mdi-delete",variant:"text",onClick:ue,title:"Clear Logs"})])]),_:1}),t(ke),t(M,{class:"pa-0"},{default:l(()=>[s("div",{ref_key:"logsContainer",ref:x,class:"logs-container",onScroll:de},[(v(!0),b(ye,null,_e(se.value,d=>(v(),b("div",{key:d.id,class:Q(["log-line",`log-${d.level||"info"}`])},[s("span",ls,n(ne(d.created_at)),1),s("span",as,n((d.level||"INFO").toUpperCase()),1),s("span",os,n(d.message),1),d.context?(v(),b("span",rs,n(JSON.stringify(d.context)),1)):y("",!0)],2))),128)),p.value.length===0?(v(),b("div",ns," No logs yet... ")):y("",!0),u.value.logs?(v(),b("div",is,[t(Y,{indeterminate:"",size:"32"})])):y("",!0)],544)]),_:1})]),_:1})]),_:1})]),_:1})):y("",!0),!o.value&&u.value.session?(v(),k(F,{key:1},{default:l(()=>[t(i,{cols:"12",class:"text-center pa-8"},{default:l(()=>[t(Y,{indeterminate:"",size:"64"}),e[24]||(e[24]=s("div",{class:"mt-4 text-h6"},"Loading session...",-1))]),_:1})]),_:1})):y("",!0),!o.value&&!u.value.session&&L.value?(v(),k(F,{key:2},{default:l(()=>[t(i,{cols:"12"},{default:l(()=>[t(be,{type:"error",prominent:""},{default:l(()=>[e[25]||(e[25]=s("div",{class:"text-h6"},"Failed to load session",-1)),s("div",null,n(L.value),1)]),_:1})]),_:1})]),_:1})):y("",!0)]),_:1}))}}),_s=qe(us,[["__scopeId","data-v-ffaa28a7"]]);export{_s as default};
