import{W as ul,r as f,w as Re,$ as w,G as l,D as s,z as o,a9 as ql,aW as r,a1 as we,a3 as ie,a4 as be,a0 as h,A as da,C as $,a2 as d,f as Js,F as v,d as X,B as ct,aX as Ks,X as ca,a as Xs,n as pa,bG as il,bH as nl,ck as ma,cl as Qs,ag as Gs,ah as Ys}from"./vendor-BQXrruHR.js";import{d as x,z as ya,h as R,i as ee,r as Pl,c as b,q as S,A as wa,a as rl,j as G,k as ae,g as A,b as D,B as he,t as ye,v as et,x as Pe,C as at,w as De,m as Q,D as Ft,E as Ml,s as te,_ as dl,F as Zs,G as St,H as Mt,I as Nl,V as We,J as eo,o as Ve,e as to,K as lo,f as $t,y as ao,L as va,M as fa,N as _a,O as so,P as tt,Q as oo,p as lt,l as Al,R as io,S as no,T as ro,U as uo,W as co,X as zl}from"./index-B_oQPGco.js";class po{async getAll(z){const{data:_}=await x.get(`/api/projects/${z}/labor-works`);return Array.isArray(_)?_:_.data||[]}async create(z,_){const{data:i}=await x.post(`/api/projects/${z}/labor-works`,_);return i.data||i}async getOne(z,_){const{data:i}=await x.get(`/api/projects/${z}/labor-works/${_}`);return i.data||i}async update(z,_,i){const{data:M}=await x.put(`/api/projects/${z}/labor-works/${_}`,i);return M.data||M}async delete(z,_){await x.delete(`/api/projects/${z}/labor-works/${_}`)}async reorder(z,_){const{data:i}=await x.patch(`/api/projects/${z}/labor-works/reorder`,{order:_});return i}}const qt=new po,mo={class:"d-flex align-center justify-space-between gap-3"},vo={class:"d-flex gap-2"},fo={class:"d-flex flex-grow-1 overflow-hidden"},_o={class:"settings-sidebar"},go={class:"settings-content"},yo={class:"settings-content-scroll"},wo={key:0,class:"section-content"},bo={key:0,class:"text-warning text-caption mt-2",style:{display:"flex","align-items":"center",gap:"6px"}},ko={key:1,class:"section-content"},xo={class:"mb-3"},ho={class:"d-flex align-center gap-3"},Vo={key:2,class:"section-content"},$o={key:3,class:"section-content"},Co={class:"d-flex flex-column gap-4"},Fo={class:"d-flex align-center gap-3",style:{"flex-wrap":"nowrap"}},So={class:"d-flex align-center gap-1",style:{"flex-shrink":"0"}},jo={class:"d-flex align-center gap-1",style:{"flex-shrink":"0"}},Uo={class:"d-flex align-center gap-3",style:{"flex-wrap":"nowrap"}},Do={class:"d-flex align-center gap-1",style:{"flex-shrink":"0"}},Ao={class:"d-flex align-center gap-1",style:{"flex-shrink":"0"}},zo={class:"d-flex align-center gap-3",style:{"flex-wrap":"nowrap"}},Po={class:"d-flex align-center gap-1",style:{"flex-shrink":"0"}},No={class:"d-flex align-center gap-1",style:{"flex-shrink":"0"}},qo={key:4,class:"section-content"},Mo={class:"mb-4"},Lo={key:1,class:"text-caption text-warning d-flex align-center gap-1"},Eo={key:0,class:"mb-4"},Io={class:"d-flex align-center justify-space-between mb-2"},To={class:"d-flex align-center gap-2"},Oo={class:"text-caption font-weight-bold"},Ro={class:"d-flex gap-1"},Wo=ul({__name:"ProjectSettingsDrawer",props:{modelValue:{type:Boolean},project:{},regions:{},materials:{}},emits:["update:modelValue","saved","cancelled","error"],setup(H,{emit:z}){const _=H,i=z,M=Js("axios"),c=f(JSON.parse(JSON.stringify(_.project))),de=f(0),U=f(!1),_e=f(!1),$e=f(null),pe=f(!1),ne=f(!1),q=y=>{ne.value=!0,c.value=JSON.parse(JSON.stringify(y)),pe.value=!1,setTimeout(()=>{ne.value=!1},0)},B=f(!1),ve=f(null),ce=f({title:"",text:""}),st=[{title:"Основное",icon:"mdi-folder-settings"},{title:"Коэффициенты",icon:"mdi-tune"},{title:"Материалы",icon:"mdi-package-variant"},{title:"Отходы",icon:"mdi-recycle"},{title:"Справочные блоки",icon:"mdi-text-box-outline"}];Re(()=>_.project,y=>{_.modelValue&&pe.value||q(y)},{deep:!0}),Re(()=>_.modelValue,y=>{y?(de.value=0,q(_.project)):pe.value=!1}),Re(c,()=>{_.modelValue&&(ne.value||(pe.value=!0,$e.value&&clearTimeout($e.value),$e.value=window.setTimeout(()=>{Fe()},1e3)))},{deep:!0});const me=y=>{i("update:modelValue",y),y||i("cancelled")},Ce=()=>{i("update:modelValue",!1),i("cancelled")},Fe=async()=>{if(!U.value){U.value=!0;try{i("saved",c.value)}catch(y){console.error("Error saving settings:",y),i("error",y.message||"Ошибка сохранения настроек")}finally{U.value=!1}}},Be=async()=>{if(!M){console.error("Axios instance not available"),i("error","Ошибка: сервис запросов недоступен");return}_e.value=!0;try{const{data:y}=await M.get("/api/user/settings");c.value.region_id=y.region_id??c.value.region_id,c.value.waste_coefficient=y.waste_coefficient??c.value.waste_coefficient,c.value.repair_coefficient=y.repair_coefficient??c.value.repair_coefficient,c.value.waste_plate_coefficient=y.waste_plate_coefficient??c.value.waste_plate_coefficient,c.value.waste_edge_coefficient=y.waste_edge_coefficient??c.value.waste_edge_coefficient,c.value.waste_operations_coefficient=y.waste_operations_coefficient??c.value.waste_operations_coefficient,c.value.apply_waste_to_plate=y.apply_waste_to_plate??c.value.apply_waste_to_plate,c.value.apply_waste_to_edge=y.apply_waste_to_edge??c.value.apply_waste_to_edge,c.value.apply_waste_to_operations=y.apply_waste_to_operations??c.value.apply_waste_to_operations,c.value.use_area_calc_mode=y.use_area_calc_mode??c.value.use_area_calc_mode,c.value.default_plate_material_id=y.default_plate_material_id??c.value.default_plate_material_id,c.value.default_edge_material_id=y.default_edge_material_id??c.value.default_edge_material_id,y.text_blocks&&(c.value.text_blocks=y.text_blocks),y.waste_plate_description&&(c.value.waste_plate_description=y.waste_plate_description),y.waste_edge_description&&(c.value.waste_edge_description=y.waste_edge_description),y.waste_operations_description&&(c.value.waste_operations_description=y.waste_operations_description),c.value.show_waste_plate_description=y.show_waste_plate_description??c.value.show_waste_plate_description,c.value.show_waste_edge_description=y.show_waste_edge_description??c.value.show_waste_edge_description,c.value.show_waste_operations_description=y.show_waste_operations_description??c.value.show_waste_operations_description,i("update:modelValue",!1),i("cancelled")}catch(y){console.error("Error loading user settings:",y),i("error",y.response?.data?.message||y.message||"Ошибка загрузки настроек")}finally{_e.value=!1}},I=()=>{c.value.text_blocks||(c.value.text_blocks=[]),c.value.text_blocks.length<10&&c.value.text_blocks.push({title:"",text:"",enabled:!0})},re=y=>{c.value.text_blocks&&c.value.text_blocks.splice(y,1)},ke=y=>{if(c.value.text_blocks&&y>0){const u=c.value.text_blocks[y];c.value.text_blocks[y]=c.value.text_blocks[y-1],c.value.text_blocks[y-1]=u}},Se=y=>{if(c.value.text_blocks&&y<c.value.text_blocks.length-1){const u=c.value.text_blocks[y];c.value.text_blocks[y]=c.value.text_blocks[y+1],c.value.text_blocks[y+1]=u}},je=()=>({plate:"плитных материалов",edge:"кромочных материалов",operations:"операций"})[ve.value||""]||"",Xe=y=>{ve.value=y;let u=null;y==="plate"?u=c.value.waste_plate_description||null:y==="edge"?u=c.value.waste_edge_description||null:y==="operations"&&(u=c.value.waste_operations_description||null),ce.value=u?{title:u.title,text:u.text}:{title:"",text:""},B.value=!0},jt=()=>{if(!ve.value)return;const y={title:ce.value.title.trim(),text:Ne(ce.value.text)};ve.value==="plate"?y.title||y.text?(c.value.waste_plate_description=y,c.value.show_waste_plate_description=!0):(c.value.waste_plate_description=null,c.value.show_waste_plate_description=!1):ve.value==="edge"?y.title||y.text?(c.value.waste_edge_description=y,c.value.show_waste_edge_description=!0):(c.value.waste_edge_description=null,c.value.show_waste_edge_description=!1):ve.value==="operations"&&(y.title||y.text?(c.value.waste_operations_description=y,c.value.show_waste_operations_description=!0):(c.value.waste_operations_description=null,c.value.show_waste_operations_description=!1)),Qe()},Qe=()=>{B.value=!1,ve.value=null,ce.value={title:"",text:""}},Ne=y=>{let u=y.replace(/<[^>]*>/g,"");return u=u.replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),u=u.split(`
`).map(g=>g.replace(/[ \t]+/g," ").trim()).filter(g=>g.length>0).join(`
`),u},He=y=>y.replace(/\r\n/g,`
`).replace(/\n{3,}/g,`

`).replace(/\u00A0/g," ").split(`
`).map(u=>u.replace(/[ \t]+/g," ").trim()).filter(u=>u.length>0).join(`
`).trim(),Ue=y=>{try{let u=y;u=u.replace(/<\/?(p|div|br\s*\/?|li|ul|ol|h[1-6])>/gi,`
`),u=u.replace(/<a[^>]*>(.*?)<\/a>/gi,"$1"),u=u.replace(/<[^>]*>/g,"");const g=document.createElement("textarea");return g.innerHTML=u,u=g.value,u=u.replace(/\r\n/g,`
`).replace(/\n{3,}/g,`

`).replace(/[ \t]+/g," ").trim(),u}catch(u){return console.error("Error cleaning HTML:",u),y.replace(/<[^>]*>/g,"").trim()}},Ie=(y,u)=>{try{u.preventDefault();const g=u.clipboardData;if(!g)return;let T="";const W=g.getData("text/html");if(W&&W.trim().length>0?T=Ue(W):T=g.getData("text/plain")||"",!T.trim())return;const Te=He(T);y.text=(y.text?y.text+`

`:"")+Te,y.text=Ne(y.text)}catch(g){console.error("Error during paste:",g)}},J=y=>{try{y.preventDefault();const u=y.clipboardData;if(!u)return;let g="";const T=u.getData("text/html");T&&T.trim().length>0?g=Ue(T):g=u.getData("text/plain")||"";const W=He(g);ce.value.text=(ce.value.text?ce.value.text+`

`:"")+W,ce.value.text=Ne(ce.value.text)}catch(u){console.error("Error during paste:",u)}};return(y,u)=>(v(),w("div",null,[l(ya,{"model-value":H.modelValue,"onUpdate:modelValue":me,location:"right",width:"1200",temporary:"",elevation:"16",class:"settings-drawer",style:{"max-width":"95vw"}},{default:s(()=>[l(R,{class:"h-100 d-flex flex-column rounded-0"},{default:s(()=>[l(ee,{class:"pa-4 border-b"},{default:s(()=>[o("div",mo,[u[27]||(u[27]=o("span",null,"Настройки проекта",-1)),o("div",vo,[l(Pl,{text:"Загрузить дефолты из личных настроек"},{activator:s(({props:g})=>[l(b,ql({icon:"",variant:"text",size:"small"},g,{onClick:Be,loading:_e.value}),{default:s(()=>[l(S,null,{default:s(()=>[...u[25]||(u[25]=[r("mdi-download",-1)])]),_:1})]),_:1},16,["loading"])]),_:1}),l(b,{icon:"",variant:"text",size:"small",onClick:we(Ce,["stop"])},{default:s(()=>[l(S,null,{default:s(()=>[...u[26]||(u[26]=[r("mdi-close",-1)])]),_:1})]),_:1})])])]),_:1}),o("div",fo,[o("div",_o,[l(wa,{"model-value":de.value,"onUpdate:modelValue":u[0]||(u[0]=g=>de.value=g),class:"py-0"},{default:s(()=>[(v(),w(ie,null,be(st,(g,T)=>l(Ft,{key:T,value:T,onClick:W=>de.value=T},{prepend:s(()=>[l(S,{icon:g.icon,size:"small",class:"mr-3"},null,8,["icon"])]),default:s(()=>[l(Ml,{class:"text-subtitle-2"},{default:s(()=>[r(d(g.title),1)]),_:2},1024)]),_:2},1032,["value","onClick"])),64))]),_:1},8,["model-value"])]),o("div",go,[l(rl,{class:"h-100 d-flex flex-column"},{default:s(()=>[o("div",yo,[de.value===0?(v(),w("div",wo,[u[30]||(u[30]=o("div",{class:"section-title"},"Основное",-1)),u[31]||(u[31]=o("div",{class:"section-hint"},"Базовые сведения о проекте (дела), объекте и эксперте",-1)),l(R,{variant:"outlined",class:"content-card"},{default:s(()=>[l(G,null,{default:s(()=>[l(ae,{dense:""},{default:s(()=>[l(A,{cols:"12",md:"6"},{default:s(()=>[l(D,{modelValue:c.value.number,"onUpdate:modelValue":u[1]||(u[1]=g=>c.value.number=g),label:"№ дела"},null,8,["modelValue"])]),_:1}),l(A,{cols:"12",md:"6"},{default:s(()=>[l(D,{modelValue:c.value.expert_name,"onUpdate:modelValue":u[2]||(u[2]=g=>c.value.expert_name=g),label:"ФИО эксперта"},null,8,["modelValue"])]),_:1}),l(A,{cols:"12"},{default:s(()=>[l(D,{modelValue:c.value.address,"onUpdate:modelValue":u[3]||(u[3]=g=>c.value.address=g),label:"Адрес объекта"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),u[32]||(u[32]=o("div",{class:"section-title mt-6"},"Методика и регион",-1)),u[33]||(u[33]=o("div",{class:"section-hint"},"Влияет на расчёт ставок по профилям нормируемых работ",-1)),l(R,{variant:"outlined",class:"content-card"},{default:s(()=>[l(G,null,{default:s(()=>[l(ae,{dense:""},{default:s(()=>[l(A,{cols:"12",md:"6"},{default:s(()=>[l(he,{modelValue:c.value.region_id,"onUpdate:modelValue":u[4]||(u[4]=g=>c.value.region_id=g),items:H.regions,"item-title":"name","item-value":"id",label:"Регион",clearable:"",density:"compact",hint:"Используется для расчёта ставок по профилям","menu-props":{maxHeight:300}},null,8,["modelValue","items"]),c.value.region_id?h("",!0):(v(),w("div",bo,[l(S,{size:"small"},{default:s(()=>[...u[28]||(u[28]=[r("mdi-alert-circle-outline",-1)])]),_:1}),u[29]||(u[29]=o("span",null,"Регион не выбран. Ставки будут расчитаны по умолчанию.",-1))]))]),_:1})]),_:1})]),_:1})]),_:1})])):h("",!0),de.value===1?(v(),w("div",ko,[u[35]||(u[35]=o("div",{class:"section-title"},"Коэффициенты",-1)),u[36]||(u[36]=o("div",{class:"section-hint"},"Применяются при расчёте стоимости материалов",-1)),l(R,{variant:"outlined",class:"content-card"},{default:s(()=>[l(G,null,{default:s(()=>[l(ae,{dense:""},{default:s(()=>[l(A,{cols:"12",md:"6"},{default:s(()=>[l(D,{modelValue:c.value.waste_coefficient,"onUpdate:modelValue":u[5]||(u[5]=g=>c.value.waste_coefficient=g),modelModifiers:{number:!0},label:"Коэффициент обрезков",type:"number",min:"1",step:"0.01",hint:"1.00 = без изменения","persistent-hint":""},null,8,["modelValue"])]),_:1}),l(A,{cols:"12",md:"6"},{default:s(()=>[l(D,{modelValue:c.value.repair_coefficient,"onUpdate:modelValue":u[6]||(u[6]=g=>c.value.repair_coefficient=g),modelModifiers:{number:!0},label:"Ремонтный коэффициент",type:"number",min:"1",step:"0.01",hint:"1.00 = без изменения","persistent-hint":""},null,8,["modelValue"])]),_:1})]),_:1}),l(ye,{class:"my-4"}),o("div",xo,[o("div",ho,[o("span",{class:"text-subtitle-2",style:da({color:c.value.use_area_calc_mode?"#666":"#1976d2"})},"Расчёт по листам",4),l(et,{modelValue:c.value.use_area_calc_mode,"onUpdate:modelValue":u[7]||(u[7]=g=>c.value.use_area_calc_mode=g),"hide-details":"",density:"compact",inset:""},null,8,["modelValue"]),o("span",{class:"text-subtitle-2",style:da({color:c.value.use_area_calc_mode?"#1976d2":"#666"})},"Расчёт по площади",4)]),u[34]||(u[34]=o("div",{class:"text-caption text-grey mt-2"}," Влияет на таблицу материалов и итоговую стоимость ",-1))])]),_:1})]),_:1})])):h("",!0),de.value===2?(v(),w("div",Vo,[u[37]||(u[37]=o("div",{class:"section-title"},"Материалы по умолчанию",-1)),u[38]||(u[38]=o("div",{class:"section-hint"},"Подставляются при добавлении новых позиций",-1)),l(R,{variant:"outlined",class:"content-card"},{default:s(()=>[l(G,null,{default:s(()=>[l(ae,{dense:""},{default:s(()=>[l(A,{cols:"12",md:"6"},{default:s(()=>[l(he,{modelValue:c.value.default_plate_material_id,"onUpdate:modelValue":u[8]||(u[8]=g=>c.value.default_plate_material_id=g),items:H.materials.filter(g=>g.type==="plate"),"item-title":"name","item-value":"id",label:"Плитный материал",clearable:"",density:"compact"},null,8,["modelValue","items"])]),_:1}),l(A,{cols:"12",md:"6"},{default:s(()=>[l(he,{modelValue:c.value.default_edge_material_id,"onUpdate:modelValue":u[9]||(u[9]=g=>c.value.default_edge_material_id=g),items:H.materials.filter(g=>g.type==="edge"),"item-title":"name","item-value":"id",label:"Кромочный материал",clearable:"",density:"compact"},null,8,["modelValue","items"])]),_:1})]),_:1})]),_:1})]),_:1})])):h("",!0),de.value===3?(v(),w("div",$o,[u[57]||(u[57]=o("div",{class:"section-title"},"Коэффициенты отходов",-1)),u[58]||(u[58]=o("div",{class:"section-hint"},"Специфичные коэффициенты для каждого типа материала",-1)),l(R,{variant:"outlined",class:"content-card"},{default:s(()=>[l(G,null,{default:s(()=>[o("div",Co,[o("div",Fo,[u[43]||(u[43]=o("span",{class:"text-subtitle-2 font-weight-bold",style:{"min-width":"80px"}},"Плитные",-1)),l(D,{modelValue:c.value.waste_plate_coefficient,"onUpdate:modelValue":u[10]||(u[10]=g=>c.value.waste_plate_coefficient=g),modelModifiers:{number:!0},type:"number",step:"0.01",min:"1",density:"compact","hide-details":"",style:{"max-width":"100px","flex-shrink":"0"},placeholder:String(c.value.waste_coefficient||1.2),hint:"1.00 = без изменения","persistent-hint":""},null,8,["modelValue","placeholder"]),o("div",So,[l(et,{modelValue:c.value.apply_waste_to_plate,"onUpdate:modelValue":u[11]||(u[11]=g=>c.value.apply_waste_to_plate=g),"hide-details":"",density:"compact",inset:""},null,8,["modelValue"]),u[39]||(u[39]=o("span",{class:"text-caption",style:{"min-width":"max-content"}},"Применять",-1))]),o("div",jo,[l(et,{modelValue:c.value.show_waste_plate_description,"onUpdate:modelValue":u[12]||(u[12]=g=>c.value.show_waste_plate_description=g),disabled:!c.value.waste_plate_description||!c.value.waste_plate_description.title&&!c.value.waste_plate_description.text,"hide-details":"",density:"compact",inset:""},null,8,["modelValue","disabled"]),u[40]||(u[40]=o("span",{class:"text-caption",style:{"min-width":"max-content"}},"В отчёте",-1))]),u[44]||(u[44]=o("div",{style:{"flex-grow":"1"}},null,-1)),l(b,{size:"small",variant:"outlined",onClick:u[13]||(u[13]=g=>Xe("plate")),title:"Редактировать описание",style:{"flex-shrink":"0"}},{default:s(()=>[l(S,{size:"small",class:"mr-1"},{default:s(()=>[...u[41]||(u[41]=[r("mdi-pencil",-1)])]),_:1}),u[42]||(u[42]=r(" Описание ",-1))]),_:1})]),o("div",Uo,[u[49]||(u[49]=o("span",{class:"text-subtitle-2 font-weight-bold",style:{"min-width":"80px"}},"Кромка",-1)),l(D,{modelValue:c.value.waste_edge_coefficient,"onUpdate:modelValue":u[14]||(u[14]=g=>c.value.waste_edge_coefficient=g),modelModifiers:{number:!0},type:"number",step:"0.01",min:"1",density:"compact","hide-details":"",style:{"max-width":"100px","flex-shrink":"0"},placeholder:String(c.value.waste_coefficient||1.1),hint:"1.00 = без изменения","persistent-hint":""},null,8,["modelValue","placeholder"]),o("div",Do,[l(et,{modelValue:c.value.apply_waste_to_edge,"onUpdate:modelValue":u[15]||(u[15]=g=>c.value.apply_waste_to_edge=g),"hide-details":"",density:"compact",inset:""},null,8,["modelValue"]),u[45]||(u[45]=o("span",{class:"text-caption",style:{"min-width":"max-content"}},"Применять",-1))]),o("div",Ao,[l(et,{modelValue:c.value.show_waste_edge_description,"onUpdate:modelValue":u[16]||(u[16]=g=>c.value.show_waste_edge_description=g),disabled:!c.value.waste_edge_description||!c.value.waste_edge_description.title&&!c.value.waste_edge_description.text,"hide-details":"",density:"compact",inset:""},null,8,["modelValue","disabled"]),u[46]||(u[46]=o("span",{class:"text-caption",style:{"min-width":"max-content"}},"В отчёте",-1))]),u[50]||(u[50]=o("div",{style:{"flex-grow":"1"}},null,-1)),l(b,{size:"small",variant:"outlined",onClick:u[17]||(u[17]=g=>Xe("edge")),title:"Редактировать описание",style:{"flex-shrink":"0"}},{default:s(()=>[l(S,{size:"small",class:"mr-1"},{default:s(()=>[...u[47]||(u[47]=[r("mdi-pencil",-1)])]),_:1}),u[48]||(u[48]=r(" Описание ",-1))]),_:1})]),o("div",zo,[u[55]||(u[55]=o("span",{class:"text-subtitle-2 font-weight-bold",style:{"min-width":"80px"}},"Операции",-1)),l(D,{modelValue:c.value.waste_operations_coefficient,"onUpdate:modelValue":u[18]||(u[18]=g=>c.value.waste_operations_coefficient=g),modelModifiers:{number:!0},type:"number",step:"0.01",min:"1",density:"compact","hide-details":"",style:{"max-width":"100px","flex-shrink":"0"},placeholder:String(c.value.waste_coefficient||1),hint:"1.00 = без изменения","persistent-hint":""},null,8,["modelValue","placeholder"]),o("div",Po,[l(et,{modelValue:c.value.apply_waste_to_operations,"onUpdate:modelValue":u[19]||(u[19]=g=>c.value.apply_waste_to_operations=g),"hide-details":"",density:"compact",inset:""},null,8,["modelValue"]),u[51]||(u[51]=o("span",{class:"text-caption",style:{"min-width":"max-content"}},"Применять",-1))]),o("div",No,[l(et,{modelValue:c.value.show_waste_operations_description,"onUpdate:modelValue":u[20]||(u[20]=g=>c.value.show_waste_operations_description=g),disabled:!c.value.waste_operations_description||!c.value.waste_operations_description.title&&!c.value.waste_operations_description.text,"hide-details":"",density:"compact",inset:""},null,8,["modelValue","disabled"]),u[52]||(u[52]=o("span",{class:"text-caption",style:{"min-width":"max-content"}},"В отчёте",-1))]),u[56]||(u[56]=o("div",{style:{"flex-grow":"1"}},null,-1)),l(b,{size:"small",variant:"outlined",onClick:u[21]||(u[21]=g=>Xe("operations")),title:"Редактировать описание",style:{"flex-shrink":"0"}},{default:s(()=>[l(S,{size:"small",class:"mr-1"},{default:s(()=>[...u[53]||(u[53]=[r("mdi-pencil",-1)])]),_:1}),u[54]||(u[54]=r(" Описание ",-1))]),_:1})])])]),_:1})]),_:1})])):h("",!0),de.value===4?(v(),w("div",qo,[u[64]||(u[64]=o("div",{class:"section-title"},"Справочные блоки сметы",-1)),u[65]||(u[65]=o("div",{class:"section-hint"},"Дополнительные текстовые блоки в конце PDF-отчёта",-1)),o("div",Mo,[!c.value.text_blocks||c.value.text_blocks.length<10?(v(),$(b,{key:0,"prepend-icon":"mdi-plus",color:"secondary",variant:"outlined",size:"small",onClick:I},{default:s(()=>[r(" Добавить блок ("+d(c.value.text_blocks?c.value.text_blocks.length:0)+"/10) ",1)]),_:1})):(v(),w("div",Lo,[l(S,{size:"small"},{default:s(()=>[...u[59]||(u[59]=[r("mdi-alert-circle-outline",-1)])]),_:1}),u[60]||(u[60]=o("span",null,"Достигнут максимум (10 блоков)",-1))]))]),c.value.text_blocks&&c.value.text_blocks.length>0?(v(),w("div",Eo,[(v(!0),w(ie,null,be(c.value.text_blocks,(g,T)=>(v(),w("div",{key:T,class:"mb-3"},[l(R,{variant:"outlined"},{default:s(()=>[l(G,null,{default:s(()=>[o("div",Io,[o("div",To,[o("span",Oo,"Блок "+d(T+1),1),l(te,{size:"small",variant:g.enabled!==!1?"tonal":"outlined",color:g.enabled!==!1?"success":"default"},{default:s(()=>[r(d(g.enabled!==!1?"Включен":"Отключен"),1)]),_:2},1032,["variant","color"]),l(et,{modelValue:g.enabled,"onUpdate:modelValue":W=>g.enabled=W,"hide-details":"",density:"compact",inset:"",title:"Включить/выключить блок в отчёте"},null,8,["modelValue","onUpdate:modelValue"])]),o("div",Ro,[T>0?(v(),$(b,{key:0,icon:"",size:"x-small",color:"info",variant:"text",onClick:W=>ke(T),title:"Переместить вверх"},{default:s(()=>[l(S,{size:"small"},{default:s(()=>[...u[61]||(u[61]=[r("mdi-arrow-up",-1)])]),_:1})]),_:1},8,["onClick"])):h("",!0),T<(c.value.text_blocks?.length||0)-1?(v(),$(b,{key:1,icon:"",size:"x-small",color:"info",variant:"text",onClick:W=>Se(T),title:"Переместить вниз"},{default:s(()=>[l(S,{size:"small"},{default:s(()=>[...u[62]||(u[62]=[r("mdi-arrow-down",-1)])]),_:1})]),_:1},8,["onClick"])):h("",!0),l(b,{icon:"",size:"x-small",color:"error",variant:"text",onClick:W=>re(T),title:"Удалить блок"},{default:s(()=>[l(S,{size:"small"},{default:s(()=>[...u[63]||(u[63]=[r("mdi-delete",-1)])]),_:1})]),_:1},8,["onClick"])])]),l(D,{modelValue:g.title,"onUpdate:modelValue":W=>g.title=W,label:"Заголовок блока",variant:"outlined",density:"compact",placeholder:"Например: Общие примечания, Гарантия",counter:"100",maxlength:"100",class:"mb-2",onInput:W=>g.title=g.title||"",disabled:g.enabled===!1},null,8,["modelValue","onUpdate:modelValue","onInput","disabled"]),l(at,{modelValue:g.text,"onUpdate:modelValue":W=>g.text=W,label:"Текст блока",variant:"outlined",rows:"3",placeholder:"Введите текст (максимум 3000 символов)",counter:"3000",maxlength:"3000",onInput:W=>g.text=Ne(g.text),onPaste:W=>Ie(g,W),disabled:g.enabled===!1,density:"compact"},null,8,["modelValue","onUpdate:modelValue","onInput","onPaste","disabled"])]),_:2},1024)]),_:2},1024)]))),128))])):h("",!0)])):h("",!0)])]),_:1})])])]),_:1})]),_:1},8,["model-value"]),l(Pe,{modelValue:B.value,"onUpdate:modelValue":u[24]||(u[24]=g=>B.value=g),"max-width":"600"},{default:s(()=>[l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[r("Редактировать описание для "+d(je()),1)]),_:1}),l(G,null,{default:s(()=>[l(D,{modelValue:ce.value.title,"onUpdate:modelValue":u[22]||(u[22]=g=>ce.value.title=g),label:"Заголовок",variant:"outlined",placeholder:"Например: Причина использования коэффициента",counter:"200",maxlength:"200",class:"mb-3"},null,8,["modelValue"]),l(at,{modelValue:ce.value.text,"onUpdate:modelValue":u[23]||(u[23]=g=>ce.value.text=g),label:"Описание",variant:"outlined",rows:"6",placeholder:"Описание коэффициента для отчёта",counter:"2000",maxlength:"2000",onPaste:J},null,8,["modelValue"])]),_:1}),l(De,null,{default:s(()=>[l(Q),l(b,{variant:"text",onClick:Qe},{default:s(()=>[...u[66]||(u[66]=[r(" Отменить ",-1)])]),_:1}),l(b,{color:"primary",variant:"flat",onClick:jt},{default:s(()=>[...u[67]||(u[67]=[r(" Сохранить ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}}),Bo=dl(Wo,[["__scopeId","data-v-ca954728"]]);class Ho{async upload(z,_,i){const M=new FormData;M.append("file",_),i?.sheet_index!==void 0&&M.append("sheet_index",String(i.sheet_index)),i?.header_row_index!==void 0&&M.append("header_row_index",String(i.header_row_index)),i?.csv_encoding&&M.append("csv_encoding",i.csv_encoding),i?.csv_delimiter&&M.append("csv_delimiter",i.csv_delimiter);const{data:c}=await x.post(`/api/projects/${z}/imports`,M,{headers:{"Content-Type":"multipart/form-data"}});return c}async getPreview(z,_){const i=new URLSearchParams;_?.sheet_index!==void 0&&i.append("sheet_index",String(_.sheet_index)),_?.header_row_index!==void 0&&i.append("header_row_index",String(_.header_row_index)),_?.csv_encoding&&i.append("csv_encoding",_.csv_encoding),_?.csv_delimiter&&i.append("csv_delimiter",_.csv_delimiter);const{data:M}=await x.get(`/api/imports/${z}/preview?${i.toString()}`);return M}async saveMapping(z,_){const{data:i}=await x.post(`/api/imports/${z}/mapping`,_);return i}async getImportPreview(z){const{data:_}=await x.get(`/api/imports/${z}/import-preview`);return _}async run(z,_,i="append"){const{data:M}=await x.post(`/api/projects/${z}/imports/${_}/run`,{mode:i});return M}async getSession(z){const{data:_}=await x.get(`/api/imports/${z}`);return _}async deleteSession(z){await x.delete(`/api/imports/${z}`)}}const Ct=new Ho,Jo={key:0,class:"mt-4 text-h6"},Ko={key:1,class:"mt-4 text-h6 text-success"},Xo={key:0,class:"mt-6"},Qo={class:"text-subtitle-1 mb-2"},Go={class:"preview-table-container"},Yo={class:"mapping-row"},Zo={class:"mapping-header-row"},ei={class:"text-center text-grey"},ti={class:"d-flex align-center"},li={class:"d-flex align-center"},ai={class:"d-flex align-center"},si={class:"import-preview-table-container"},oi={key:0,class:"text-center py-4"},ii={key:1},ni={class:"d-flex align-center justify-space-between"},ri={key:0},ui={key:1},di={key:0},ci={class:"d-flex align-center text-body-2 py-1"},pi={key:0,class:"text-caption text-grey mt-1"},mi=ul({__name:"ImportPositionsDialog",props:{modelValue:{type:Boolean},projectId:{}},emits:["update:modelValue","imported"],setup(H,{emit:z}){const _=H,i=z,M=X({get:()=>_.modelValue,set:F=>i("update:modelValue",F)}),c=f(1),de=[{title:"Файл",value:1},{title:"Превью и маппинг",value:2},{title:"Подтверждение",value:3}],U=f(null),_e=f(!1),$e=f(!1),pe=f(""),ne=f(null),q=f(null),B=f({encoding:"UTF-8",delimiter:","}),ve=[{title:"UTF-8",value:"UTF-8"},{title:"Windows-1251",value:"windows-1251"},{title:"ISO-8859-1",value:"ISO-8859-1"}],ce=[{title:"Запятая (,)",value:","},{title:"Точка с запятой (;)",value:";"},{title:"Табуляция",value:"	"}],st=X(()=>U.value?.name.toLowerCase().endsWith(".csv")),me=f(null),Ce=f(0),Fe=f(0),Be=f("mm"),I=f([]),re=f(!1),ke=f(""),Se=f(!0),je=f(1),Xe=[{title:"Миллиметры (мм)",value:"mm"},{title:"Сантиметры (см)",value:"cm"},{title:"Метры (м)",value:"m"}],jt=X(()=>(me.value?.meta?.sheets||[]).map(F=>({title:F.name,value:F.index}))),Qe=X(()=>(me.value?.meta?.sheets?.length??0)>1),Ne=X(()=>{const F=I.value.includes("width"),m=I.value.includes("length");return F&&m}),He=f(null),Ue=f(!1),Ie=f(""),J=f(null),y=f(!1);let u=null;function g(F){_e.value=!1;const m=F.dataTransfer?.files;m&&m.length>0&&m[0]&&Te(m[0])}function T(F){const m=F.target;m.files&&m.files.length>0&&m.files[0]&&Te(m.files[0])}function W(){q.value?.click()}function Te(F){const m=[".xlsx",".xls",".csv"],V=F.name.toLowerCase();if(!m.some(Y=>V.endsWith(Y))){pe.value="Неподдерживаемый формат файла. Выберите XLSX, XLS или CSV.";return}if(F.size>10*1024*1024){pe.value="Файл слишком большой. Максимальный размер: 10 МБ.";return}U.value=F,pe.value=""}async function ot(){if(U.value){$e.value=!0,pe.value="";try{const F={header_row_index:Fe.value-1};st.value&&(F.csv_encoding=B.value.encoding,F.csv_delimiter=B.value.delimiter);const m=await Ct.upload(_.projectId,U.value,F);ne.value=m.import_session_id,me.value=m,Fe.value=m.preview.header_row_index+1,Ce.value=m.preview.sheet_index,it(m.preview.columns.length),c.value=2}catch(F){pe.value=F.response?.data?.message||F.message||"Ошибка загрузки файла"}finally{$e.value=!1}}}function it(F){I.value=new Array(F).fill(null),(me.value?.preview?.columns||[]).forEach((V,K)=>{const Y=V.name_guess.toLowerCase();Y.includes("ширина")||Y.includes("width")||Y==="w"?I.value.includes("width")||(I.value[K]="width"):Y.includes("длина")||Y.includes("длинна")||Y.includes("length")||Y==="l"||Y==="h"?I.value.includes("length")||(I.value[K]="length"):Y.includes("кол")||Y.includes("qty")||Y.includes("quantity")||Y.includes("шт")?I.value.includes("qty")||(I.value[K]="qty"):(Y.includes("назв")||Y.includes("деталь")||Y.includes("name"))&&(I.value.includes("name")||(I.value[K]="name"))})}function Lt(F){const m=I.value[F];return[{title:"—",value:null},{title:"Ширина",value:"width",disabled:I.value.includes("width")&&m!=="width"},{title:"Длина",value:"length",disabled:I.value.includes("length")&&m!=="length"},{title:"Кол-во",value:"qty",disabled:I.value.includes("qty")&&m!=="qty"},{title:"Название",value:"name",disabled:I.value.includes("name")&&m!=="name"},{title:"Игнор.",value:"ignore"}]}function Ge(F){switch(F){case"width":case"length":return"primary-lighten-4";case"qty":return"secondary-lighten-4";case"name":return"info-lighten-4";case"ignore":return"grey-lighten-3";default:return""}}function k(F){switch(I.value[F]){case"width":case"length":return"bg-primary-lighten-5";case"qty":return"bg-secondary-lighten-5";case"name":return"bg-info-lighten-5";case"ignore":return"text-grey";default:return""}}function cl(F){return F==null?"":String(F)}async function pt(){if(ne.value)try{const F=await Ct.getPreview(ne.value,{sheet_index:Ce.value,header_row_index:Fe.value-1});me.value=F,F.preview.columns.length!==I.value.length&&it(F.preview.columns.length)}catch(F){ke.value=F.response?.data?.message||"Ошибка загрузки превью"}}function pl(){u&&clearTimeout(u),u=setTimeout(()=>{pt()},500)}async function mt(){if(!(!ne.value||!Ne.value)){re.value=!0,ke.value="";try{const F=I.value.map((V,K)=>({column_index:K,field:V})).filter(V=>V.field!==null);await Ct.saveMapping(ne.value,{sheet_index:Ce.value,header_row_index:Fe.value-1,options:{units_length:Be.value,default_qty_if_empty:Se.value?je.value:void 0,skip_empty_rows:!0},mapping:F});const m=await Ct.getImportPreview(ne.value);He.value=m,c.value=3}catch(F){const m=F.response?.data;if(m?.errors){const V=Object.values(m.errors).flat();ke.value=V.join("; ")}else ke.value=m?.message||"Ошибка сохранения маппинга"}finally{re.value=!1}}}function O(F){const m=I.value.indexOf(F);return m===-1?"":(me.value?.preview?.columns||[])[m]?.name_guess||`#${m+1}`}async function ml(){if(ne.value){Ue.value=!0,Ie.value="",J.value=null;try{const F=await Ct.run(_.projectId,ne.value,"append");J.value=F.result,J.value&&!y.value&&(i("imported",J.value),y.value=!0)}catch(F){Ie.value=F.response?.data?.message||"Ошибка импорта"}finally{Ue.value=!1}}}function vl(){J.value&&!y.value&&(i("imported",J.value),y.value=!0),nt()}function nt(){ne.value&&!J.value&&Ct.deleteSession(ne.value).catch(()=>{}),Et(),M.value=!1}function Et(){c.value=1,U.value=null,_e.value=!1,$e.value=!1,pe.value="",ne.value=null,me.value=null,Ce.value=0,Fe.value=0,Be.value="mm",I.value=[],re.value=!1,ke.value="",Se.value=!0,je.value=1,He.value=null,Ue.value=!1,Ie.value="",J.value=null,y.value=!1,B.value={encoding:"UTF-8",delimiter:","}}return Re(M,F=>{F||Et()}),(F,m)=>(v(),$(Pe,{modelValue:M.value,"onUpdate:modelValue":m[15]||(m[15]=V=>M.value=V),"max-width":"1000",persistent:"",scrollable:""},{default:s(()=>[l(R,{class:"import-dialog-card"},{default:s(()=>[l(ee,{class:"d-flex align-center"},{default:s(()=>[l(S,{class:"mr-2"},{default:s(()=>[...m[16]||(m[16]=[r("mdi-file-import",-1)])]),_:1}),m[18]||(m[18]=r(" Импорт позиций из Excel/CSV ",-1)),l(Q),l(b,{icon:"",variant:"text",onClick:nt},{default:s(()=>[l(S,null,{default:s(()=>[...m[17]||(m[17]=[r("mdi-close",-1)])]),_:1})]),_:1})]),_:1}),l(ye),l(Zs,{modelValue:c.value,"onUpdate:modelValue":m[14]||(m[14]=V=>c.value=V),items:de,"alt-labels":"","hide-actions":"",class:"import-stepper"},{"item.1":s(()=>[l(R,{flat:"",class:"import-step-card"},{default:s(()=>[l(G,{class:"pa-6 import-step-content"},{default:s(()=>[o("div",{class:ct(["upload-zone pa-8 text-center",{"drag-over":_e.value,"has-file":U.value}]),onDragover:m[0]||(m[0]=we(V=>_e.value=!0,["prevent"])),onDragleave:m[1]||(m[1]=we(V=>_e.value=!1,["prevent"])),onDrop:we(g,["prevent"]),onClick:W},[o("input",{ref_key:"fileInputRef",ref:q,type:"file",accept:".xlsx,.xls,.csv",style:{display:"none"},onChange:T},null,544),l(S,{size:"64",color:U.value?"success":"grey"},{default:s(()=>[r(d(U.value?"mdi-file-check":"mdi-cloud-upload"),1)]),_:1},8,["color"]),U.value?(v(),w("div",Ko,d(U.value.name),1)):(v(),w("div",Jo," Перетащите файл сюда или нажмите для выбора ")),m[19]||(m[19]=o("div",{class:"mt-2 text-body-2 text-grey"}," Поддерживаемые форматы: XLSX, XLS, CSV (до 10 МБ) ",-1))],34),l(Mt,null,{default:s(()=>[U.value&&st.value?(v(),w("div",Xo,[l(ye,{class:"mb-4"}),m[20]||(m[20]=o("div",{class:"text-subtitle-1 mb-3"},"Настройки CSV",-1)),l(ae,null,{default:s(()=>[l(A,{cols:"6"},{default:s(()=>[l(Ve,{modelValue:B.value.encoding,"onUpdate:modelValue":m[2]||(m[2]=V=>B.value.encoding=V),items:ve,label:"Кодировка",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1}),l(A,{cols:"6"},{default:s(()=>[l(Ve,{modelValue:B.value.delimiter,"onUpdate:modelValue":m[3]||(m[3]=V=>B.value.delimiter=V),items:ce,label:"Разделитель",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1})])):h("",!0)]),_:1}),pe.value?(v(),$(We,{key:0,type:"error",class:"mt-4",closable:"","onClick:close":m[4]||(m[4]=V=>pe.value="")},{default:s(()=>[r(d(pe.value),1)]),_:1})):h("",!0)]),_:1}),l(De,{class:"pa-4 import-step-actions"},{default:s(()=>[l(Q),l(b,{variant:"text",onClick:nt},{default:s(()=>[...m[21]||(m[21]=[r("Отмена",-1)])]),_:1}),l(b,{color:"primary",disabled:!U.value,loading:$e.value,onClick:ot},{default:s(()=>[m[23]||(m[23]=r(" Загрузить ",-1)),l(S,{end:""},{default:s(()=>[...m[22]||(m[22]=[r("mdi-arrow-right",-1)])]),_:1})]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),"item.2":s(()=>[l(R,{flat:"",class:"import-step-card"},{default:s(()=>[l(G,{class:"pa-6 import-step-content"},{default:s(()=>[l(ae,{class:"mb-4"},{default:s(()=>[Qe.value?(v(),$(A,{key:0,cols:"4"},{default:s(()=>[l(Ve,{modelValue:Ce.value,"onUpdate:modelValue":[m[5]||(m[5]=V=>Ce.value=V),pt],items:jt.value,label:"Лист",variant:"outlined",density:"compact"},null,8,["modelValue","items"])]),_:1})):h("",!0),l(A,{cols:Qe.value?4:6},{default:s(()=>[l(D,{modelValue:Fe.value,"onUpdate:modelValue":[m[6]||(m[6]=V=>Fe.value=V),pl],modelModifiers:{number:!0},label:"Строка заголовка (0 = нет)",type:"number",min:"0",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1},8,["cols"]),l(A,{cols:Qe.value?4:6},{default:s(()=>[l(Ve,{modelValue:Be.value,"onUpdate:modelValue":m[7]||(m[7]=V=>Be.value=V),items:Xe,label:"Единицы длины",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1},8,["cols"])]),_:1}),o("div",Qo,[m[24]||(m[24]=r(" Сопоставление колонок ",-1)),l(te,{size:"small",color:Ne.value?"success":"warning",class:"ml-2"},{default:s(()=>[r(d(Ne.value?"Готово":"Выберите ширину и длину"),1)]),_:1},8,["color"])]),o("div",Go,[l(St,{density:"compact","fixed-header":"",class:"preview-table"},{default:s(()=>[o("thead",null,[o("tr",Yo,[m[25]||(m[25]=o("th",{class:"text-center",style:{width:"50px"}},"#",-1)),(v(!0),w(ie,null,be(me.value?.preview?.columns||[],(V,K)=>(v(),w("th",{key:"map-"+K,class:"pa-1",style:{"min-width":"120px"}},[l(Ve,{modelValue:I.value[K],"onUpdate:modelValue":Y=>I.value[K]=Y,items:Lt(K),variant:"outlined",density:"compact","hide-details":"",placeholder:"—",clearable:"","bg-color":Ge(I.value[K]??null)},null,8,["modelValue","onUpdate:modelValue","items","bg-color"])]))),128))]),o("tr",Zo,[m[26]||(m[26]=o("th",{class:"text-center text-grey"},"Строка",-1)),(v(!0),w(ie,null,be(me.value?.preview?.columns||[],(V,K)=>(v(),w("th",{key:"head-"+K,class:"text-caption text-grey-darken-1"},d(V.name_guess||`Колонка ${K+1}`),1))),128))])]),o("tbody",null,[(v(!0),w(ie,null,be(me.value?.preview?.rows||[],(V,K)=>(v(),w("tr",{key:K},[o("td",ei,d(V.original_index+1),1),(v(!0),w(ie,null,be(V.cells,(Y,vt)=>(v(),w("td",{key:vt,class:ct(k(vt))},d(cl(Y)),3))),128))]))),128))])]),_:1})]),l(ae,{class:"mt-4"},{default:s(()=>[l(A,{cols:"6"},{default:s(()=>[l(to,{modelValue:Se.value,"onUpdate:modelValue":m[8]||(m[8]=V=>Se.value=V),label:"Qty по умолчанию, если пусто",density:"compact","hide-details":""},null,8,["modelValue"])]),_:1}),Se.value?(v(),$(A,{key:0,cols:"6"},{default:s(()=>[l(D,{modelValue:je.value,"onUpdate:modelValue":m[9]||(m[9]=V=>je.value=V),modelModifiers:{number:!0},label:"Значение по умолчанию",type:"number",min:"1",variant:"outlined",density:"compact","hide-details":""},null,8,["modelValue"])]),_:1})):h("",!0)]),_:1}),ke.value?(v(),$(We,{key:0,type:"error",class:"mt-4",closable:"","onClick:close":m[10]||(m[10]=V=>ke.value="")},{default:s(()=>[r(d(ke.value),1)]),_:1})):h("",!0)]),_:1}),l(De,{class:"pa-4 import-step-actions"},{default:s(()=>[l(b,{variant:"text",onClick:m[11]||(m[11]=V=>c.value=1)},{default:s(()=>[l(S,{start:""},{default:s(()=>[...m[27]||(m[27]=[r("mdi-arrow-left",-1)])]),_:1}),m[28]||(m[28]=r(" Назад ",-1))]),_:1}),l(Q),l(b,{variant:"text",onClick:nt},{default:s(()=>[...m[29]||(m[29]=[r("Отмена",-1)])]),_:1}),l(b,{color:"primary",disabled:!Ne.value,loading:re.value,onClick:mt},{default:s(()=>[m[31]||(m[31]=r(" Далее ",-1)),l(S,{end:""},{default:s(()=>[...m[30]||(m[30]=[r("mdi-arrow-right",-1)])]),_:1})]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),"item.3":s(()=>[l(R,{flat:"",class:"import-step-card"},{default:s(()=>[l(G,{class:"pa-6 import-step-content"},{default:s(()=>[m[50]||(m[50]=o("div",{class:"text-h6 mb-4"},"Подтверждение импорта",-1)),l(R,{variant:"outlined",class:"mb-4"},{default:s(()=>[l(ee,{class:"text-subtitle-1"},{default:s(()=>[...m[32]||(m[32]=[r("Сопоставление колонок",-1)])]),_:1}),l(G,null,{default:s(()=>[l(ae,null,{default:s(()=>[l(A,{cols:"4"},{default:s(()=>[o("div",ti,[l(te,{color:"primary",size:"small",class:"mr-2"},{default:s(()=>[...m[33]||(m[33]=[r("Ширина",-1)])]),_:1}),o("span",null,"→ Колонка "+d(O("width")),1)])]),_:1}),l(A,{cols:"4"},{default:s(()=>[o("div",li,[l(te,{color:"primary",size:"small",class:"mr-2"},{default:s(()=>[...m[34]||(m[34]=[r("Длина",-1)])]),_:1}),o("span",null,"→ Колонка "+d(O("length")),1)])]),_:1}),l(A,{cols:"4"},{default:s(()=>[o("div",ai,[l(te,{color:"secondary",size:"small",class:"mr-2"},{default:s(()=>[...m[35]||(m[35]=[r("Кол-во",-1)])]),_:1}),o("span",null,"→ "+d(O("qty")||"Не выбрано"),1)])]),_:1})]),_:1})]),_:1})]),_:1}),l(R,{variant:"outlined",class:"mb-4"},{default:s(()=>[l(ee,{class:"text-subtitle-1"},{default:s(()=>[...m[36]||(m[36]=[r("Параметры импорта",-1)])]),_:1}),l(G,null,{default:s(()=>[l(ae,null,{default:s(()=>[l(A,{cols:"4"},{default:s(()=>[l(S,{size:"small",class:"mr-1"},{default:s(()=>[...m[37]||(m[37]=[r("mdi-ruler",-1)])]),_:1}),m[38]||(m[38]=r(" Единицы: ",-1)),o("strong",null,d(Be.value),1)]),_:1}),l(A,{cols:"4"},{default:s(()=>[l(S,{size:"small",class:"mr-1"},{default:s(()=>[...m[39]||(m[39]=[r("mdi-table-row",-1)])]),_:1}),m[40]||(m[40]=r(" Строка заголовка: ",-1)),o("strong",null,d(Fe.value===0?"—":Fe.value),1)]),_:1}),l(A,{cols:"4"},{default:s(()=>[l(S,{size:"small",class:"mr-1"},{default:s(()=>[...m[41]||(m[41]=[r("mdi-numeric",-1)])]),_:1}),m[42]||(m[42]=r(" Qty по умолч.: ",-1)),o("strong",null,d(Se.value?je.value:"—"),1)]),_:1})]),_:1})]),_:1})]),_:1}),He.value?(v(),$(R,{key:0,variant:"outlined",class:"mb-4"},{default:s(()=>[l(ee,{class:"text-subtitle-1"},{default:s(()=>[...m[43]||(m[43]=[r(" Предпросмотр (первые 10 строк) ",-1)])]),_:1}),l(G,null,{default:s(()=>[o("div",si,[l(St,{density:"compact","fixed-header":""},{default:s(()=>[m[44]||(m[44]=o("thead",null,[o("tr",null,[o("th",null,"Строка"),o("th",null,"Ширина (мм)"),o("th",null,"Длина (мм)"),o("th",null,"Кол-во"),o("th",null,"Статус")])],-1)),o("tbody",null,[(v(!0),w(ie,null,be(He.value.preview.items,V=>(v(),w("tr",{key:V.row},[o("td",null,d(V.row),1),o("td",null,d(V.parsed.width_mm??"—"),1),o("td",null,d(V.parsed.length_mm??"—"),1),o("td",null,d(V.parsed.qty??"—"),1),o("td",null,[l(te,{color:V.status==="ok"?"success":"error",size:"x-small"},{default:s(()=>[r(d(V.status==="ok"?"OK":V.error),1)]),_:2},1032,["color"])])]))),128))])]),_:1})])]),_:1})]),_:1})):h("",!0),l(Mt,null,{default:s(()=>[Ue.value||J.value?(v(),$(R,{key:0,variant:"outlined",class:"mb-4"},{default:s(()=>[l(G,null,{default:s(()=>[Ue.value?(v(),w("div",oi,[l(Nl,{indeterminate:"",color:"primary",size:"48"}),m[45]||(m[45]=o("div",{class:"mt-4"},"Импорт выполняется...",-1))])):J.value?(v(),w("div",ii,[l(We,{type:J.value.errors_count>0?"warning":"success",variant:"tonal",class:"mb-4"},{default:s(()=>[o("div",ni,[o("span",null,[m[46]||(m[46]=r(" Создано позиций: ",-1)),o("strong",null,d(J.value.created_count),1)]),J.value.skipped_count>0?(v(),w("span",ri,[m[47]||(m[47]=r(" Пропущено: ",-1)),o("strong",null,d(J.value.skipped_count),1)])):h("",!0),J.value.errors_count>0?(v(),w("span",ui,[m[48]||(m[48]=r(" Ошибок: ",-1)),o("strong",null,d(J.value.errors_count),1)])):h("",!0)])]),_:1},8,["type"]),J.value.errors?.length>0?(v(),w("div",di,[m[49]||(m[49]=o("div",{class:"text-subtitle-2 mb-2"},"Ошибки импорта:",-1)),l(eo,{items:J.value.errors.slice(0,20),height:"150","item-height":"32"},{default:s(({item:V})=>[o("div",ci,[l(te,{size:"x-small",color:"error",class:"mr-2"},{default:s(()=>[r(" Строка "+d(V.row),1)]),_:2},1024),r(" "+d(V.reason),1)])]),_:1},8,["items"]),J.value.errors.length>20?(v(),w("div",pi," ... и ещё "+d(J.value.errors.length-20)+" ошибок ",1)):h("",!0)])):h("",!0)])):h("",!0)]),_:1})]),_:1})):h("",!0)]),_:1}),Ie.value?(v(),$(We,{key:1,type:"error",class:"mt-4",closable:"","onClick:close":m[12]||(m[12]=V=>Ie.value="")},{default:s(()=>[r(d(Ie.value),1)]),_:1})):h("",!0)]),_:1}),l(De,{class:"pa-4 import-step-actions"},{default:s(()=>[l(b,{variant:"text",onClick:m[13]||(m[13]=V=>c.value=2),disabled:Ue.value},{default:s(()=>[l(S,{start:""},{default:s(()=>[...m[51]||(m[51]=[r("mdi-arrow-left",-1)])]),_:1}),m[52]||(m[52]=r(" Назад ",-1))]),_:1},8,["disabled"]),l(Q),J.value?(v(),$(b,{key:0,color:"primary",onClick:vl},{default:s(()=>[...m[53]||(m[53]=[r(" Закрыть ",-1)])]),_:1})):(v(),w(ie,{key:1},[l(b,{variant:"text",onClick:nt,disabled:Ue.value},{default:s(()=>[...m[54]||(m[54]=[r("Отмена",-1)])]),_:1},8,["disabled"]),l(b,{color:"primary",loading:Ue.value,onClick:ml},{default:s(()=>[l(S,{start:""},{default:s(()=>[...m[55]||(m[55]=[r("mdi-import",-1)])]),_:1}),m[56]||(m[56]=r(" Добавить в отчет ",-1))]),_:1},8,["loading"])],64))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"]))}}),vi=dl(mi,[["__scopeId","data-v-1026fbc4"]]),fi=["onClick","title"],_i={class:"action-label"},gi=ul({__name:"RowHoverActions",props:{rowId:{},quickActions:{},menuActions:{},visible:{type:Boolean},loading:{type:Boolean},loadingKey:{}},emits:["action"],setup(H,{emit:z}){const _=H,i=z,M=c=>{c.disabled||(c.handler?c.handler():i("action",{rowId:_.rowId,actionKey:c.key}))};return(c,de)=>(v(),w("div",{class:ct(["row-hover-actions",{visible:H.visible}])},[(v(!0),w(ie,null,be(H.quickActions,U=>(v(),w("a",{key:U.key,class:ct(["action-link",{disabled:U.disabled,[`color-${U.color}`]:U.color}]),href:"#",onClick:we(_e=>M(U),["prevent","stop"]),title:U.tooltip||U.label},[H.loadingKey===U.key?(v(),$(Nl,{key:0,size:"14",width:"2",indeterminate:"",color:"primary",class:"action-icon"})):(v(),$(S,{key:1,size:"14",class:"action-icon"},{default:s(()=>[r(d(U.icon),1)]),_:2},1024)),o("span",_i,d(U.label),1)],10,fi))),128)),H.menuActions&&H.menuActions.length>0?(v(),$(lo,{key:0,location:"bottom end","close-on-content-click":!0},{activator:s(({props:U})=>[o("a",ql({class:"action-link menu-link",href:"#"},U,{onClick:de[0]||(de[0]=we(()=>{},["prevent","stop"])),title:"Дополнительно"}),[l(S,{size:"14"},{default:s(()=>[...de[1]||(de[1]=[r("mdi-dots-horizontal",-1)])]),_:1})],16)]),default:s(()=>[l(wa,{density:"compact",class:"actions-menu"},{default:s(()=>[(v(!0),w(ie,null,be(H.menuActions,U=>(v(),$(Ft,{key:U.key,disabled:U.disabled,onClick:_e=>M(U)},{prepend:s(()=>[l(S,{size:"16",color:U.color||"default"},{default:s(()=>[r(d(U.icon),1)]),_:2},1032,["color"])]),default:s(()=>[l(Ml,null,{default:s(()=>[r(d(U.label),1)]),_:2},1024)]),_:2},1032,["disabled","onClick"]))),128))]),_:1})]),_:1})):h("",!0),H.loading?(v(),$(Nl,{key:1,size:"14",width:"2",indeterminate:"",color:"primary",class:"loading-indicator"})):h("",!0)],2))}}),ga=dl(gi,[["__scopeId","data-v-ca899772"]]);async function yi(H,z,_){const{data:i}=await x.post("/api/work/decompose",{title:H,context:z,desired_hours:_});return{tier:i.source==="ai"?3:i.source==="preset"?1:2,preset_id:i.preset_id??null,status:i.meta?.is_draft?"draft":i.status??null,steps:i.suggestion?.steps??[],total_hours:i.suggestion?.totals?.hours??0}}async function wi(H){await x.post("/api/work/presets/feedback",H)}function bi(H,z){const _=H.toLowerCase().trim(),i=z.map(M=>`${M.title.toLowerCase().trim()}:${Number(M.hours).toFixed(2)}`).join("|");return`${_}::${i}`}const ki={class:"d-flex align-center gap-2 mt-3 flex-wrap"},xi={class:"d-flex align-center flex-wrap gap-3"},hi={class:"d-flex align-center gap-4 bulk-actions-row"},Vi=["data-row-id","onMouseenter","onClick"],$i={class:"cell-with-actions"},Ci={class:"cell-name-column"},Fi={class:"cell-ellipsis cell-name"},Si={key:0},ji={class:"cell-ellipsis"},Ui={key:1},Di=["title"],Ai={key:2},zi=["title"],Pi={key:3},Ni={key:4},qi={key:5},Mi={key:6},Li={key:7},Ei={key:8},Ii={key:9},Ti={key:10},Oi={class:"d-flex align-center justify-space-between"},Ri={key:1},Wi={key:0},Bi={key:1},Hi={key:0},Ji={key:0},Ki={key:0},Xi={key:1},Qi=["colspan"],Gi={class:"text-body-2"},Yi={class:"mt-2"},Zi={class:"mt-2"},en={class:"mt-2"},tn={class:"mb-3 pb-3 border-b"},ln={class:"mt-2"},an={class:"text-caption text-grey"},sn={class:"text-body-2"},on={key:0,class:"mt-2"},nn={class:"d-flex align-center gap-2"},rn=["colspan"],un={class:"text-body-2"},dn={class:"mt-2"},cn={class:"d-flex align-center ga-1"},pn=["colspan"],mn={class:"text-subtitle-2 mb-3"},vn={class:"text-caption text-grey"},fn={class:"text-body-2"},_n={class:"mt-2"},gn={class:"text-caption"},yn={class:"text-caption mb-3"},wn=["onMouseenter"],bn={class:"cell-name-column"},kn={class:"cell-ellipsis"},xn={class:"d-flex justify-space-between align-center mb-4"},hn={key:0},Vn={key:1},$n={key:0},Cn={key:1},Fn={key:0},Sn={key:1},jn={key:2},Un={class:"d-flex gap-2 align-center"},Dn={key:19,class:"d-flex justify-end mt-2"},An={class:"d-flex flex-wrap gap-3 mb-4"},zn={key:0,class:"text-caption text-grey mb-3"},Pn={key:0},Nn={class:"text-caption mt-1"},qn={key:1},Mn={class:"steps-dialog-header"},Ln={class:"header-info"},En={class:"header-title"},In={class:"header-subtitle"},Tn={class:"header-stats"},On={class:"stat-item"},Rn={class:"stat-value"},Wn={class:"stat-label"},Bn={class:"stat-item primary"},Hn={class:"stat-value"},Jn={class:"steps-dialog-body"},Kn={class:"steps-list-panel"},Xn={class:"list-toolbar"},Qn={class:"list-content"},Gn={key:0,class:"empty-state"},Yn={key:1,class:"empty-state"},Zn={key:2,class:"steps-compact-list"},er=["onDragstart","onDrop","onClick"],tr={class:"step-index"},lr={class:"step-num"},ar={class:"step-content"},sr={class:"step-title"},or={key:0,class:"step-meta"},ir=["title"],nr=["title"],rr={class:"step-hours"},ur={class:"step-actions"},dr={class:"steps-form-panel"},cr={class:"ai-assistant-block"},pr={class:"form-header ai-header"},mr={class:"ai-context-grid"},vr={key:0,class:"ai-optional-fields"},fr={class:"ai-options-row"},_r={key:0,class:"ai-preview-panel"},gr={class:"ai-preview-header"},yr={class:"ai-preview-list"},wr={class:"ai-preview-num"},br={class:"ai-preview-text"},kr={class:"ai-preview-hours"},xr={class:"ai-preview-actions"},hr={class:"form-header"},Vr={class:"form-field"},$r={class:"form-row"},Cr={class:"form-field time-field"},Fr={class:"form-field flex-grow"},Sr={class:"form-field"},jr={class:"form-field"},Ur={key:0,class:"form-toggle"},Dr={class:"form-actions"},Ar={class:"steps-dialog-footer"},zr={class:"footer-summary"},Pr={class:"summary-value"},Nr={key:0,class:"summary-hint"},qr=ul({__name:"ProjectEditorView",setup(H){const _=Ks().params.id,i=f({id:0,number:"",expert_name:"",address:"",region_id:null,waste_coefficient:1,repair_coefficient:1,text_blocks:[],normohour_rate:null,normohour_region:null,normohour_date:null,normohour_method:null,normohour_justification:null}),M=a=>{let e=a.replace(/<[^>]*>/g,"");return e=e.replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),e=e.split(`
`).map(t=>t.replace(/[ \t]+/g," ").trim()).filter(t=>t.length>0).join(`
`),e},c=f([]),de=f([]),U=f([]),_e=f(!1),$e=f(!1),pe=f(!1),ne=f(!1),q=f(null),B=f([]),ve=X(()=>B.value),ce=f(null),st=()=>{pa(()=>{const a=ce.value;if(!a)return;const e=a.querySelector("table thead");e&&(e.style.zIndex="100",e.style.position="sticky",e.style.top="0px"),a.querySelectorAll("table thead th").forEach(n=>{const p=n;p.style.zIndex="100",p.style.position="sticky",p.style.top="0px"})})},me=f(localStorage.getItem("positions_table_density")||"compact");Re(me,a=>{localStorage.setItem("positions_table_density",a)}),ca(()=>{st()});const Ce=f(localStorage.getItem("positions_column_preset")||"basic");Re(Ce,a=>{localStorage.setItem("positions_column_preset",a)});const Fe=[{value:"basic",label:"Базовые",icon:"mdi-view-list"},{value:"materials",label:"Материалы",icon:"mdi-texture-box"},{value:"sizes",label:"Размеры",icon:"mdi-ruler-square"},{value:"edges",label:"Кромка",icon:"mdi-border-all"},{value:"totals",label:"Итоги",icon:"mdi-calculator"}],Be={custom_name:{title:"Название",key:"custom_name",width:200,cellClass:"cell-with-actions"},detail_type:{title:"Тип детали",key:"detail_type",width:130},material_short:{title:"Материал",key:"material_short",width:180},edge_material_short:{title:"Кромка",key:"edge_material_short",width:150},size:{title:"Размеры (Ш×Д)",key:"size",width:120},width:{title:"Ширина",key:"width",width:80},length:{title:"Длина",key:"length",width:80},quantity:{title:"Кол-во",key:"quantity",width:70},edge_scheme:{title:"Схема кромки",key:"edge_scheme",width:130},area_total:{title:"Площадь (м²)",key:"area_total",width:110},unit_price:{title:"Цена за ед.",key:"unit_price",width:100},total_price:{title:"Сумма",key:"total_price",width:100}},I={basic:["custom_name","detail_type","material_short","size","quantity"],materials:["custom_name","material_short","edge_material_short","quantity"],sizes:["custom_name","width","length","quantity","area_total"],edges:["custom_name","material_short","edge_material_short","edge_scheme"],totals:["custom_name","material_short","quantity","area_total","unit_price","total_price"]},re=X(()=>{const a=Ce.value;return(I[a]??I.basic).map(t=>Be[t]).filter(Boolean)});Re([re,c],()=>{st()},{deep:!0});const ke=f(null),Se=f(null),je=f(null),Xe=a=>{const e=B.value.indexOf(a);e===-1?B.value.push(a):B.value.splice(e,1)},jt=(a,e,t)=>{if(!Number.isFinite(t)){Xe(e),je.value=t;return}if(a.shiftKey&&je.value!==null){const n=Math.min(je.value,t),p=Math.max(je.value,t),j=c.value.slice(n,p+1).map(N=>N.id).filter(N=>N!=null),C=new Set(B.value);j.forEach(N=>C.add(N)),B.value=Array.from(C)}else Xe(e);je.value=t},Qe=a=>[{key:"edit",icon:"mdi-pencil",label:"Изменить",disabled:bt.value!==null},{key:"duplicate",icon:"mdi-content-duplicate",label:"Дублировать",disabled:bt.value!==null},{key:"delete",icon:"mdi-delete",label:"Удалить",disabled:bt.value!==null,color:"error"}],Ne=a=>[{key:"view_details",icon:"mdi-information-outline",label:"Детали позиции"},{key:"copy_to_clipboard",icon:"mdi-content-copy",label:"Скопировать данные"}],He=a=>{const e=c.value.find(t=>t.id===a.rowId);if(e)switch(a.actionKey){case"edit":hl(e);break;case"duplicate":Ma(e);break;case"delete":qa(e);break;case"view_details":hl(e);break;case"copy_to_clipboard":Ue(e);break}},Ue=async a=>{const e={name:a.custom_name,material:yt(a.material_id),edge:yt(a.edge_material_id),size:`${a.width}×${a.length}`,quantity:a.quantity};try{await navigator.clipboard.writeText(JSON.stringify(e,null,2)),k("Данные скопированы в буфер","success")}catch{k("Не удалось скопировать данные","error")}},Ie=a=>a?ke.value===a:!1,J=a=>{pa(()=>{const e=ce.value;if(!e)return;const t=e.querySelector(`tr[data-row-id="${a}"]`);t&&typeof t.scrollIntoView=="function"&&t.scrollIntoView({behavior:"smooth",block:"center"})})},y=a=>a?Ut.find(t=>t.value===a)?.label||a:"—";Re(B,a=>{console.log("🔵 selectedPositionsRaw changed:",a,"length:",a.length)},{deep:!0});const u=f(null),g=f(null),T=f(null),W=f(null),Te=f(null),ot=f(!1);f(null),f(!1),f(!1);const it=f(!1),Lt=f(!1),Ge=f({show:!1,message:"",color:"info",timeout:3e3}),k=(a,e="info",t=3e3)=>{Ge.value={show:!0,message:a,color:e,timeout:t}},cl=a=>(parseFloat(a)||0).toFixed(1),pt=(a,e=2)=>(Math.round(a*Math.pow(10,e))/Math.pow(10,e)).toString(),pl=a=>{if(!a||typeof a!="string")return null;const e=a.trim(),t=parseFloat(e);if(!isNaN(t)&&e===t.toString())return t;if(!/^[\d+\-*/.().\s]+$/.test(e))return null;try{const n=Function('"use strict"; return ('+e+")")();return typeof n=="number"&&!isNaN(n)&&isFinite(n)?n:null}catch{return null}},mt=(a,e)=>{const t=String(e).trim();if(!t){L.value[a]=0;return}const n=pl(t);if(n===null){k(`Ошибка в выражении: "${t}". Используйте числа и операции (+, -, *, /)`,"warning");return}if(n<0){k(`Результат выражения "${t}" = ${n}. Установлено значение 0`,"warning"),L.value[a]=0;return}const p=Math.round(n);t!==p.toString()&&console.log(`📐 Выражение "${t}" = ${p}`),L.value[a]=p},O=f({positions:!1,materials:!1,fittings:!1,expenses:!1,normohourSources:!1,laborWorks:!1,operations:!1}),ml=async a=>{try{Object.assign(i.value,a),await Ya()}catch(e){throw console.error("Error saving settings:",e),k("Ошибка сохранения настроек","error"),e}},vl=()=>{$e.value=!1,k("Все изменения в настройках применены","success")},nt=a=>{console.error("Settings error:",a),k(a,"error")},Et=async a=>{k(`Импортировано ${a.created_count} позиций`,"success");try{O.value.positions=!0,c.value=(await x.get(`/api/projects/${_}/positions`)).data}catch(e){console.error("Error reloading positions:",e)}finally{O.value.positions=!1}},F=()=>{console.log("🔓 Opening settings drawer. Text blocks:",i.value.text_blocks),$e.value=!0},m=f([]),V=f([]),K=f([]),Y=f([]),vt=X(()=>V.value.filter(a=>a.type==="plate")),fl=X(()=>V.value.filter(a=>a.type==="edge")),ba=[{title:"Название",key:"name"},{title:"Кол-во",key:"quantity"},{title:"Цена",key:"unit_price"},{title:"Действия",key:"actions",sortable:!1}],Ll=[{title:"",key:"data-table-expand"},{title:"Материал",key:"name"},{title:"Площадь деталей (м²)",key:"area_details"},{title:"Коэфф.",key:"waste_coeff"},{title:"Площадь с отходами (м²)",key:"area_with_waste"},{title:"Размер листа (м²)",key:"sheet_area"},{title:"Листов",key:"sheets_count"},{title:"Цена за лист",key:"price_per_sheet"},{title:"Цена за м² (расч.)",key:"price_per_m2",render:a=>"Цена за м² (расчётная)"},{title:"Сумма",key:"total_price"}],ka=X(()=>i.value?.use_area_calc_mode===!0?Ll.filter(e=>e.key!=="sheet_area"&&e.key!=="price_per_sheet").map(e=>e.key==="sheets_count"?{...e,title:"Площадь к оплате (м²)"}:e):Ll.filter(e=>e.key!=="price_per_m2")),xa=()=>{if(!(i.value?.apply_waste_to_plate!==!1))return console.log("getWasteCoefficientForPlate: DISABLED → returning 1.0"),1;const e=i.value?.waste_plate_coefficient,t=i.value?.waste_coefficient||1,n=e?Number(e):t;return console.log(`getWasteCoefficientForPlate: ENABLED → ${n} (${e?"plate-specific":"general"})`),n},El=()=>{if(!(i.value?.apply_waste_to_edge!==!1))return console.log("getWasteCoefficientForEdge: DISABLED → returning 1.0"),1;const e=i.value?.waste_edge_coefficient,t=i.value?.waste_coefficient||1,n=e?Number(e):t;return console.log(`getWasteCoefficientForEdge: ENABLED → ${n} (${e?"edge-specific":"general"})`),n},ha=[{title:"",key:"data-table-expand"},{title:"Материал кромки",key:"name"},{title:"Длина (м.п.)",key:"length_linear"},{title:"Коэфф.",key:"waste_coeff"},{title:"Длина с отходами (м.п.)",key:"length_with_waste"},{title:"Цена за м.п.",key:"price_per_unit"},{title:"Сумма",key:"total_price"}],Va=[{title:"Название",key:"name"},{title:"Описание",key:"description"},{title:"Сумма",key:"amount"},{title:"Действия",key:"actions",sortable:!1}],$a=[{title:"№",key:"number"},{title:"Статус",key:"status"},{title:"Создана",key:"created_at"},{title:"Fingerprint",key:"snapshot_hash"},{title:"Автор",key:"created_by"},{title:"Действия",key:"actions",sortable:!1}],Ut=[{value:"none",label:"Без обработки",icon:"mdi-minus"},{value:"O",label:"Вкруг (O)",icon:"mdi-circle-outline"},{value:"=",label:"Параллельно длине (=)",icon:"mdi-arrow-left-right"},{value:"||",label:"Параллельно ширине (||)",icon:"mdi-arrow-up-down"},{value:"L",label:"Г-образно (L)",icon:"mdi-vector-square"},{value:"П",label:"П-образно (П)",icon:"mdi-alpha-p-box-outline"}],Dt=f(!1),ft=f(!1),_t=f(!1),gt=f(!1),It=f(!1),rt=f(null),_l=f([]),gl=f(!1),qe=Xs({page:1,perPage:10,total:0,lastPage:1}),Tt=f(!1),ut=f(null),yl=f(""),wl=f(!1),bl=f(!1),Ot=f(!1),Rt=f(!1),kl=f(!1),Wt=f([]),P=f({source:"",position_profile:null,salary_range:null,period:null,link:null,note:null}),Me=f({}),Il=f(),L=f({id:null,project_id:_,detail_type_id:null,material_id:null,edge_material_id:null,edge_scheme:"none",width:0,length:0,quantity:1,custom_name:null}),se=f({id:0,project_id:_,name:"",article:"",unit:"шт",quantity:1,unit_price:0,note:""}),Ae=f({id:0,project_id:_,type:"",cost:0}),yt=a=>{if(!a)return"—";const e=V.value.find(t=>t.id===a);return e?e.name:`Материал #${a}`},Tl=a=>{if(!a)return"—";const e=m.value.find(t=>t.id===a);return e?e.name:`Тип #${a}`},Ca=a=>a?Ut.find(e=>e.value===a)?.label||a:"—",Ol=a=>{const e=[];return c.value.forEach(t=>{if(!t.edge_material_id||t.edge_material_id!==a||!t.edge_scheme||t.edge_scheme==="none")return;const n=(t.width||0)/1e3,p=(t.length||0)/1e3;let j=0;switch(t.edge_scheme){case"O":j=2*(n+p);break;case"=":j=2*p;break;case"||":j=2*n;break;case"L":j=n+p;break;case"П":j=2*n+p;break}const C=j*(t.quantity||0);e.push({position_id:t.id,position_name:t.custom_name||Tl(t.detail_type_id)||`Позиция ${t.id}`,width:t.width,length:t.length,edge_scheme_label:Ca(t.edge_scheme),perimeter_one:j,quantity:t.quantity,total_length:C})}),e},Fa=a=>{if(!a){L.value.edge_scheme="none";return}const e=m.value.find(t=>t.id===a);e&&e.edge_processing&&(L.value.edge_scheme=e.edge_processing),wt()},ue=a=>{if(a._cached_details)return a._cached_details;const e=a.name||"";return e.toLowerCase().includes("кромк")?Sa(a):e.toLowerCase().includes("пил")||e.toLowerCase().includes("распил")?ja(a):e.toLowerCase().includes("сверл")||e.toLowerCase().includes("отверст")?Rl(a):{type:"manual",is_manual:!0,message:"Введено вручную экспертом"}},Sa=a=>{if(a.type==="manual")return{type:"edging",is_manual:!0,message:"Введено вручную экспертом"};const e=[];let t=0;Ze.value.forEach(j=>{Ol(j.id).forEach(N=>{e.push({position_name:N.position_name,material_name:j.name,length:N.total_length}),t+=N.total_length})});const n=El(),p=t*n;return{type:"edging",details:e,total_length:t,waste_coeff:n,total_with_waste:p,unit:"м.п."}},ja=a=>{if(a.type==="manual")return{type:"sawing",is_manual:!0,message:"Введено вручную экспертом"};const e=[];let t=0;return Ye.value.forEach(n=>{const p=n.area_details;p>0&&(e.push({material_name:n.name,area:p}),t+=p)}),{type:"sawing",details:e,total_area:t,unit:"м²",note:"Объём распиловки считается от площади деталей плитных материалов"}},Rl=a=>{if(console.log("getDrillingOperationDetails called:",{name:a.name,type:a.type,quantity_from_api:a.quantity,source:a.source,operation_id:a.operation_id,positions:c.value.length,detail_types:m.value.length}),a.type==="manual")return console.log("  -> operation is manual, returning manual message"),{type:"drilling",is_manual:!0,message:"Введено вручную экспертом"};const e=new Map;c.value.forEach(p=>{const j=V.value.find(C=>C.id===p.material_id);if(console.log("  checking position:",{material_id:p.material_id,material_type:j?.type,detail_type_id:p.detail_type_id,quantity:p.quantity}),j?.type==="plate"&&p.detail_type_id){const C=m.value.find(N=>N.id===p.detail_type_id);if(C){console.log("    -> found detailType:",C.name),e.has(p.detail_type_id)||e.set(p.detail_type_id,{detail_type_name:C.name,total_quantity:0,holes_per_piece:8});const N=e.get(p.detail_type_id);N.total_quantity+=p.quantity||1}}});const t=Array.from(e.values()).map(p=>({detail_type_name:p.detail_type_name,holes_per_piece:p.holes_per_piece,quantity:p.total_quantity,total_holes:p.holes_per_piece*p.total_quantity}));console.log("  drilling details:",t);let n=0;return t.forEach(p=>{n+=p.total_holes}),console.log("  SUMMARY:",{calculated_total:n,api_quantity:a.quantity,difference:a.quantity-n,details_count:t.length}),{type:"drilling",is_manual:!1,details:t,total_holes:n,unit:"шт.",message:"Расчёт по позициям с плитными материалами"}};let xl=null;const wt=()=>{xl&&clearTimeout(xl),xl=setTimeout(()=>Wl(),350)},Wl=async()=>{try{O.value.operations=!0;const e=(await x.get(`/api/projects/${_}/operations`)).data||[];Array.isArray(e)?Ht.value=e:(console.warn("Operations data is not an array:",e),Ht.value=[])}catch(a){console.warn("Recalc operations failed",a),Ht.value=[]}finally{O.value.operations=!1}},Ua=a=>{L.value.material_id=a,wt()},Da=a=>{L.value.edge_scheme=a||"none",wt()},Aa=a=>{L.value.edge_material_id=a,wt()},Bl=async()=>{try{O.value.materials=!0;const[a,e,t,n,p,j]=await Promise.all([x.get("/api/detail-types").then(C=>C.data),x.get("/api/materials").then(C=>C.data),x.get("/api/operations").then(C=>C.data),x.get("/api/units").then(C=>C.data),x.get("/api/regions").then(C=>C.data?.data||[]),x.get("/api/position-profiles").then(C=>C.data?.data||[])]);m.value=a,V.value=e,console.log("Materials loaded:",e.length,"samples:",e.slice(0,2)),ea.value=t,K.value=n||[],Y.value=p,ta.value=j,console.log("Position profiles loaded:",j.length,"profiles:",j.map(C=>({id:C.id,name:C.name}))),console.log("Regions loaded:",p.length,"samples:",p.slice(0,3))}finally{O.value.materials=!1}},ge=async()=>{try{it.value=!0,Lt.value=!1,O.value.positions=!0,O.value.fittings=!0,O.value.expenses=!0,i.value=(await x.get(`/api/projects/${_}`)).data;const a=i.value.profileRates;if(console.log("✅ Project loaded:",{id:i.value.id,name:i.value.number,hasProfileRates:!!a,profileRatesCount:Array.isArray(a)?a.length:0,profileRatesType:typeof a}),a&&a.length>0&&console.log("📊 First profileRate structure:",JSON.stringify(a[0],null,2)),i.value.use_area_calc_mode=i.value.use_area_calc_mode===!0||i.value.use_area_calc_mode===1,i.value.apply_waste_to_plate=i.value.apply_waste_to_plate!==!1&&i.value.apply_waste_to_plate!==0,i.value.apply_waste_to_edge=i.value.apply_waste_to_edge!==!1&&i.value.apply_waste_to_edge!==0,i.value.apply_waste_to_operations=i.value.apply_waste_to_operations!==!1&&i.value.apply_waste_to_operations!==0,i.value.normohour_rate=Number(i.value.normohour_rate)||0,i.value.waste_coefficient=Number(i.value.waste_coefficient)||1,i.value.waste_plate_coefficient=i.value.waste_plate_coefficient?Number(i.value.waste_plate_coefficient):null,i.value.waste_edge_coefficient=i.value.waste_edge_coefficient?Number(i.value.waste_edge_coefficient):null,i.value.waste_operations_coefficient=i.value.waste_operations_coefficient?Number(i.value.waste_operations_coefficient):null,i.value.repair_coefficient=Number(i.value.repair_coefficient)||1,i.value.show_waste_plate_description=i.value.show_waste_plate_description===!0||i.value.show_waste_plate_description===1,i.value.show_waste_edge_description=i.value.show_waste_edge_description===!0||i.value.show_waste_edge_description===1,i.value.show_waste_operations_description=i.value.show_waste_operations_description===!0||i.value.show_waste_operations_description===1,!i.value.text_blocks)i.value.text_blocks=[];else if(typeof i.value.text_blocks=="string")try{const t=JSON.parse(i.value.text_blocks);Array.isArray(t)&&t.length>0&&typeof t[0]=="string"?i.value.text_blocks=t.map(n=>({title:"",text:n||"",enabled:!0})):Array.isArray(t)?i.value.text_blocks=t.map(n=>({...n,enabled:n.enabled===!0||n.enabled===1})):i.value.text_blocks=[]}catch{i.value.text_blocks=[]}else Array.isArray(i.value.text_blocks)&&i.value.text_blocks.length>0&&typeof i.value.text_blocks[0]=="string"&&(i.value.text_blocks=i.value.text_blocks.map(t=>({title:"",text:t||"",enabled:!0})));c.value=(await x.get(`/api/projects/${_}/positions`)).data,de.value=(await x.get(`/api/projects/${_}/fittings`)).data,U.value=(await x.get(`/api/projects/${_}/expenses`)).data,console.log("Loaded positions:",c.value),console.log("Loaded expenses:",U.value),U.value&&U.value.length>0&&console.log("First expense structure:",JSON.stringify(U.value[0],null,2)),console.log("Available materials:",V.value.slice(0,3)),console.log("Project coefficients:",{waste_coefficient:i.value.waste_coefficient,waste_plate_coefficient:i.value.waste_plate_coefficient,waste_edge_coefficient:i.value.waste_edge_coefficient,waste_operations_coefficient:i.value.waste_operations_coefficient}),console.log("📝 Text blocks loaded:",i.value.text_blocks),await Wl(),await Kl(),await Ke();const e=i.value.profileRates;console.log("✅ fetchData completed, final profileRates check:",{hasProfileRates:!!e,count:Array.isArray(e)?e.length:0,rates:e?Array.isArray(e)?e.map(t=>({id:t.id,is_locked:t.is_locked,method:t.calculation_method})):[]:[]})}catch(a){console.error("Ошибка загрузки данных проекта:",a),k(`Не удалось загрузить проект: ${a.response?.data?.message||a.message}`,"error")}finally{O.value.positions=!1,O.value.fittings=!1,O.value.expenses=!1,it.value=!1,Lt.value=!0}},za=async()=>{_e.value=!0;try{await Promise.all([Bl(),ge()])}catch(a){console.error("Refresh failed",a),k("Не удалось обновить данные","error")}finally{_e.value=!1}},Pa=()=>{bl.value=!1,L.value={id:null,project_id:_,detail_type_id:null,material_id:i.value?.default_plate_material_id||null,edge_material_id:i.value?.default_edge_material_id||null,edge_scheme:"none",width:0,length:0,quantity:1,custom_name:null},Dt.value=!0},Na=async()=>{const{valid:a}=await Il.value.validate();if(a)try{if(L.value.material_id){const e=V.value.find(t=>t.id===L.value.material_id);if(e&&e.type==="plate"&&(e.width_mm||e.length_mm)){const t=L.value.width||0,n=L.value.length||0,p=e.width_mm||0,j=e.length_mm||0,C=Math.max(p,j),N=Math.min(p,j);if((t>C||n>C||Math.min(t,n)>N&&Math.max(t,n)>C)&&e.width_mm&&e.length_mm&&!confirm(`⚠️ ВНИМАНИЕ!

Размер детали (${t}×${n} мм) превышает размер листа материала (${p}×${j} мм).

Проверьте корректность введённых данных.

Продолжить сохранение?`)){console.log("Сохранение отменено пользователем из-за превышения размера");return}}}bl.value?await x.put(`/api/project-positions/${L.value.id}`,L.value):await x.post(`/api/projects/${_}/positions`,L.value),Dt.value=!1,await ge()}catch(e){console.error(e),k("Ошибка сохранения позиции","error")}},qa=async a=>{confirm("Удалить позицию?")&&(await x.delete(`/api/project-positions/${a.id}`),await ge())},Ma=async a=>{try{bt.value=a.id||null;const e={project_id:_,detail_type_id:a.detail_type_id,material_id:a.material_id,edge_material_id:a.edge_material_id,edge_scheme:a.edge_scheme,width:a.width,length:a.length,quantity:a.quantity,custom_name:a.custom_name};console.log("🔄 Cloning position:",e);const t=await x.post(`/api/projects/${_}/positions`,e);console.log("✅ Position cloned successfully"),await ge();const n=t?.data?.id||t?.data?.data?.id;n&&(Se.value=n,J(n),window.setTimeout(()=>{Se.value===n&&(Se.value=null)},2e3))}catch(e){console.error("❌ Error cloning position:",e),k(`Ошибка при клонировании: ${e.response?.data?.message||e.message}`,"error")}finally{bt.value=null}},Je=async(a,e,t)=>{if(!a.id){k("Сначала сохраните позицию через диалог","warning");return}const n={};e==="width"||e==="length"?(n[e]=parseFloat(t)||0,a[e]=n[e]):e==="quantity"?(n[e]=parseInt(t)||1,a[e]=n[e]):(n[e]=t,a[e]=t);try{await x.put(`/api/project-positions/${a.id}`,n),wt()}catch(p){console.error(p),k("Ошибка сохранения позиции","error"),await ge()}},La=a=>{const e=Math.round(a.width||0),t=Math.round(a.length||0);return!e&&!t?"—":`${e}×${t}`},hl=a=>{q.value=a,ne.value=!0},Ea=(a,e)=>{Je(a,"edge_scheme",e),(!e||e==="none")&&Je(a,"edge_material_id",null)},Ia=(a,e)=>{const t=a.target;t.closest(".v-selection-control")||t.closest("button")||t.closest("a")||t.closest(".v-icon")||hl(e.item)},Ta=[{title:"Заменить материал основы",value:"replace_material"},{title:"Заменить материал кромки",value:"replace_edge"},{title:"Установить обработку торцов",value:"set_edge_scheme"},{title:"Очистить выбранное поле",value:"clear_field"},{title:"Удалить позиции",value:"delete"}],Oa=[{title:"Материал основы",value:"material_id"},{title:"Материал кромки",value:"edge_material_id"},{title:"Обработка торцов",value:"edge_scheme"},{title:"Название",value:"custom_name"}],Ra=X(()=>u.value?u.value==="replace_material"?!!g.value:u.value==="replace_edge"?!!T.value:u.value==="set_edge_scheme"?!!W.value:u.value==="clear_field"?!!Te.value:!0:!1),Wa=a=>{console.log("🟢 onPositionSelectionChange:",a,typeof a,Array.isArray(a)),Array.isArray(a)&&(B.value=a)},Ba=()=>{B.value=c.value.map(a=>a.id).filter(a=>a!==null)},Hl=()=>{B.value=[]},Ha=X(()=>ve.value.length===0?!1:c.value.filter(e=>e.id&&ve.value.includes(e.id)).every(e=>e.edge_material_id!==null&&e.edge_material_id!==void 0)),Jl=X(()=>c.value.filter(e=>e.id&&ve.value.includes(e.id)).filter(e=>!e.edge_material_id)),Ja=async()=>{if(u.value){if(u.value==="set_edge_scheme"&&!Ha.value){const a=Jl.value.length,e=Jl.value.slice(0,3).map(n=>n.custom_name||`ID ${n.id}`).join(", "),t=a>3?` и ещё ${a-3}...`:"";k(`Невозможно установить схему кромки: у ${a} поз. не назначен кромочный материал (${e}${t})`,"warning");return}ot.value=!1;try{const a={action:u.value==="delete"?"delete":"update",ids:ve.value,select_all:!1};u.value==="replace_material"?a.updates={material_id:g.value}:u.value==="replace_edge"?a.updates={edge_material_id:T.value}:u.value==="set_edge_scheme"?a.updates={edge_scheme:W.value}:u.value==="clear_field"&&(a.clear_field=Te.value),await x.post(`/api/projects/${_}/positions/bulk`,a),k("Массовая операция выполнена","success"),Hl(),u.value=null,g.value=null,T.value=null,W.value=null,Te.value=null,await ge(),wt()}catch(a){console.error(a),k(a.response?.data?.message||"Ошибка массовой операции","error")}}},Ka=()=>{Ot.value=!1;const a=K.value[0]||"шт";se.value={id:0,project_id:_,name:"",article:"",unit:a,quantity:1,unit_price:0,note:""},ft.value=!0},Xa=a=>{Ot.value=!0;const e=K.value[0]||"шт";se.value={...a,unit:a.unit||e,note:a.note??""},ft.value=!0},Qa=async()=>{try{const a={name:se.value.name,article:se.value.article,unit:se.value.unit||K.value[0]||"шт",quantity:Number(se.value.quantity)||0,unit_price:Number(se.value.unit_price)||0,note:se.value.note||null};Ot.value?await x.put(`/api/project-fittings/${se.value.id}`,a):await x.post(`/api/projects/${_}/fittings`,a),ft.value=!1,await ge()}catch(a){const e=a,t=e?.response?.data?.errors,n=t?Object.values(t).flat().join(`
`):e?.response?.data?.message||e?.message||"Ошибка сохранения фурнитуры";k(n,"error")}},Ga=async a=>{confirm("Удалить фурнитуру?")&&(await x.delete(`/api/project-fittings/${a.id}`),await ge())},Ya=async()=>{try{const a=Number(i.value.waste_coefficient),e=i.value.waste_plate_coefficient?Number(i.value.waste_plate_coefficient):null,t=i.value.waste_edge_coefficient?Number(i.value.waste_edge_coefficient):null,n=i.value.waste_operations_coefficient?Number(i.value.waste_operations_coefficient):null;if(a<0){k("Коэффициент обрезков не может быть отрицательным","warning");return}if(e!==null&&e<0){k("Коэффициент для плитных материалов не может быть отрицательным","warning");return}if(t!==null&&t<0){k("Коэффициент для кромки не может быть отрицательным","warning");return}if(n!==null&&n<0){k("Коэффициент для операций не может быть отрицательным","warning");return}const p={...i.value,waste_coefficient:Math.max(0,a)||1,waste_plate_coefficient:e!==null?Math.max(0,e):null,waste_edge_coefficient:t!==null?Math.max(0,t):null,waste_operations_coefficient:n!==null?Math.max(0,n):null,apply_waste_to_plate:i.value.apply_waste_to_plate===!0,apply_waste_to_edge:i.value.apply_waste_to_edge===!0,apply_waste_to_operations:i.value.apply_waste_to_operations===!0,use_area_calc_mode:i.value.use_area_calc_mode===!0,repair_coefficient:Math.max(0,Number(i.value.repair_coefficient)||1),region_id:i.value.region_id?Number(i.value.region_id):null,text_blocks:i.value.text_blocks&&Array.isArray(i.value.text_blocks)?i.value.text_blocks.map(C=>({title:(C.title||"").trim(),text:M(C.text||"").substring(0,3e3),enabled:C.enabled!==!1})):[],waste_plate_description:i.value.waste_plate_description?{title:i.value.waste_plate_description.title.trim(),text:M(i.value.waste_plate_description.text).substring(0,3e3)}:null,show_waste_plate_description:i.value.show_waste_plate_description===!0,waste_edge_description:i.value.waste_edge_description?{title:i.value.waste_edge_description.title.trim(),text:M(i.value.waste_edge_description.text).substring(0,3e3)}:null,show_waste_edge_description:i.value.show_waste_edge_description===!0,waste_operations_description:i.value.waste_operations_description?{title:i.value.waste_operations_description.title.trim(),text:M(i.value.waste_operations_description.text).substring(0,3e3)}:null,show_waste_operations_description:i.value.show_waste_operations_description===!0,normohour_rate:i.value.normohour_rate?Number(i.value.normohour_rate):null,normohour_region:i.value.normohour_region?i.value.normohour_region.trim():null,normohour_date:i.value.normohour_date||null,normohour_method:i.value.normohour_method||null,normohour_justification:i.value.normohour_justification?M(i.value.normohour_justification).substring(0,5e3):null};console.log("💾 Before save - project values in memory:",{waste_coefficient:i.value.waste_coefficient,waste_plate_coefficient:i.value.waste_plate_coefficient,waste_edge_coefficient:i.value.waste_edge_coefficient,waste_operations_coefficient:i.value.waste_operations_coefficient,apply_waste_to_plate:i.value.apply_waste_to_plate,apply_waste_to_edge:i.value.apply_waste_to_edge,apply_waste_to_operations:i.value.apply_waste_to_operations,text_blocks:i.value.text_blocks}),console.log("💾 Saving project with full data:",{waste_coefficient:p.waste_coefficient,waste_plate_coefficient:p.waste_plate_coefficient,waste_edge_coefficient:p.waste_edge_coefficient,waste_operations_coefficient:p.waste_operations_coefficient,apply_waste_to_plate:p.apply_waste_to_plate,apply_waste_to_edge:p.apply_waste_to_edge,apply_waste_to_operations:p.apply_waste_to_operations,use_area_calc_mode:p.use_area_calc_mode,repair_coefficient:p.repair_coefficient,text_blocks:p.text_blocks,show_waste_plate_description:p.show_waste_plate_description,show_waste_edge_description:p.show_waste_edge_description,show_waste_operations_description:p.show_waste_operations_description,normohour_rate:p.normohour_rate,normohour_region:p.normohour_region,normohour_date:p.normohour_date,normohour_method:p.normohour_method});const j=await x.put(`/api/projects/${_}`,p);if(console.log("✅ Project saved successfully, response data:",j.data),j.data){if(console.log("📥 Updating project from server response..."),it.value=!0,i.value=j.data,i.value.use_area_calc_mode=i.value.use_area_calc_mode===!0||i.value.use_area_calc_mode===1,i.value.apply_waste_to_plate=i.value.apply_waste_to_plate!==!1&&i.value.apply_waste_to_plate!==0,i.value.apply_waste_to_edge=i.value.apply_waste_to_edge!==!1&&i.value.apply_waste_to_edge!==0,i.value.apply_waste_to_operations=i.value.apply_waste_to_operations!==!1&&i.value.apply_waste_to_operations!==0,i.value.waste_coefficient=Number(i.value.waste_coefficient)||1,i.value.waste_plate_coefficient=i.value.waste_plate_coefficient?Number(i.value.waste_plate_coefficient):null,i.value.waste_edge_coefficient=i.value.waste_edge_coefficient?Number(i.value.waste_edge_coefficient):null,i.value.waste_operations_coefficient=i.value.waste_operations_coefficient?Number(i.value.waste_operations_coefficient):null,i.value.repair_coefficient=Number(i.value.repair_coefficient)||1,!i.value.text_blocks)i.value.text_blocks=[];else if(typeof i.value.text_blocks=="string")try{i.value.text_blocks=JSON.parse(i.value.text_blocks),Array.isArray(i.value.text_blocks)||(i.value.text_blocks=[])}catch{i.value.text_blocks=[]}console.log("✅ Project values after update:",{waste_coefficient:i.value.waste_coefficient,waste_plate_coefficient:i.value.waste_plate_coefficient,waste_edge_coefficient:i.value.waste_edge_coefficient,waste_operations_coefficient:i.value.waste_operations_coefficient,text_blocks:i.value.text_blocks}),it.value=!1}else console.log("⚠️ Server response empty, reloading from server..."),await ge()}catch(a){console.error("❌ Error saving project:",a),k(`Ошибка сохранения: ${a.response?.data?.message||a.message}`,"error")}},Kl=async()=>{try{O.value.normohourSources=!0;const a=await x.get(`/api/projects/${_}/normohour-sources`);Wt.value=a.data||[],console.log("📊 Normohour sources loaded:",Wt.value)}catch(a){console.error("❌ Error loading normohour sources:",a),Wt.value=[]}finally{O.value.normohourSources=!1}},Xl=()=>{wl.value=!1,kl.value=!1,P.value={source:"",position_profile:null,salary_range:null,period:null,link:null,note:null},Me.value={}},Za=()=>(Me.value={},(!P.value.source||!P.value.source.trim())&&(Me.value.source="Источник обязателен"),P.value.link&&P.value.link.trim()&&(/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(P.value.link.trim())||(Me.value.link="Некорректная ссылка")),Object.keys(Me.value).length===0),es=async()=>{if(Za())try{const a={source:P.value.source.trim(),position_profile:P.value.position_profile?P.value.position_profile.trim():null,salary_range:P.value.salary_range?P.value.salary_range.trim():null,period:P.value.period?P.value.period.trim():null,link:P.value.link?P.value.link.trim():null,note:P.value.note?P.value.note.trim():null};if(kl.value&&P.value.id)await x.put(`/api/projects/${_}/normohour-sources/${P.value.id}`,a),console.log("✅ Normohour source updated");else{if(Wt.value.length>=20){k("Максимум 20 источников","warning");return}await x.post(`/api/projects/${_}/normohour-sources`,a),console.log("✅ Normohour source created")}await Kl(),Xl()}catch(a){console.error("❌ Error saving normohour source:",a);const e=a.response?.data?.message||a.message;k(`Ошибка: ${e}`,"error")}},Ql=async()=>{gt.value=!0;try{const a=await x.get(`/api/smeta/pdf/${_}`,{responseType:"blob"}),e=URL.createObjectURL(a.data),t=document.createElement("a");t.href=e,t.download=`smeta_${_}.pdf`,t.click(),URL.revokeObjectURL(e)}catch(a){console.error("❌ PDF generation error:",a),k(`Ошибка генерации PDF: ${a.response?.data?.message||a.message}`,"error")}finally{gt.value=!1}},ts=async()=>{It.value=!0;try{const a=await x.post(`/api/projects/${_}/revisions`);a.data.success&&(rt.value={number:a.data.number,created_at:a.data.created_at,status:"locked"},k(`Ревизия #${a.data.number} успешно создана`,"success"),await Bt(),await At(1))}catch(a){console.error("❌ Snapshot creation error:",a),k(`Ошибка создания ревизии: ${a.response?.data?.message||a.message}`,"error")}finally{It.value=!1}},Bt=async()=>{try{const a=await x.get(`/api/projects/${_}/revisions/latest`);a.data.success&&a.data.revision&&(rt.value=a.data.revision)}catch(a){console.error("❌ Failed to fetch latest revision:",a)}},At=async(a=qe.page)=>{gl.value=!0;try{const e=await x.get(`/api/projects/${_}/revisions`,{params:{page:a,per_page:qe.perPage}});if(e.data.success){_l.value=e.data.revisions||[];const t=e.data.pagination||{};qe.page=t.current_page||a,qe.lastPage=t.last_page||1,qe.total=t.total||_l.value.length}}catch(e){console.error("❌ Failed to fetch revisions:",e),k(`Ошибка загрузки ревизий: ${e.response?.data?.message||e.message}`,"error")}finally{gl.value=!1}},Vl=a=>{switch(a){case"locked":return"зафиксирована";case"published":return"опубликована";case"stale":return"устарела";default:return a||"—"}},Gl=a=>{switch(a){case"published":return"success";case"locked":return"primary";case"stale":return"grey";default:return"grey"}},Yl=a=>{if(!a)return"—";const e=new Date(a);return Number.isNaN(e.getTime())?a:e.toLocaleString("ru-RU")},Zl=a=>!a||a.length<16?a:`${a.slice(0,8)}…${a.slice(-8)}`,ls=a=>a?.status==="locked",as=a=>a?.status==="published",ss=async a=>{try{const e=await x.get(`/api/projects/${_}/revisions/${a.number}`),t=e.data.revision||e.data;ut.value=t;const n=t.snapshot_json;if(n){let p=typeof n=="string"?JSON.parse(n):n;typeof p=="string"&&(p=JSON.parse(p)),yl.value=JSON.stringify(p,null,2)}else yl.value="";Tt.value=!0}catch(e){console.error("❌ Failed to load revision:",e),k(`Ошибка загрузки ревизии: ${e.response?.data?.message||e.message}`,"error")}},os=async a=>{try{const e=await x.get(`/api/projects/${_}/revisions/${a.number}/pdf`,{responseType:"blob"}),t=URL.createObjectURL(e.data),n=document.createElement("a");n.href=t,n.download=`smeta_${_}_rev_${a.number}.pdf`,n.click(),URL.revokeObjectURL(t)}catch(e){console.error("❌ Revision PDF error:",e);const t=e.response?.data?.error||e.response?.data?.details;k(`Ошибка PDF из ревизии: ${t||e.response?.data?.message||e.message}`,"error")}},is=async a=>{try{const t=(await x.post(`/api/projects/${_}/revisions/${a.number}/publish`)).data?.publication?.public_url;k(t?`Ревизия #${a.number} опубликована. Ссылка: ${t}`:`Ревизия #${a.number} опубликована`,"success"),await At(qe.page),await Bt()}catch(e){console.error("❌ Publish revision error:",e),k(`Ошибка публикации: ${e.response?.data?.message||e.message}`,"error")}},ns=async a=>{try{await x.post(`/api/projects/${_}/revisions/${a.number}/unpublish`),k(`Публикация отозвана для ревизии #${a.number}`,"success"),await At(qe.page),await Bt()}catch(e){console.error("❌ Unpublish revision error:",e),k(`Ошибка снятия публикации: ${e.response?.data?.message||e.message}`,"error")}},rs=async a=>{try{if(!a?.snapshot_hash){k("Fingerprint отсутствует","warning");return}await navigator.clipboard.writeText(a.snapshot_hash),k("Fingerprint скопирован","success")}catch(e){console.error("❌ Copy fingerprint error:",e),k("Не удалось скопировать fingerprint","error")}},us=()=>{Rt.value=!1,Ae.value={id:0,project_id:_,name:"",description:"",amount:0},_t.value=!0},ds=a=>{Rt.value=!0,Ae.value={...a},_t.value=!0},cs=async()=>{try{const a={name:Ae.value.name,description:Ae.value.description,amount:Number(Ae.value.amount)||0};Rt.value?await x.put(`/api/projects/${_}/expenses/${Ae.value.id}`,a):await x.post(`/api/projects/${_}/expenses`,a),_t.value=!1,await ge()}catch(a){const e=a,t=e?.response?.data?.errors,n=t?Object.values(t).flat().join(`
`):e?.response?.data?.message||e?.message||"Ошибка сохранения расхода";k(n,"error")}},ps=async a=>{confirm("Удалить расход?")&&(await x.delete(`/api/projects/${_}/expenses/${a.id}`),await ge())},Ht=f([]),$l=f(null),bt=f(null),Jt=X(()=>Ht.value.map(e=>{const t=e.name||"",n=t.toLowerCase().includes("сверл")||t.toLowerCase().includes("отверст"),p=e.type!=="manual"&&!e.source?.includes("manual");let j=e.quantity;if(n&&p&&e.source==="detail_type"){const C=Rl(e);C.total_holes!==void 0&&(j=C.total_holes)}return{...e,quantity:j,is_manual:e.type==="manual"||e.source==="manual"||!!e.is_manual,total_cost:(j??0)*(e.cost_per_unit??0),_cached_details:ue(e)}})),ea=f([]),kt=f(!1),Kt=f(!1),ze=f({id:0,project_id:_,operation_id:null,quantity:1,note:""}),ms=[{title:"",key:"data-table-expand"},{title:"Наименование",key:"name"},{title:"Категория",key:"category"},{title:"Цена за ед.",key:"cost_per_unit",align:"end"},{title:"Кол-во",key:"quantity_display"},{title:"Ед. изм.",key:"unit"},{title:"Стоимость",key:"total_cost",align:"end"},{title:"Источник",key:"source"},{title:"Действия",key:"actions",sortable:!1}],Oe=f([]),ta=f([]),xt=f(!1),Cl=f(!1),la=f(null),Le=f(null),oe=f({title:"",basis:"",hours:0,note:"",position_profile_id:null}),Xt=f(!1),Z=f(null),Ee=f([]),Qt=f(!1),xe=f(null),aa=f(null),le=f({title:"",basis:"",input_data:"",hours:0,note:""});f(!1);const ht=f("");f("sort");const Fl=f(!1),Gt=f(!1),Yt=f(null),E=f({domain:void 0,action_type:void 0,constraints:"normal",site_state:void 0,material:void 0,object_type:void 0}),Zt=f(void 0),el=f(!1),tl=f(!1),fe=f(null),ll=f(!1),Sl=f(null),jl=f(null),vs=[{title:"Мебель",value:"furniture"},{title:"Строительство",value:"construction"},{title:"Электрика",value:"electrical"},{title:"Сантехника",value:"plumbing"},{title:"Клининг",value:"cleaning"}],fs=[{title:"Установка",value:"install"},{title:"Демонтаж",value:"dismantle"},{title:"Ремонт",value:"repair"},{title:"Регулировка",value:"adjust"}],_s=[{title:"Обычные",value:"normal"},{title:"Стеснённые",value:"cramped"}],gs=[{title:"Черновая",value:"rough"},{title:"Жилое",value:"living"},{title:"Аварийное",value:"emergency"}],al=X(()=>Ee.value.reduce((a,e)=>a+(parseFloat(e.hours)||0),0)),zt=X(()=>{const a=[...Ee.value].sort((t,n)=>(t.sort_order??0)-(n.sort_order??0));if(!ht.value)return a;const e=ht.value.toLowerCase();return a.filter(t=>t.title?.toLowerCase().includes(e)||t.basis?.toLowerCase().includes(e)||t.note?.toLowerCase().includes(e))}),Ul=f(null),ys=a=>[{key:"details",icon:"mdi-clipboard-list",label:"Детализация",disabled:Yt.value===a.id},{key:"edit",icon:"mdi-pencil",label:"Изменить"},{key:"delete",icon:"mdi-delete",label:"Удалить",color:"error"}],ws=a=>[],bs=a=>{const e=Oe.value.find(t=>t.id===a.rowId);if(e)switch(a.actionKey){case"details":qs(e);break;case"edit":Ps(e);break;case"delete":Ns(e);break}},ks=a=>a?Ul.value===a:!1,xs=[{title:"Наименование",key:"title"},{title:"Основание",key:"basis"},{title:"Норма, ч",key:"hours",align:"end"},{title:"Ставка, ₽/ч",key:"rate",align:"end"},{title:"Сумма, ₽",key:"cost",align:"end"}],Pt=f(!1),sl=f(!1),ol=f(!1),sa=X(()=>Array.isArray(Oe.value)?Oe.value.reduce((a,e)=>a+(parseFloat(e.cost_total)||0),0):0),Nt=X(()=>{const a=i.value.profileRates;if(typeof a<"u"&&console.log("🔐 ratesLocked computed:",{type:Array.isArray(a)?"array":typeof a,value:a,length:Array.isArray(a)?a.length:a&&typeof a=="object"?Object.keys(a).length:0}),!a)return!1;const e=Array.isArray(a)?a:Object.values(a||{});if(e.length===0)return!1;const t=e.every(n=>n.is_locked===!0);return console.log("🔐 All rates locked?",t,"out of",e.length),t});Re(()=>i.value.normohour_rate,a=>{Oe.value.length>0&&(Oe.value=Oe.value.map(e=>({...e,cost:e.hours*(a||0)})))}),Re(()=>i.value.profileRates,a=>{console.log("👀 profileRates changed:",{count:a?Array.isArray(a)?a.length:Object.keys(a).length:0,rates:a?Array.isArray(a)?a.map(e=>({id:e.id,is_locked:e.is_locked})):Object.values(a).map(e=>({id:e.id,is_locked:e.is_locked})):[]})},{deep:!0}),X(()=>{try{if(!c.value||c.value.length===0)return[];const a=new Map;return c.value.forEach(e=>{if(!e.material_id)return;const t=V.value.find(j=>j.id===e.material_id);if(!t)return;const n=(e.width||0)/1e3*((e.length||0)/1e3)*(e.quantity||0);if(!a.has(e.material_id)){const j=t.price_per_unit||0;let C=j;if(t.type==="plate"&&t.length_mm&&t.width_mm){const N=t.length_mm*t.width_mm/1e6;N>0&&(C=j/N)}a.set(e.material_id,{id:e.material_id,name:t.name,volume:0,unit:t.unit||"м²",price_per_unit:C,price_per_sheet:j,updated_at:t.updated_at})}const p=a.get(e.material_id);p.volume+=n}),Array.from(a.values())}catch(a){return console.error("Ошибка вычисления данных материалов:",a),[]}});const Ye=X(()=>{try{if(!c.value||c.value.length===0)return console.log("plateData: no positions"),[];const a=xa(),e=new Map;c.value.forEach(n=>{if(!n.material_id)return;const p=V.value.find(N=>N.id===n.material_id);if(!p){console.warn("Material not found:",n.material_id);return}if(console.log("Material check:",{id:p.id,name:p.name,type:p.type,isPlate:p.type==="plate"}),p.type!=="plate"){console.log("Skipping non-plate material:",p.name,"type:",p.type);return}const j=(n.width||0)/1e3*((n.length||0)/1e3)*(n.quantity||0);if(!e.has(n.material_id)){const N=p.length_mm&&p.width_mm?p.length_mm*p.width_mm/1e6:0;e.set(n.material_id,{id:n.material_id,name:p.name,area_details:0,waste_coeff:a,area_with_waste:0,sheet_area:N,sheets_count:0,price_per_sheet:p.price_per_unit||0,price_per_m2:p.price_per_unit&&N>0?p.price_per_unit/N:0,updated_at:p.updated_at,source_url:p.source_url})}const C=e.get(n.material_id);C.area_details+=j});const t=i.value?.use_area_calc_mode===!0;return e.forEach(n=>{n.area_with_waste=n.area_details*a,t?n.sheets_count=0:n.sheets_count=n.sheet_area>0?Math.ceil(n.area_with_waste/n.sheet_area):0}),console.log("plateData result:",Array.from(e.values()),"area mode:",t),Array.from(e.values())}catch(a){return console.error("Ошибка вычисления плитных материалов:",a),[]}}),Ze=X(()=>{try{if(!c.value||c.value.length===0)return[];const a=El(),e=new Map;return c.value.forEach(t=>{if(!t.edge_material_id||!t.edge_scheme||t.edge_scheme==="none")return;const n=V.value.find(ua=>ua.id===t.edge_material_id);if(!n||n.type!=="edge")return;let p=0;const j=(t.width||0)/1e3,C=(t.length||0)/1e3,N=t.quantity||0;switch(t.edge_scheme){case"O":p=2*(j+C)*N;break;case"=":p=2*C*N;break;case"||":p=2*j*N;break;case"L":p=(j+C)*N;break;case"П":p=(2*j+C)*N;break;default:p=0}e.has(t.edge_material_id)||e.set(t.edge_material_id,{id:t.edge_material_id,name:n.name,length_linear:0,waste_coeff:a,length_with_waste:0,price_per_unit:n.price_per_unit||0,updated_at:n.updated_at});const ra=e.get(t.edge_material_id);ra.length_linear+=p}),e.forEach(t=>{t.length_with_waste=t.length_linear*a}),Array.from(e.values())}catch(a){return console.error("Ошибка вычисления кромки:",a),[]}}),hs=X(()=>{if(!Ye.value||Ye.value.length===0)return 0;const a=i.value?.use_area_calc_mode===!0;return Ye.value.reduce((e,t)=>{const n=a?t.area_with_waste*(Number(t.price_per_m2)||0):t.sheets_count*(Number(t.price_per_sheet)||0);return e+n},0)}),Vs=X(()=>!Ze.value||Ze.value.length===0?0:Ze.value.reduce((a,e)=>a+e.length_with_waste*(Number(e.price_per_unit)||0),0)),$s=X(()=>(hs.value||0)+(Vs.value||0)),Cs=X(()=>!Jt.value||Jt.value.length===0?0:Jt.value.reduce((a,e)=>{const t=parseFloat(e.total_cost??(e.quantity||0)*(e.cost_per_unit||0))||0;return a+t},0)),Fs=()=>{Kt.value=!1,ze.value={id:0,project_id:_,operation_id:null,quantity:1,note:""},kt.value=!0},Ss=async()=>{try{const a={quantity:Number(ze.value.quantity)||0,note:ze.value.note||null},e=ze.value.operation_id;a.operation_id=e&&typeof e=="object"?e.id:e,Kt.value?await x.put(`/api/project-operations/${ze.value.id}`,a):await x.post(`/api/projects/${_}/operations`,a),kt.value=!1,await ge()}catch(a){console.error("saveOperation error",a),k("Ошибка сохранения операции: "+(a.response?.data?.message||a.message),"error")}},js=a=>{Kt.value=!0,ze.value={...a},kt.value=!0},Us=async a=>{if(confirm("Удалить ручную операцию?"))try{await x.delete(`/api/project-operations/${a.id}`),await ge()}catch{k("Ошибка удаления операции","error")}},Ds=async()=>{sl.value=!0;try{const a=await x.post(`/api/projects/${_}/profile-rates/recalculate-and-fix`,{method:"median",only_if_missing:!1});if(a.data.success){await Ke(),Pt.value=!1,console.log("✅ Ставки успешно пересчитаны и зафиксированы",a.data.data);const e=a.data.data.created_rate_ids?.length??0;k(`Ставки успешно пересчитаны и зафиксированы (${e} ставок создано)`,"success")}else console.error("❌ Ошибка при пересчете ставок:",a.data.message),k("Ошибка при пересчете ставок: "+a.data.message,"error")}catch(a){console.error("❌ Ошибка запроса пересчета ставок:",a);try{await Ke(),k("Данные перезагружены, но фиксация ставок не прошла","warning")}catch{k("Ошибка при пересчете ставок: "+(a.response?.data?.message||a.message),"error")}}finally{sl.value=!1}},As=async()=>{ol.value=!0;try{if(Nt.value){console.log("🔓 Разблокирование ставок...");const e=await x.post(`/api/projects/${_}/profile-rates/unlock`,{});if(e.data.success){console.log("� Перезагрузка данных проекта для обновления статуса..."),await ge(),console.log("✅ Ставки успешно разблокированы",e.data.data);const t=e.data.data.unlocked_count??0;k(`Ставки успешно разблокированы (${t} ставок разблокировано)`,"success")}else console.error("❌ Ошибка при разблокировке ставок:",e.data.message),k("Ошибка при разблокировке ставок: "+e.data.message,"error")}else{console.log("📌 Создание/фиксирование ставок перед блокировкой...");const e=await x.post(`/api/projects/${_}/profile-rates/recalculate-and-fix`,{method:"median",only_if_missing:!1});if(!e.data.success){k("Ошибка при подготовке ставок к блокировке: "+e.data.message,"error");return}console.log("✅ Ставки подготовлены к блокировке"),console.log("🔒 Блокирование ставок...");const t=await x.post(`/api/projects/${_}/profile-rates/lock`,{});if(t.data.success){console.log("🔄 Перезагрузка данных проекта для обновления статуса блокировки..."),await ge(),console.log("✅ Ставки успешно заблокированы",t.data.data);const n=t.data.data.locked_count??0;k(`Ставки успешно заблокированы (${n} ставок заблокировано)`,"success")}else console.error("❌ Ошибка при блокировке ставок:",t.data.message),k("Ошибка при блокировке ставок: "+t.data.message,"error")}}catch(a){console.error("❌ Ошибка при изменении статуса блокировки ставок:",a);try{await Ke(),k("Данные перезагружены, но операция не прошла: "+(a.response?.data?.message||a.message),"warning")}catch{k("Ошибка при изменении статуса блокировки ставок: "+(a.response?.data?.message||a.message),"error")}}finally{ol.value=!1}},zs=()=>{Le.value=null,oe.value={title:"",basis:"",hours:0,note:"",position_profile_id:null},xt.value=!0},oa=async()=>{try{if(!la.value?.validate())return;Cl.value=!0;const a={title:oe.value.title||"",basis:oe.value.basis||null,hours:parseFloat(String(oe.value.hours))||0,note:oe.value.note||null,position_profile_id:oe.value.position_profile_id||null,hours_source:Le.value?.hours_source||"manual",hours_manual:Le.value?.hours_manual||parseFloat(String(oe.value.hours))||0};Le.value?.id?await qt.update(Number(_),Le.value.id,a):await qt.create(Number(_),{project_id:Number(_),...a}),xt.value=!1,await Ke()}catch(a){console.error("saveLaborWork error",a),k("Ошибка сохранения работы: "+(a.response?.data?.message||a.message),"error")}finally{Cl.value=!1}},Ps=a=>{Le.value=a,oe.value={title:a.title,basis:a.basis||"",hours:a.hours,note:a.note||"",position_profile_id:a.position_profile_id||null},xt.value=!0},Ns=async a=>{if(confirm(`Удалить работу "${a.title}"?`))try{await qt.delete(Number(_),a.id),await Ke()}catch(e){console.error("deleteLaborWork error",e),k("Ошибка удаления работы: "+(e.response?.data?.message||e.message),"error")}},qs=async a=>{Z.value=a,Ee.value=[],le.value={title:"",basis:"",input_data:"",hours:0,note:""},Yt.value=a.id??null,fe.value=null,Sl.value=null,jl.value=null,Zt.value=a.hours||void 0;try{await dt(a.id),Xt.value=!0}catch(e){console.error("Error opening steps modal:",e),k("Ошибка загрузки подопераций","error")}finally{Yt.value=null}},Ms=async()=>{if(!Z.value?.title){k("Не выбрана работа для детализации","error");return}el.value=!0,fe.value=null;try{const a={};E.value.domain&&(a.domain=E.value.domain),E.value.action_type&&(a.action_type=E.value.action_type),E.value.constraints&&(a.constraints=E.value.constraints),E.value.site_state&&(a.site_state=E.value.site_state),E.value.material&&(a.material=E.value.material),E.value.object_type&&(a.object_type=E.value.object_type);const e=await yi(Z.value.title,a,Zt.value||al.value||void 0);fe.value=e}catch(a){console.error("AI decomposition error:",a);const e=a.response?.data?.message||a.message||"Ошибка AI генерации";k(e,"error")}finally{el.value=!1}},ia=async a=>{if(!(!fe.value||!Z.value)){tl.value=!0;try{const e=fe.value.steps.map(t=>({title:t.title,basis:t.basis,hours:t.hours,input_data:t.input_data||null,note:null}));a==="replace"?await x.put(`/api/projects/${_}/labor-works/${Z.value.id}/steps:replace`,{steps:e}):await x.post(`/api/projects/${_}/labor-works/${Z.value.id}/steps:append`,{steps:e}),await dt(Z.value.id),Sl.value="ai",k(a==="replace"?"Этапы заменены":"Этапы добавлены","success"),fe.value=null,Ke().catch(t=>console.warn("Background reload failed:",t))}catch(e){console.error("Apply AI steps error:",e),k(e.response?.data?.message||"Ошибка применения этапов","error")}finally{tl.value=!1}}},Ls=async()=>{if(!Z.value?.title||Ee.value.length===0)return;const a=bi(Z.value.title,Ee.value.map(t=>({title:t.title,hours:t.hours})));if(jl.value===a)return;const e=Sl.value||"manual";try{const t={};E.value.domain&&(t.domain=E.value.domain),E.value.action_type&&(t.action_type=E.value.action_type),E.value.constraints&&(t.constraints=E.value.constraints),E.value.site_state&&(t.site_state=E.value.site_state),await wi({title:Z.value.title,context:t,steps:Ee.value.map(n=>({title:n.title,basis:n.basis||"",hours:Number(n.hours),input_data:n.input_data||void 0})),source:e}),jl.value=a,console.log("Feedback sent successfully")}catch(t){console.warn("Feedback send failed (silent):",t)}},na=()=>{Ls(),Xt.value=!1},Dl=()=>{aa.value?.resetValidation?.(),xe.value=null,Gt.value=!1,le.value={title:"",basis:"",input_data:"",hours:0,note:""}},dt=async a=>{try{const e=await x.get(`/api/projects/${_}/labor-works/${a}/steps`);Ee.value=e.data||[]}catch(e){console.error("Error loading steps:",e),k("Ошибка загрузки подопераций","error")}},Es=async()=>{if(!le.value.title.trim()){k("Заполните наименование подоперации","error");return}if(le.value.hours<=0){k("Часы должны быть больше 0","error");return}Qt.value=!0;try{let a=Ee.value.length;if(xe.value){const t=Ee.value.find(n=>n.id===xe.value);t&&(a=t.sort_order??a)}const e={title:le.value.title.trim(),basis:le.value.basis?.trim()||null,input_data:le.value.input_data?.trim()||null,hours:parseFloat(String(le.value.hours))||0,note:le.value.note?.trim()||null,sort_order:a};xe.value?await x.put(`/api/projects/${_}/labor-works/${Z.value?.id}/steps/${xe.value}`,e,{timeout:6e4}):await x.post(`/api/projects/${_}/labor-works/${Z.value?.id}/steps`,e,{timeout:6e4}),await dt(Z.value?.id),Dl(),k(xe.value?"Подоперация обновлена":"Подоперация добавлена","success"),Ke().catch(t=>{console.warn("Background labor works reload failed:",t)})}catch(a){console.error("Error saving step:",a);try{await dt(Z.value?.id)}catch(t){console.warn("Failed to reload steps after save error:",t)}const e=a.response?.data?.message||a.message||"Ошибка сохранения подоперации";k(e,"error")}finally{Qt.value=!1}},Is=a=>{xe.value=a.id,le.value={title:a.title||"",basis:a.basis||"",input_data:a.input_data||"",hours:a.hours||0,note:a.note||""}},Ts=()=>{Dl()},Vt=f(null),Os=a=>{Vt.value=a.id},Rs=()=>{Vt.value=null},Ws=async a=>{if(!Vt.value||Vt.value===a.id)return;const e=[...Ee.value],t=e.findIndex(C=>C.id===Vt.value),n=e.findIndex(C=>C.id===a.id);if(t===-1||n===-1)return;const[p]=e.splice(t,1);e.splice(n,0,p);const j=e.map((C,N)=>({id:C.id,sort_order:N}));Ee.value=e.map((C,N)=>({...C,sort_order:N}));try{await x.patch(`/api/projects/${_}/labor-works/${Z.value?.id}/steps/reorder`,{steps:j}),k("Порядок подопераций обновлён","success")}catch(C){console.error("Error reordering steps:",C),await dt(Z.value?.id),k("Ошибка сортировки","error")}},Bs=async a=>{if(confirm(`Удалить подоперацию "${a.title}"?`))try{await x.delete(`/api/projects/${_}/labor-works/${Z.value?.id}/steps/${a.id}`,{timeout:6e4}),await dt(Z.value?.id),k("Подоперация удалена","success"),Ke().catch(e=>{console.warn("Background labor works reload failed:",e)})}catch(e){console.error("Error deleting step:",e);try{await dt(Z.value?.id)}catch(n){console.warn("Failed to reload steps after delete error:",n)}const t=e.response?.data?.message||e.message||"Ошибка удаления подоперации";k(t,"error")}},Ke=async()=>{try{O.value.laborWorks=!0;const a=await x.post(`/api/projects/${_}/labor-works/recalculate`,{mode:"preview"});if(a.data.success&&a.data.data.works)a.data.data.works.length>0&&(console.log("📋 Структура первой работы:",a.data.data.works[0]),console.log("📋 Все ключи работы:",Object.keys(a.data.data.works[0]))),Oe.value=a.data.data.works.map(e=>({...e,cost:e.cost_total??e.hours*(e.rate_per_hour||0)})),Pt.value=a.data.data.has_missing_rates??!1,a.data.data.has_missing_rates&&console.warn("⚠️ Есть работы без рассчитанных ставок (нет источников)");else{const e=await qt.getAll(Number(_));Oe.value=(e||[]).map(t=>{const n=t.rate_per_hour??(i.value.normohour_rate||0);return{...t,cost:t.cost_total??t.hours*n}}),Pt.value=!1}}catch(a){console.error("loadLaborWorks error",a),Pt.value=!1;try{const e=await qt.getAll(Number(_));Oe.value=(e||[]).map(t=>{const n=t.rate_per_hour??(i.value.normohour_rate||0);return{...t,cost:t.cost_total??t.hours*n}})}catch(e){console.error("loadLaborWorks fallback error",e)}}finally{O.value.laborWorks=!1}},Hs=()=>{window.open("/detail-types","_blank");const a=setInterval(async()=>{try{const e=await x.get("/api/detail-types").then(t=>t.data);m.value=e}catch(e){console.error("Ошибка обновления типов детали:",e)}},2e3);setTimeout(()=>clearInterval(a),300*1e3)};return ca(async()=>{await Bl(),await ge(),await Bt(),await At(1)}),(a,e)=>(v(),w(ie,null,[l($t,{class:"pa-0"},{default:s(()=>[l(va,{dark:"",class:"mb-4"},{default:s(()=>[l(fa,null,{default:s(()=>[r(" Проект #"+d(i.value.number)+" ",1),rt.value?(v(),$(te,{key:0,size:"small",color:"success",variant:"outlined",class:"ml-2","prepend-icon":"mdi-check-circle"},{default:s(()=>[r(" Ревизия #"+d(rt.value.number),1)]),_:1})):h("",!0)]),_:1}),l(Q),l(b,{size:"small",color:"secondary","prepend-icon":"mdi-file-pdf-box",loading:gt.value,disabled:gt.value,onClick:Ql,class:"mr-2"},{default:s(()=>[...e[104]||(e[104]=[r(" PDF ",-1)])]),_:1},8,["loading","disabled"]),l(b,{size:"small",color:"primary","prepend-icon":"mdi-camera",loading:It.value,disabled:It.value,onClick:ts,class:"mr-2",title:"Зафиксировать текущее состояние проекта"},{default:s(()=>[...e[105]||(e[105]=[r(" Snapshot ",-1)])]),_:1},8,["loading","disabled"]),l(b,{size:"small",color:"secondary","prepend-icon":"mdi-refresh",loading:_e.value,disabled:_e.value,onClick:za,class:"mr-2"},{default:s(()=>[...e[106]||(e[106]=[r(" Обновить ",-1)])]),_:1},8,["loading","disabled"]),l(b,{size:"small","prepend-icon":"mdi-cog",onClick:F},{default:s(()=>[...e[107]||(e[107]=[r(" Настройки ",-1)])]),_:1})]),_:1}),l(Bo,{"model-value":$e.value,project:i.value,regions:Y.value,materials:V.value,"onUpdate:modelValue":e[0]||(e[0]=t=>$e.value=t),onSaved:ml,onCancelled:vl,onError:nt},null,8,["model-value","project","regions","materials"]),l(vi,{modelValue:pe.value,"onUpdate:modelValue":e[1]||(e[1]=t=>pe.value=t),"project-id":i.value.id,onImported:Et},null,8,["modelValue","project-id"]),l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[...e[108]||(e[108]=[r("Содержимое проекта",-1)])]),_:1}),l(G,null,{default:s(()=>[l(ye,{class:"my-4"}),l(ee,null,{default:s(()=>[...e[109]||(e[109]=[r("Позиции",-1)])]),_:1}),l(b,{"prepend-icon":"mdi-plus",onClick:Pa},{default:s(()=>[...e[110]||(e[110]=[r("Добавить позицию",-1)])]),_:1}),l(b,{"prepend-icon":"mdi-file-import",class:"ml-2",variant:"outlined",onClick:e[2]||(e[2]=t=>pe.value=!0)},{default:s(()=>[...e[111]||(e[111]=[r("Импорт из Excel",-1)])]),_:1}),o("div",ki,[l(_a,{modelValue:Ce.value,"onUpdate:modelValue":e[3]||(e[3]=t=>Ce.value=t),mandatory:"",density:"compact",color:"primary",variant:"outlined"},{default:s(()=>[(v(),w(ie,null,be(Fe,t=>l(b,{key:t.value,value:t.value,size:"small"},{default:s(()=>[l(S,{start:"",size:"small"},{default:s(()=>[r(d(t.icon),1)]),_:2},1024),r(" "+d(t.label),1)]),_:2},1032,["value"])),64))]),_:1},8,["modelValue"]),l(Q),l(_a,{modelValue:me.value,"onUpdate:modelValue":e[4]||(e[4]=t=>me.value=t),mandatory:"",density:"compact",color:"secondary",variant:"outlined"},{default:s(()=>[l(b,{value:"compact",size:"small",title:"Компактный"},{default:s(()=>[l(S,{size:"small"},{default:s(()=>[...e[112]||(e[112]=[r("mdi-view-compact",-1)])]),_:1})]),_:1}),l(b,{value:"comfortable",size:"small",title:"Комфортный"},{default:s(()=>[l(S,{size:"small"},{default:s(()=>[...e[113]||(e[113]=[r("mdi-view-sequential",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),l(so,null,{default:s(()=>[ve.value.length>0?(v(),$(R,{key:0,class:"bulk-toolbar mt-3",variant:"outlined"},{default:s(()=>[l(G,{class:"py-2"},{default:s(()=>[o("div",xi,[l(te,{size:"small",color:"primary",variant:"tonal"},{default:s(()=>[r(" Выбрано: "+d(ve.value.length),1)]),_:1}),l(b,{size:"small",variant:"text",onClick:Ba},{default:s(()=>[...e[114]||(e[114]=[r("Выбрать все",-1)])]),_:1}),l(b,{size:"small",variant:"text",onClick:Hl},{default:s(()=>[...e[115]||(e[115]=[r("Снять выбор",-1)])]),_:1}),l(Q),o("div",hi,[l(Ve,{modelValue:u.value,"onUpdate:modelValue":e[5]||(e[5]=t=>u.value=t),items:Ta,label:"Действия",density:"compact",variant:"outlined","hide-details":""},null,8,["modelValue"]),u.value==="replace_material"?(v(),$(he,{key:0,modelValue:g.value,"onUpdate:modelValue":e[6]||(e[6]=t=>g.value=t),items:vt.value,"item-title":"name","item-value":"id",label:"Материал",density:"compact",variant:"outlined","hide-details":""},null,8,["modelValue","items"])):u.value==="replace_edge"?(v(),$(he,{key:1,modelValue:T.value,"onUpdate:modelValue":e[7]||(e[7]=t=>T.value=t),items:fl.value,"item-title":"name","item-value":"id",label:"Кромка",density:"compact",variant:"outlined","hide-details":""},null,8,["modelValue","items"])):u.value==="set_edge_scheme"?(v(),$(Ve,{key:2,modelValue:W.value,"onUpdate:modelValue":e[8]||(e[8]=t=>W.value=t),items:Ut,"item-title":"label","item-value":"value",label:"Обработка торцов",density:"compact",variant:"outlined","hide-details":""},null,8,["modelValue"])):u.value==="clear_field"?(v(),$(Ve,{key:3,modelValue:Te.value,"onUpdate:modelValue":e[9]||(e[9]=t=>Te.value=t),items:Oa,label:"Поле",density:"compact",variant:"outlined","hide-details":""},null,8,["modelValue"])):h("",!0),l(b,{color:"primary",disabled:!Ra.value,onClick:e[10]||(e[10]=t=>ot.value=!0),class:"ml-2"},{default:s(()=>[...e[116]||(e[116]=[r(" Применить ",-1)])]),_:1},8,["disabled"])])])]),_:1})]),_:1})):h("",!0)]),_:1}),o("div",{class:ct(["positions-table-wrap",{"density-comfortable":me.value==="comfortable"}]),ref_key:"positionsTableWrap",ref:ce},[O.value.positions&&c.value.length===0?(v(),$(tt,{key:0,type:"table"})):(v(),$(lt,{key:1,items:c.value,headers:re.value,"item-value":"id","show-select":"","model-value":B.value,"onUpdate:modelValue":Wa,density:me.value,"fixed-header":"",class:"positions-table positions-table-hover",loading:O.value.positions,"header-props":{style:"z-index: 100; position: sticky; top: 0px;"},"items-per-page":-1,"hide-default-footer":!0},{item:s(({item:t,index:n})=>[o("tr",{class:ct(["position-row",{"row-selected":B.value.includes(t.id),"row-hovered":ke.value===t.id,"row-highlighted":Se.value===t.id}]),"data-row-id":t.id,onMouseenter:p=>ke.value=t.id,onMouseleave:e[11]||(e[11]=p=>ke.value=null),onClick:p=>Ia(p,{item:t})},[o("td",null,[l(oo,{"model-value":B.value.includes(t.id),onClick:we(p=>jt(p,t.id,n),["stop","prevent"])},null,8,["model-value","onClick"])]),o("td",$i,[o("div",Ci,[o("div",Fi,d(t.custom_name||"—"),1),l(ga,{"row-id":t.id,"quick-actions":Qe(t),"menu-actions":Ne(t),visible:Ie(t.id),loading:bt.value===t.id,onAction:He},null,8,["row-id","quick-actions","menu-actions","visible","loading"])])]),re.value.some(p=>p.key==="detail_type")?(v(),w("td",Si,[o("div",ji,d(Tl(t.detail_type_id)),1)])):h("",!0),re.value.some(p=>p.key==="material_short")?(v(),w("td",Ui,[o("div",{class:"cell-ellipsis",title:yt(t.material_id)},d(yt(t.material_id)||"—"),9,Di)])):h("",!0),re.value.some(p=>p.key==="edge_material_short")?(v(),w("td",Ai,[o("div",{class:"cell-ellipsis",title:yt(t.edge_material_id)},d(yt(t.edge_material_id)||"—"),9,zi)])):h("",!0),re.value.some(p=>p.key==="size")?(v(),w("td",Pi,d(La(t)),1)):h("",!0),re.value.some(p=>p.key==="width")?(v(),w("td",Ni,d(t.width??"—"),1)):h("",!0),re.value.some(p=>p.key==="length")?(v(),w("td",qi,d(t.length??"—"),1)):h("",!0),re.value.some(p=>p.key==="quantity")?(v(),w("td",Mi,d(t.quantity??"—"),1)):h("",!0),re.value.some(p=>p.key==="edge_scheme")?(v(),w("td",Li,d(y(t.edge_scheme)),1)):h("",!0),re.value.some(p=>p.key==="area_total")?(v(),w("td",Ei,d(pt((t.width||0)/1e3*((t.length||0)/1e3)*(t.quantity||0),4)),1)):h("",!0),re.value.some(p=>p.key==="unit_price")?(v(),w("td",Ii,d(pt(t.unit_price||0,2)),1)):h("",!0),re.value.some(p=>p.key==="total_price")?(v(),w("td",Ti,d(pt((t.unit_price||0)*(t.quantity||0),2)),1)):h("",!0)],42,Vi)]),_:1},8,["items","headers","model-value","density","loading"]))],2),l(ya,{modelValue:ne.value,"onUpdate:modelValue":e[27]||(e[27]=t=>ne.value=t),location:"right",width:"420",temporary:""},{default:s(()=>[l(va,{flat:""},{default:s(()=>[l(fa,null,{default:s(()=>[...e[117]||(e[117]=[r("Детали позиции",-1)])]),_:1}),l(Q),l(b,{icon:"mdi-close",variant:"text",onClick:e[12]||(e[12]=t=>ne.value=!1)})]),_:1}),l(ye),q.value?(v(),$($t,{key:0,class:"pa-4 position-drawer"},{default:s(()=>[l(D,{modelValue:q.value.custom_name,"onUpdate:modelValue":e[13]||(e[13]=t=>q.value.custom_name=t),label:"Название",density:"comfortable",onBlur:e[14]||(e[14]=()=>Je(q.value,"custom_name",q.value.custom_name))},null,8,["modelValue"]),l(he,{modelValue:q.value.detail_type_id,"onUpdate:modelValue":[e[15]||(e[15]=t=>q.value.detail_type_id=t),e[16]||(e[16]=t=>Je(q.value,"detail_type_id",t))],items:m.value,"item-title":"name","item-value":"id",label:"Тип детали",clearable:"",density:"comfortable",class:"mb-2"},null,8,["modelValue","items"]),l(he,{modelValue:q.value.material_id,"onUpdate:modelValue":[e[17]||(e[17]=t=>q.value.material_id=t),e[18]||(e[18]=t=>Je(q.value,"material_id",t))],items:vt.value,"item-title":"name","item-value":"id",label:"Материал",density:"comfortable",class:"mb-2"},null,8,["modelValue","items"]),l(ae,null,{default:s(()=>[l(A,{cols:"6"},{default:s(()=>[l(D,{"model-value":Math.round(q.value.width||0),label:"Ширина, мм",density:"comfortable",onBlur:e[19]||(e[19]=t=>Je(q.value,"width",t.target.value))},null,8,["model-value"])]),_:1}),l(A,{cols:"6"},{default:s(()=>[l(D,{"model-value":Math.round(q.value.length||0),label:"Длина, мм",density:"comfortable",onBlur:e[20]||(e[20]=t=>Je(q.value,"length",t.target.value))},null,8,["model-value"])]),_:1})]),_:1}),l(D,{modelValue:q.value.quantity,"onUpdate:modelValue":e[21]||(e[21]=t=>q.value.quantity=t),modelModifiers:{number:!0},label:"Кол-во",type:"number",density:"comfortable",onBlur:e[22]||(e[22]=()=>Je(q.value,"quantity",q.value.quantity))},null,8,["modelValue"]),l(Ve,{modelValue:q.value.edge_scheme,"onUpdate:modelValue":[e[23]||(e[23]=t=>q.value.edge_scheme=t),e[24]||(e[24]=t=>Ea(q.value,t))],items:Ut,"item-title":"label","item-value":"value",label:"Обработка торцов",density:"comfortable",class:"mb-2"},null,8,["modelValue"]),q.value.edge_scheme&&q.value.edge_scheme!=="none"?(v(),$(he,{key:0,modelValue:q.value.edge_material_id,"onUpdate:modelValue":[e[25]||(e[25]=t=>q.value.edge_material_id=t),e[26]||(e[26]=t=>Je(q.value,"edge_material_id",t))],items:fl.value,"item-title":"name","item-value":"id",label:"Кромка",density:"comfortable"},null,8,["modelValue","items"])):h("",!0),l(ye,{class:"my-4"}),e[119]||(e[119]=o("div",{class:"text-subtitle-2 mb-2"},"История изменений",-1)),l(We,{type:"info",variant:"tonal",density:"compact"},{default:s(()=>[...e[118]||(e[118]=[r(" История изменений пока недоступна. ",-1)])]),_:1})]),_:1})):(v(),$($t,{key:1,class:"pa-4"},{default:s(()=>[l(We,{type:"info",variant:"tonal"},{default:s(()=>[...e[120]||(e[120]=[r("Выберите позицию в таблице.",-1)])]),_:1})]),_:1}))]),_:1},8,["modelValue"]),l(Pe,{modelValue:ot.value,"onUpdate:modelValue":e[29]||(e[29]=t=>ot.value=t),"max-width":"480"},{default:s(()=>[l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[...e[121]||(e[121]=[r("Подтверждение",-1)])]),_:1}),l(G,null,{default:s(()=>[r(" Применить действие к "+d(ve.value.length)+" позициям? ",1)]),_:1}),l(De,null,{default:s(()=>[l(Q),l(b,{variant:"text",onClick:e[28]||(e[28]=t=>ot.value=!1)},{default:s(()=>[...e[122]||(e[122]=[r("Отмена",-1)])]),_:1}),l(b,{color:"primary",onClick:Ja},{default:s(()=>[...e[123]||(e[123]=[r("Подтвердить",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ye,{class:"my-4"}),l(ee,null,{default:s(()=>[e[124]||(e[124]=r(" Материалы ",-1)),l(Q),o("div",null,"Итого: "+d($s.value.toFixed(2))+" ₽",1)]),_:1}),Ye.value.length>0?(v(),$(Al,{key:0,class:"mt-2"},{default:s(()=>[o("div",Oi,[o("div",null,[e[126]||(e[126]=o("span",null,"Плитные материалы",-1)),i.value.apply_waste_to_plate?h("",!0):(v(),$(te,{key:0,size:"small",variant:"filled",color:"warning",class:"ml-2"},{default:s(()=>[...e[125]||(e[125]=[r(" Коэффициент отключен ",-1)])]),_:1}))]),l(te,{size:"small",variant:"outlined",color:"info"},{default:s(()=>[r(d(i.value.use_area_calc_mode?"Расчёт по площади":"Расчёт по листам"),1)]),_:1})])]),_:1})):h("",!0),O.value.materials&&Ye.value.length===0?(v(),$(tt,{key:1,type:"table"})):Ye.value.length>0?(v(),$(lt,{key:2,items:Ye.value,headers:ka.value,density:"comfortable",class:"mb-4","show-expand":""},{"header.price_per_m2":s(({column:t})=>[l(Pl,{text:"Цена рассчитана из цены листа"},{activator:s(({props:n})=>[o("span",ql(n,{class:"cursor-help"}),[r(d(t.title)+" ",1),l(te,{size:"x-small",variant:"text",color:"grey-darken-1"},{default:s(()=>[...e[127]||(e[127]=[r("расч.",-1)])]),_:1})],16)]),_:2},1024)]),"item.area_details":s(({item:t})=>[r(d(t.area_details.toFixed(2)),1)]),"item.waste_coeff":s(({item:t})=>[r(d((Number(t.waste_coeff)||1).toFixed(2)),1)]),"item.area_with_waste":s(({item:t})=>[r(d(t.area_with_waste.toFixed(2)),1)]),"item.sheet_area":s(({item:t})=>[!i.value.use_area_calc_mode&&t.sheet_area>0?(v(),$(Pl,{key:0,text:`${(t.sheet_area*1e6).toFixed(0)} мм²`},{activator:s(({props:n})=>[o("span",il(nl(n)),d(t.sheet_area.toFixed(4)),17)]),_:2},1032,["text"])):i.value.use_area_calc_mode?h("",!0):(v(),w("span",Ri,"—"))]),"item.sheets_count":s(({item:t})=>[i.value.use_area_calc_mode?(v(),w("span",Bi,d(t.area_with_waste.toFixed(2))+" м²",1)):(v(),w("span",Wi,d(t.sheets_count),1))]),"item.price_per_sheet":s(({item:t})=>[i.value.use_area_calc_mode?h("",!0):(v(),w("span",Hi,d((Number(t.price_per_sheet)||0).toFixed(2))+" ₽ ",1))]),"item.price_per_m2":s(({item:t})=>[i.value.use_area_calc_mode?(v(),w("span",Ji,d((Number(t.price_per_m2)||0).toFixed(2))+" ₽/м² ",1)):h("",!0)]),"item.total_price":s(({item:t})=>[i.value.use_area_calc_mode?(v(),w("span",Xi,d((t.area_with_waste*(Number(t.price_per_m2)||0)).toFixed(2))+" ₽ ",1)):(v(),w("span",Ki,d((t.sheets_count*(Number(t.price_per_sheet)||0)).toFixed(2))+" ₽ ",1))]),"expanded-row":s(({columns:t,item:n})=>[o("tr",null,[o("td",{colspan:t.length,class:"pa-4"},[l($t,{class:"pa-0"},{default:s(()=>[l(ae,null,{default:s(()=>[l(A,{cols:"12"},{default:s(()=>[...e[128]||(e[128]=[o("div",{class:"text-subtitle-2 mb-2"},[o("strong",null,"Формула расчёта:")],-1)])]),_:1})]),_:1}),l(ae,null,{default:s(()=>[l(A,{cols:"12",md:"6"},{default:s(()=>[o("div",Gi,[o("div",null,[e[129]||(e[129]=r("Площадь деталей: ",-1)),o("strong",null,d(n.area_details.toFixed(2))+" м²",1)]),o("div",null,[e[130]||(e[130]=r("Коэф. отходов: ",-1)),o("strong",null,d((Number(n.waste_coeff)||1).toFixed(2)),1)]),o("div",null,[e[131]||(e[131]=r("Площадь с отходами: ",-1)),o("strong",null,d(n.area_with_waste.toFixed(2))+" м²",1)]),i.value.use_area_calc_mode?(v(),w(ie,{key:1},[o("div",tn,[e[139]||(e[139]=o("div",{class:"text-subtitle-2 mb-2"},[o("strong",null,"Основной расчёт:")],-1)),o("div",null,[e[136]||(e[136]=r("Площадь к оплате: ",-1)),o("strong",null,d(n.area_with_waste.toFixed(2))+" м²",1)]),o("div",null,[e[137]||(e[137]=r("Цена за м² (расч.): ",-1)),o("strong",null,d(n.price_per_m2.toFixed(2))+" ₽/м²",1)]),o("div",ln,[e[138]||(e[138]=r("Итого: ",-1)),o("strong",null,d(n.area_with_waste.toFixed(2))+" × "+d(n.price_per_m2.toFixed(2))+" = "+d((n.area_with_waste*n.price_per_m2).toFixed(2))+" ₽",1)])]),o("div",an,[e[140]||(e[140]=o("div",{class:"mb-2"},[o("strong",null,"Справочные данные:")],-1)),o("div",null,"Размер листа: "+d(n.sheet_area.toFixed(4))+" м²",1),o("div",null,"Цена за лист: "+d((Number(n.price_per_sheet)||0).toFixed(2))+" ₽",1),e[141]||(e[141]=o("div",{class:"mt-2"},"Цена за м² получена расчётным путём из цены листа:",-1)),o("div",null,d((Number(n.price_per_sheet)||0).toFixed(2))+" ₽ / "+d(n.sheet_area.toFixed(4))+" м² = "+d(n.price_per_m2.toFixed(2))+" ₽/м²",1)])],64)):(v(),w(ie,{key:0},[o("div",null,[e[132]||(e[132]=r("Площадь листа: ",-1)),o("strong",null,d(n.sheet_area.toFixed(4))+" м²",1)]),o("div",Yi,[e[133]||(e[133]=r("Листов: ",-1)),o("strong",null,"ceil("+d(n.area_with_waste.toFixed(2))+" / "+d(n.sheet_area.toFixed(4))+") = "+d(n.sheets_count),1)]),o("div",Zi,[e[134]||(e[134]=r("Цена за м²: ",-1)),o("strong",null,d(n.price_per_m2.toFixed(2))+" ₽/м²",1)]),o("div",en,[e[135]||(e[135]=r("Итого: ",-1)),o("strong",null,d(n.sheets_count)+" × "+d((Number(n.price_per_sheet)||0).toFixed(2))+" = "+d((n.sheets_count*(Number(n.price_per_sheet)||0)).toFixed(2))+" ₽",1)])],64))])]),_:2},1024),n.updated_at?(v(),$(A,{key:0,cols:"12",md:"6"},{default:s(()=>[e[145]||(e[145]=o("div",{class:"text-subtitle-2 mb-2"},[o("strong",null,"Источник цены:")],-1)),o("div",sn,[o("div",null,[e[142]||(e[142]=r("Дата обновления: ",-1)),o("strong",null,d(new Date(n.updated_at).toLocaleDateString("ru-RU")),1)]),n.source_url?(v(),w("div",on,[l(b,{href:n.source_url,target:"_blank",size:"small",variant:"text",color:"primary","prepend-icon":"mdi-link-variant"},{default:s(()=>[...e[143]||(e[143]=[r(" Перейти на страницу материала ",-1)])]),_:1},8,["href"])])):h("",!0),e[144]||(e[144]=o("div",{class:"text-caption text-grey mt-2"},"Цена актуальна на указанную дату",-1))])]),_:2},1024)):h("",!0)]),_:2},1024)]),_:2},1024)],8,Qi)])]),_:1},8,["items","headers"])):h("",!0),Ze.value.length>0?(v(),$(Al,{key:3,class:"mt-2"},{default:s(()=>[o("div",nn,[e[147]||(e[147]=o("span",null,"Кромка",-1)),i.value.apply_waste_to_edge?h("",!0):(v(),$(te,{key:0,size:"small",variant:"filled",color:"warning"},{default:s(()=>[...e[146]||(e[146]=[r(" Коэффициент отключен ",-1)])]),_:1}))])]),_:1})):h("",!0),O.value.materials&&Ze.value.length===0?(v(),$(tt,{key:4,type:"table"})):Ze.value.length>0?(v(),$(lt,{key:5,items:Ze.value,headers:ha,density:"comfortable","show-expand":""},{"item.length_linear":s(({item:t})=>[r(d(t.length_linear.toFixed(2)),1)]),"item.waste_coeff":s(({item:t})=>[r(d((Number(t.waste_coeff)||1).toFixed(2)),1)]),"item.length_with_waste":s(({item:t})=>[r(d(t.length_with_waste.toFixed(2)),1)]),"item.price_per_unit":s(({item:t})=>[r(d((Number(t.price_per_unit)||0).toFixed(2))+" ₽ ",1)]),"item.total_price":s(({item:t})=>[r(d((t.length_with_waste*(Number(t.price_per_unit)||0)).toFixed(2))+" ₽ ",1)]),"expanded-row":s(({columns:t,item:n})=>[o("tr",null,[o("td",{colspan:t.length,class:"pa-4"},[l($t,{class:"pa-0"},{default:s(()=>[l(ae,null,{default:s(()=>[l(A,{cols:"12"},{default:s(()=>[...e[148]||(e[148]=[o("div",{class:"text-subtitle-2 mb-3"},[o("strong",null,"Расчёт длины кромки:")],-1)])]),_:1})]),_:1}),l(ae,null,{default:s(()=>[l(A,{cols:"12"},{default:s(()=>[l(St,{class:"border-table"},{default:s(()=>[e[150]||(e[150]=o("thead",null,[o("tr",null,[o("th",null,"Позиция"),o("th",null,"Размер детали (мм)"),o("th",null,"Обработка торцов"),o("th",null,"Периметр одной (м)"),o("th",null,"Количество"),o("th",null,"Итого длина (м)")])],-1)),o("tbody",null,[(v(!0),w(ie,null,be(Ol(n.id),p=>(v(),w("tr",{key:p.position_id},[o("td",null,d(p.position_name),1),o("td",null,d(p.width)+" × "+d(p.length),1),o("td",null,d(p.edge_scheme_label),1),o("td",null,d(p.perimeter_one.toFixed(4)),1),o("td",null,d(p.quantity),1),o("td",null,[o("strong",null,d(p.total_length.toFixed(2)),1)])]))),128))]),o("tfoot",null,[o("tr",null,[e[149]||(e[149]=o("td",{colspan:"5"},[o("strong",null,"Всего:")],-1)),o("td",null,[o("strong",null,d(n.length_linear.toFixed(2))+" м",1)])])])]),_:2},1024)]),_:2},1024)]),_:2},1024),l(ae,{class:"mt-4"},{default:s(()=>[l(A,{cols:"12",md:"6"},{default:s(()=>[o("div",un,[o("div",null,[e[151]||(e[151]=r("Коэффициент отходов: ",-1)),o("strong",null,d((Number(n.waste_coeff)||1).toFixed(2)),1)]),o("div",dn,[e[152]||(e[152]=r("Расчёт: ",-1)),o("strong",null,d(n.length_linear.toFixed(2))+" × "+d((Number(n.waste_coeff)||1).toFixed(2))+" = "+d(n.length_with_waste.toFixed(2))+" м",1)]),e[153]||(e[153]=o("div",{class:"text-caption"},[o("strong",null,"Примечание:"),r(' Коэффициент применяется к материалу и операции кромкооблицовки. Стоимость операции "Кромкооблицовка" будет рассчитана с использованием этого же коэффициента. ')],-1))])]),_:2},1024)]),_:2},1024)]),_:2},1024)],8,rn)])]),_:1},8,["items"])):h("",!0),l(ye,{class:"my-4"}),l(ee,null,{default:s(()=>[e[154]||(e[154]=r(" Операции ",-1)),l(Q),o("div",null,"Итого: "+d(Cs.value.toFixed(2))+" ₽",1)]),_:1}),l(b,{"prepend-icon":"mdi-plus",onClick:Fs,class:"mb-2"},{default:s(()=>[...e[155]||(e[155]=[r("Добавить операцию",-1)])]),_:1}),O.value.operations?(v(),$(tt,{key:6,type:"table"})):(v(),$(lt,{key:7,expanded:[$l.value],items:Jt.value,headers:ms,density:"comfortable","show-expand":"","item-value":"id","onClick:row":e[30]||(e[30]=(t,{item:n,expand:p})=>{p&&($l.value.value=$l.value.value===n.id?null:n.id)})},{"item.quantity_display":s(({item:t})=>[r(d((typeof t.quantity=="number"?t.quantity:parseFloat(t.quantity||0)).toFixed(2)),1)]),"item.name":s(({item:t})=>[o("div",cn,[o("span",null,d(t.name),1),t.is_manual?h("",!0):(v(),$(S,{key:0,size:"18",color:"blue"},{default:s(()=>[...e[156]||(e[156]=[r("mdi-robot",-1)])]),_:1}))])]),"item.cost_per_unit":s(({item:t})=>[o("div",null,d(parseFloat(t.cost_per_unit||0).toFixed(2))+" ₽",1)]),"item.total_cost":s(({item:t})=>[r(d(parseFloat(t.total_cost).toFixed(2))+" ₽ ",1)]),"item.source":s(({item:t})=>[l(te,{size:"small",color:t.is_manual?"primary":"success",variant:"flat"},{default:s(()=>[r(d(t.is_manual?"Ручная":"Авто"),1)]),_:2},1032,["color"])]),"item.actions":s(({item:t})=>[t.is_manual?(v(),$(S,{key:0,onClick:n=>js(t),class:"me-2",color:"primary"},{default:s(()=>[...e[157]||(e[157]=[r(" mdi-pencil ",-1)])]),_:1},8,["onClick"])):h("",!0),t.is_manual?(v(),$(S,{key:1,onClick:n=>Us(t),color:"error",icon:"mdi-delete"},null,8,["onClick"])):h("",!0)]),"expanded-row":s(({columns:t,item:n})=>[o("tr",null,[o("td",{colspan:t.length,class:"pa-4"},[l($t,{class:"pa-0"},{default:s(()=>[l(ae,null,{default:s(()=>[l(A,{cols:"12"},{default:s(()=>[o("div",mn,[o("strong",null,'Расчёт операции "'+d(n.name)+'":',1)])]),_:2},1024)]),_:2},1024),ue(n).type==="edging"?(v(),w(ie,{key:0},[l(ae,null,{default:s(()=>[l(A,{cols:"12"},{default:s(()=>[l(St,{class:"border-table"},{default:s(()=>[e[159]||(e[159]=o("thead",null,[o("tr",null,[o("th",null,"Позиция / Материал"),o("th",null,"Длина (м)")])],-1)),o("tbody",null,[(v(!0),w(ie,null,be(ue(n).details,p=>(v(),w("tr",{key:`${p.position_name}-${p.material_name}`},[o("td",null,[o("div",null,d(p.position_name),1),o("div",vn,d(p.material_name),1)]),o("td",null,d(p.length.toFixed(2)),1)]))),128))]),o("tfoot",null,[o("tr",null,[e[158]||(e[158]=o("td",null,[o("strong",null,"Итого:")],-1)),o("td",null,[o("strong",null,d(ue(n).total_length.toFixed(2))+" м",1)])])])]),_:2},1024)]),_:2},1024)]),_:2},1024),l(ae,{class:"mt-3"},{default:s(()=>[l(A,{cols:"12"},{default:s(()=>[o("div",fn,[o("div",null,[e[160]||(e[160]=r("Коэффициент проекта: ",-1)),o("strong",null,d((Number(ue(n).waste_coeff)||1).toFixed(2)),1)]),o("div",_n,[e[161]||(e[161]=r("К оплате: ",-1)),o("strong",null,d(ue(n).total_with_waste.toFixed(2))+" м.п.",1)]),o("div",gn," ("+d(ue(n).total_length.toFixed(2))+" × "+d((Number(ue(n).waste_coeff)||1).toFixed(2))+" = "+d(ue(n).total_with_waste.toFixed(2))+" м.п.) ",1)])]),_:2},1024)]),_:2},1024)],64)):ue(n).type==="sawing"?(v(),$(ae,{key:1},{default:s(()=>[l(A,{cols:"12"},{default:s(()=>[o("div",yn,d(ue(n).note),1),l(St,{class:"border-table"},{default:s(()=>[e[163]||(e[163]=o("thead",null,[o("tr",null,[o("th",null,"Материал"),o("th",null,"Площадь (м²)")])],-1)),o("tbody",null,[(v(!0),w(ie,null,be(ue(n).details,p=>(v(),w("tr",{key:p.material_name},[o("td",null,d(p.material_name),1),o("td",null,d(p.area.toFixed(2)),1)]))),128))]),o("tfoot",null,[o("tr",null,[e[162]||(e[162]=o("td",null,[o("strong",null,"Итого:")],-1)),o("td",null,[o("strong",null,d(ue(n).total_area.toFixed(2))+" м²",1)])])])]),_:2},1024)]),_:2},1024)]),_:2},1024)):ue(n).type==="drilling"?(v(),$(ae,{key:2},{default:s(()=>[l(A,{cols:"12"},{default:s(()=>[ue(n).details&&ue(n).details.length>0?(v(),$(St,{key:0,class:"border-table"},{default:s(()=>[e[165]||(e[165]=o("thead",null,[o("tr",null,[o("th",null,"Тип детали"),o("th",null,"Отверстий на деталь"),o("th",null,"Количество деталей"),o("th",null,"Всего отверстий")])],-1)),o("tbody",null,[(v(!0),w(ie,null,be(ue(n).details,p=>(v(),w("tr",{key:p.detail_type_name},[o("td",null,d(p.detail_type_name),1),o("td",null,d(p.holes_per_piece),1),o("td",null,d(p.quantity),1),o("td",null,d(p.total_holes),1)]))),128))]),o("tfoot",null,[o("tr",null,[e[164]||(e[164]=o("td",{colspan:"3"},[o("strong",null,"Итого:")],-1)),o("td",null,[o("strong",null,d(ue(n).total_holes)+" шт",1)])])])]),_:2},1024)):(v(),$(We,{key:1,type:"info",variant:"tonal"},{default:s(()=>[r(d(ue(n).message),1)]),_:2},1024))]),_:2},1024)]),_:2},1024)):(v(),$(ae,{key:3},{default:s(()=>[l(A,{cols:"12"},{default:s(()=>[l(We,{type:"info",variant:"tonal"},{default:s(()=>[r(d(ue(n).message),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))]),_:2},1024)],8,pn)])]),_:1},8,["expanded","items"])),l(ye,{class:"my-4"}),l(ee,null,{default:s(()=>[...e[166]||(e[166]=[r("Фурнитура",-1)])]),_:1}),l(b,{"prepend-icon":"mdi-plus",onClick:Ka},{default:s(()=>[...e[167]||(e[167]=[r("Добавить фурнитуру",-1)])]),_:1}),O.value.fittings?(v(),$(tt,{key:8,type:"table",class:"mt-3"})):(v(),$(lt,{key:9,items:de.value,headers:ba},{"item.actions":s(({item:t})=>[l(S,{onClick:we(n=>Xa(t),["stop"]),class:"me-2"},{default:s(()=>[...e[168]||(e[168]=[r("mdi-pencil",-1)])]),_:1},8,["onClick"]),l(S,{onClick:we(n=>Ga(t),["stop"])},{default:s(()=>[...e[169]||(e[169]=[r("mdi-delete",-1)])]),_:1},8,["onClick"])]),_:1},8,["items"])),l(ye,{class:"my-4"}),l(ee,null,{default:s(()=>[e[170]||(e[170]=r(" Нормируемые работы ",-1)),l(Q),o("div",null,"Итого: "+d((typeof sa.value=="number"?sa.value:0).toFixed(2))+" ₽",1)]),_:1}),Pt.value?(v(),$(We,{key:10,type:"warning",variant:"tonal",class:"mb-3",closable:""},{default:s(()=>[...e[171]||(e[171]=[o("strong",null,"⚠ Не все профили имеют установленные ставки",-1),r(' — нажмите "Пересчитать ставки" для автоматического расчета или установите значения вручную. ',-1)])]),_:1})):h("",!0),l(b,{"prepend-icon":"mdi-plus",onClick:zs,class:"mb-3"},{default:s(()=>[...e[172]||(e[172]=[r("Добавить работу",-1)])]),_:1}),l(b,{"prepend-icon":"mdi-refresh",onClick:Ds,class:"mb-3 ms-3",variant:"outlined",loading:sl.value,disabled:sl.value},{default:s(()=>[...e[173]||(e[173]=[r(" Пересчитать ставки ",-1)])]),_:1},8,["loading","disabled"]),l(b,{"prepend-icon":Nt.value?"mdi-lock":"mdi-lock-open",onClick:As,class:"mb-3 ms-3",variant:"outlined",color:Nt.value?"success":"warning",loading:ol.value,disabled:ol.value},{default:s(()=>[r(d(Nt.value?"Ставки заблокированы":"Заблокировать ставки"),1)]),_:1},8,["prepend-icon","color","loading","disabled"]),Nt.value?(v(),$(te,{key:11,color:"success","text-color":"white","prepend-icon":"mdi-check-circle",class:"mb-3 ms-3"},{default:s(()=>[...e[174]||(e[174]=[r(" Заблокирована ",-1)])]),_:1})):(v(),$(te,{key:12,color:"warning","text-color":"white","prepend-icon":"mdi-alert-circle",class:"mb-3 ms-3"},{default:s(()=>[...e[175]||(e[175]=[r(" Не заблокирована ",-1)])]),_:1})),O.value.laborWorks?(v(),$(tt,{key:13,type:"table"})):(v(),$(lt,{key:14,items:Oe.value,headers:xs,density:"comfortable","item-value":"id",class:"mb-4"},{"item.title":s(({item:t})=>[o("div",{class:"cell-with-actions",onMouseenter:n=>Ul.value=t.id,onMouseleave:e[31]||(e[31]=n=>Ul.value=null)},[o("div",bn,[o("div",kn,d(t.title||"—"),1),l(ga,{"row-id":t.id,"quick-actions":ys(t),"menu-actions":ws(t),visible:ks(t.id),"loading-key":Yt.value===t.id?"details":null,onAction:bs},null,8,["row-id","quick-actions","menu-actions","visible","loading-key"])])],40,wn)]),"item.basis":s(({item:t})=>[r(d(t.basis||"—"),1)]),"item.hours":s(({item:t})=>[r(d(typeof t.hours=="number"?t.hours.toFixed(2):parseFloat(t.hours||0).toFixed(2)),1)]),"item.rate":s(({item:t})=>[o("div",null,d((parseFloat(t.rate_per_hour)||0).toFixed(2))+" ₽/ч",1)]),"item.cost":s(({item:t})=>[o("div",null,[o("strong",null,d((parseFloat(t.cost_total)||0).toFixed(2))+" ₽",1)])]),"no-data":s(()=>[...e[176]||(e[176]=[o("div",{class:"text-center py-8 text-grey"}," Монтажно-сборочные работы не добавлены ",-1)])]),_:1},8,["items"])),l(ye,{class:"my-4"}),l(ee,null,{default:s(()=>[e[177]||(e[177]=r("Накладные расходы ",-1)),o("div",null,"Итого: "+d((Array.isArray(U.value)?U.value.reduce((t,n)=>t+(parseFloat(n.amount)||0),0):0).toFixed(2))+" ₽",1)]),_:1}),o("div",xn,[l(b,{"prepend-icon":"mdi-plus",onClick:us},{default:s(()=>[...e[178]||(e[178]=[r("Добавить расход",-1)])]),_:1})]),O.value.expenses?(v(),$(tt,{key:15,type:"table"})):(v(),$(lt,{key:16,items:U.value,headers:Va},{"item.amount":s(({item:t})=>[r(d(Number(t.amount||0).toFixed(2))+" ₽ ",1)]),"item.actions":s(({item:t})=>[l(S,{onClick:we(n=>ds(t),["stop"]),class:"me-2"},{default:s(()=>[...e[179]||(e[179]=[r("mdi-pencil",-1)])]),_:1},8,["onClick"]),l(S,{onClick:we(n=>ps(t),["stop"])},{default:s(()=>[...e[180]||(e[180]=[r("mdi-delete",-1)])]),_:1},8,["onClick"])]),_:1},8,["items"])),l(ye,{class:"my-4"}),l(ee,null,{default:s(()=>[...e[181]||(e[181]=[r("Ревизии",-1)])]),_:1}),l(Al,{class:"mb-2"},{default:s(()=>[e[182]||(e[182]=r(" Последняя ревизия: ",-1)),rt.value?(v(),w("span",hn,"#"+d(rt.value.number)+", "+d(Vl(rt.value.status)),1)):(v(),w("span",Vn,"нет"))]),_:1}),gl.value?(v(),$(tt,{key:17,type:"table"})):(v(),$(lt,{key:18,items:_l.value,headers:$a,"item-key":"id"},{"item.status":s(({item:t})=>[l(te,{size:"small",color:Gl(t.status),variant:"outlined"},{default:s(()=>[r(d(Vl(t.status)),1)]),_:2},1032,["color"])]),"item.created_at":s(({item:t})=>[r(d(Yl(t.created_at)),1)]),"item.snapshot_hash":s(({item:t})=>[t.snapshot_hash?(v(),w("span",$n,d(Zl(t.snapshot_hash)),1)):(v(),w("span",Cn,"—"))]),"item.created_by":s(({item:t})=>[t.created_by?.name?(v(),w("span",Fn,d(t.created_by.name),1)):t.createdBy?.name?(v(),w("span",Sn,d(t.createdBy.name),1)):(v(),w("span",jn,"—"))]),"item.actions":s(({item:t})=>[o("div",Un,[l(b,{size:"x-small",variant:"text",icon:"mdi-eye",title:"Просмотр",onClick:n=>ss(t)},null,8,["onClick"]),l(b,{size:"x-small",variant:"text",icon:"mdi-file-pdf-box",title:"PDF",disabled:t.status==="stale",onClick:n=>os(t)},null,8,["disabled","onClick"]),l(b,{size:"x-small",variant:"text",icon:"mdi-cloud-upload",title:"Опубликовать",disabled:!ls(t),onClick:n=>is(t)},null,8,["disabled","onClick"]),l(b,{size:"x-small",variant:"text",icon:"mdi-cloud-off-outline",title:"Снять публикацию",disabled:!as(t),onClick:n=>ns(t)},null,8,["disabled","onClick"]),l(b,{size:"x-small",variant:"text",icon:"mdi-fingerprint",title:"Копировать fingerprint",disabled:t.status==="stale",onClick:n=>rs(t)},null,8,["disabled","onClick"])])]),"no-data":s(()=>[...e[183]||(e[183]=[o("div",{class:"text-center py-6 text-grey"}," Ревизии не найдены ",-1)])]),_:1},8,["items"])),qe.lastPage>1?(v(),w("div",Dn,[l(io,{modelValue:qe.page,"onUpdate:modelValue":[e[32]||(e[32]=t=>qe.page=t),At],length:qe.lastPage},null,8,["modelValue","length"])])):h("",!0),l(ye,{class:"my-4"}),l(b,{color:"secondary",onClick:Ql,loading:gt.value,disabled:gt.value},{default:s(()=>[...e[184]||(e[184]=[r("Генерировать PDF",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1}),l(Pe,{modelValue:Tt.value,"onUpdate:modelValue":e[34]||(e[34]=t=>Tt.value=t),"max-width":"900"},{default:s(()=>[l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[r(" Ревизия #"+d(ut.value?.number||"—"),1)]),_:1}),l(G,null,{default:s(()=>[o("div",An,[l(te,{size:"small",color:Gl(ut.value?.status),variant:"outlined"},{default:s(()=>[r(d(Vl(ut.value?.status)),1)]),_:1},8,["color"]),l(te,{size:"small",variant:"outlined"},{default:s(()=>[r(d(Yl(ut.value?.created_at)),1)]),_:1}),l(te,{size:"small",variant:"outlined"},{default:s(()=>[r(d(ut.value?.snapshot_hash?Zl(ut.value.snapshot_hash):"—"),1)]),_:1})]),e[186]||(e[186]=o("div",{class:"text-subtitle-2 mb-2"},"Снимок (read-only)",-1)),l(no,{variant:"accordion"},{default:s(()=>[l(ro,null,{default:s(()=>[l(uo,null,{default:s(()=>[...e[185]||(e[185]=[r("Показать JSON",-1)])]),_:1}),l(co,null,{default:s(()=>[o("pre",null,d(yl.value),1)]),_:1})]),_:1})]),_:1})]),_:1}),l(De,null,{default:s(()=>[l(Q),l(b,{variant:"text",onClick:e[33]||(e[33]=t=>Tt.value=!1)},{default:s(()=>[...e[187]||(e[187]=[r("Закрыть",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Pe,{modelValue:Dt.value,"onUpdate:modelValue":e[47]||(e[47]=t=>Dt.value=t),"max-width":"700"},{default:s(()=>[l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[r(d(bl.value?"Редактировать позицию":"Новая позиция"),1)]),_:1}),l(G,null,{default:s(()=>[l(rl,{ref_key:"positionForm",ref:Il},{default:s(()=>[l(he,{modelValue:L.value.detail_type_id,"onUpdate:modelValue":[e[36]||(e[36]=t=>L.value.detail_type_id=t),Fa],items:m.value,"item-title":"name","item-value":"id",label:"Тип детали",clearable:"",density:"comfortable",class:"mb-3"},{"append-inner":s(()=>[l(b,{icon:"mdi-plus",size:"x-small",variant:"tonal",color:"primary",onClick:we(Hs,["stop"]),title:"Создать новый тип детали"})]),"append-item":s(()=>[l(Ft,{onClick:e[35]||(e[35]=t=>a.$router.push("/detail-types"))},{default:s(()=>[l(Ml,null,{default:s(()=>[...e[188]||(e[188]=[r("Управление типами",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue","items"]),l(he,{modelValue:L.value.material_id,"onUpdate:modelValue":[e[37]||(e[37]=t=>L.value.material_id=t),Ua],items:vt.value,"item-title":"name","item-value":"id",label:"Плитный материал",rules:[t=>!!t||"Обязательно"],density:"comfortable",class:"mb-3"},{item:s(({props:t,item:n})=>[l(Ft,il(nl(t)),{default:s(()=>[n.raw.origin==="parser"?(v(),$(zl,{key:0,class:"text-blue"},{default:s(()=>[...e[189]||(e[189]=[r(" Системный (спарсено) ",-1)])]),_:1})):(v(),$(zl,{key:1,class:"text-grey"},{default:s(()=>[...e[190]||(e[190]=[r(" Пользовательский ",-1)])]),_:1}))]),_:2},1040)]),_:1},8,["modelValue","items","rules"]),l(ae,null,{default:s(()=>[l(A,{cols:"6"},{default:s(()=>[l(D,{"model-value":Math.round(L.value.width||0),label:"Ширина, мм",type:"text",placeholder:"Например: 600 или 600-32",rules:[t=>!!t||"Обязательно",t=>t>=10||typeof t=="string"||"Должно быть >= 10"],density:"comfortable",onKeyup:e[38]||(e[38]=ma(t=>mt("width",t.target.value),["enter"])),onBlur:e[39]||(e[39]=t=>mt("width",t.target.value))},null,8,["model-value","rules"])]),_:1}),l(A,{cols:"6"},{default:s(()=>[l(D,{"model-value":Math.round(L.value.length||0),label:"Длина, мм",type:"text",placeholder:"Например: 2400 или 2400/2",rules:[t=>!!t||"Обязательно",t=>t>=10||typeof t=="string"||"Должно быть >= 10"],density:"comfortable",onKeyup:e[40]||(e[40]=ma(t=>mt("length",t.target.value),["enter"])),onBlur:e[41]||(e[41]=t=>mt("length",t.target.value))},null,8,["model-value","rules"])]),_:1})]),_:1}),l(D,{modelValue:L.value.quantity,"onUpdate:modelValue":e[42]||(e[42]=t=>L.value.quantity=t),modelModifiers:{number:!0},label:"Количество",type:"number",min:1,rules:[t=>t>=1||"Минимум 1"],density:"comfortable",class:"mb-3"},null,8,["modelValue","rules"]),l(he,{modelValue:L.value.edge_scheme,"onUpdate:modelValue":[e[43]||(e[43]=t=>L.value.edge_scheme=t),Da],items:Ut,"item-title":"label","item-value":"value",label:"Обработка торцов",disabled:!!L.value.detail_type_id,density:"comfortable",class:"mb-3"},{selection:s(({item:t})=>[l(te,{size:"small"},{default:s(()=>[l(S,{start:"",size:"16"},{default:s(()=>[r(d(t.raw.icon),1)]),_:2},1024),r(" "+d(t.raw.label),1)]),_:2},1024)]),item:s(({props:t,item:n})=>[l(Ft,il(nl(t)),{prepend:s(()=>[l(S,null,{default:s(()=>[r(d(n.raw.icon),1)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","disabled"]),L.value.edge_scheme&&L.value.edge_scheme!=="none"?(v(),$(he,{key:0,modelValue:L.value.edge_material_id,"onUpdate:modelValue":[e[44]||(e[44]=t=>L.value.edge_material_id=t),Aa],items:fl.value,"item-title":"name","item-value":"id",label:"Материал кромки",rules:[t=>!!t||"Обязательно"],density:"comfortable",class:"mb-3"},null,8,["modelValue","items","rules"])):h("",!0),l(D,{modelValue:L.value.custom_name,"onUpdate:modelValue":e[45]||(e[45]=t=>L.value.custom_name=t),label:"Название детали (опционально)",hint:"Например: «Полка левая»","persistent-hint":"",density:"comfortable"},null,8,["modelValue"])]),_:1},512)]),_:1}),l(De,null,{default:s(()=>[l(Q),l(b,{onClick:e[46]||(e[46]=t=>Dt.value=!1)},{default:s(()=>[...e[191]||(e[191]=[r("Отмена",-1)])]),_:1}),l(b,{color:"primary",onClick:Na},{default:s(()=>[...e[192]||(e[192]=[r("Сохранить",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Pe,{modelValue:ft.value,"onUpdate:modelValue":e[55]||(e[55]=t=>ft.value=t),"max-width":"600"},{default:s(()=>[l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[r(d(Ot.value?"Редактировать фурнитуру":"Новая фурнитура"),1)]),_:1}),l(G,null,{default:s(()=>[l(D,{modelValue:se.value.name,"onUpdate:modelValue":e[48]||(e[48]=t=>se.value.name=t),label:"Название",required:""},null,8,["modelValue"]),l(D,{modelValue:se.value.article,"onUpdate:modelValue":e[49]||(e[49]=t=>se.value.article=t),label:"Артикул (опционально)"},null,8,["modelValue"]),l(he,{modelValue:se.value.unit,"onUpdate:modelValue":e[50]||(e[50]=t=>se.value.unit=t),items:K.value,label:"Ед. изм.",rules:[t=>!!t||"Обязательно"],density:"comfortable",class:"mb-3",clearable:""},null,8,["modelValue","items","rules"]),l(D,{modelValue:se.value.quantity,"onUpdate:modelValue":e[51]||(e[51]=t=>se.value.quantity=t),modelModifiers:{number:!0},label:"Количество",type:"number"},null,8,["modelValue"]),l(D,{modelValue:se.value.unit_price,"onUpdate:modelValue":e[52]||(e[52]=t=>se.value.unit_price=t),modelModifiers:{number:!0},label:"Цена за шт, ₽",type:"number"},null,8,["modelValue"]),l(at,{modelValue:se.value.note,"onUpdate:modelValue":e[53]||(e[53]=t=>se.value.note=t),label:"Примечание (опционально)",rows:"2","auto-grow":""},null,8,["modelValue"])]),_:1}),l(De,null,{default:s(()=>[l(Q),l(b,{onClick:e[54]||(e[54]=t=>ft.value=!1)},{default:s(()=>[...e[193]||(e[193]=[r("Отмена",-1)])]),_:1}),l(b,{color:"primary",onClick:Qa},{default:s(()=>[...e[194]||(e[194]=[r("Сохранить",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Pe,{modelValue:_t.value,"onUpdate:modelValue":e[60]||(e[60]=t=>_t.value=t),"max-width":"600"},{default:s(()=>[l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[r(d(Rt.value?"Редактировать расход":"Новый расход"),1)]),_:1}),l(G,null,{default:s(()=>[l(D,{modelValue:Ae.value.name,"onUpdate:modelValue":e[56]||(e[56]=t=>Ae.value.name=t),label:"Название",placeholder:"Например: Доставка, Монтаж, Консультация",required:"",class:"mb-3"},null,8,["modelValue"]),l(at,{modelValue:Ae.value.description,"onUpdate:modelValue":e[57]||(e[57]=t=>Ae.value.description=t),label:"Описание",placeholder:"Детали расхода",rows:"3",class:"mb-3"},null,8,["modelValue"]),l(D,{modelValue:Ae.value.amount,"onUpdate:modelValue":e[58]||(e[58]=t=>Ae.value.amount=t),modelModifiers:{number:!0},label:"Сумма, ₽",type:"number",step:"0.01",min:"0"},null,8,["modelValue"])]),_:1}),l(De,null,{default:s(()=>[l(Q),l(b,{onClick:e[59]||(e[59]=t=>_t.value=!1)},{default:s(()=>[...e[195]||(e[195]=[r("Отмена",-1)])]),_:1}),l(b,{color:"primary",onClick:cs},{default:s(()=>[...e[196]||(e[196]=[r("Сохранить",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Pe,{modelValue:wl.value,"onUpdate:modelValue":e[68]||(e[68]=t=>wl.value=t),"max-width":"700"},{default:s(()=>[l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[r(d(kl.value?"Редактировать источник":"Добавить источник ставки"),1)]),_:1}),l(G,{class:"mt-4"},{default:s(()=>[l(D,{modelValue:P.value.source,"onUpdate:modelValue":e[61]||(e[61]=t=>P.value.source=t),label:"Источник *",variant:"outlined",density:"compact",placeholder:"Например: hh.ru, Avito, Индекс зарплат, Опрос подрядчиков",counter:"255",maxlength:"255",error:!!Me.value.source,"error-messages":Me.value.source?[Me.value.source]:[],class:"mb-3"},null,8,["modelValue","error","error-messages"]),l(D,{modelValue:P.value.position_profile,"onUpdate:modelValue":e[62]||(e[62]=t=>P.value.position_profile=t),label:"Профиль должности",variant:"outlined",density:"compact",placeholder:"Например: Сборщик мебели, Плотник категории 3, Монтажник",counter:"255",maxlength:"255",class:"mb-3"},null,8,["modelValue"]),l(D,{modelValue:P.value.salary_range,"onUpdate:modelValue":e[63]||(e[63]=t=>P.value.salary_range=t),label:"Зарплата/вилка",variant:"outlined",density:"compact",placeholder:"Например: 1000-1200 ₽/ч или 75000-85000 ₽/месяц",counter:"255",maxlength:"255",class:"mb-3"},null,8,["modelValue"]),l(D,{modelValue:P.value.period,"onUpdate:modelValue":e[64]||(e[64]=t=>P.value.period=t),label:"Период",variant:"outlined",density:"compact",placeholder:"Например: января 2026, квартал 4 2025",counter:"50",maxlength:"50",class:"mb-3"},null,8,["modelValue"]),l(D,{modelValue:P.value.link,"onUpdate:modelValue":e[65]||(e[65]=t=>P.value.link=t),label:"Ссылка на источник",variant:"outlined",density:"compact",placeholder:"https://hh.ru/...",counter:"1000",maxlength:"1000",onBlur:e[66]||(e[66]=t=>P.value.link=P.value.link?P.value.link.trim():null),error:!!Me.value.link,"error-messages":Me.value.link?[Me.value.link]:[],class:"mb-3"},null,8,["modelValue","error","error-messages"]),l(at,{modelValue:P.value.note,"onUpdate:modelValue":e[67]||(e[67]=t=>P.value.note=t),label:"Примечание",variant:"outlined",rows:"2",placeholder:"Дополнительная информация о источнике",counter:"1000",maxlength:"1000",class:"mb-2"},null,8,["modelValue"]),P.value.note?(v(),w("div",zn," Символов: "+d(P.value.note.length)+"/1000 ",1)):h("",!0),e[197]||(e[197]=o("div",{class:"text-caption text-orange"}," * — поле обязательно ",-1))]),_:1}),l(De,null,{default:s(()=>[l(Q),l(b,{onClick:Xl},{default:s(()=>[...e[198]||(e[198]=[r("Отмена",-1)])]),_:1}),l(b,{color:"primary",onClick:es},{default:s(()=>[...e[199]||(e[199]=[r("Сохранить",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(Pe,{modelValue:kt.value,"onUpdate:modelValue":e[73]||(e[73]=t=>kt.value=t),"max-width":"600"},{default:s(()=>[l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[r(d(Kt.value?"Редактировать операцию":"Новая операция"),1)]),_:1}),l(G,null,{default:s(()=>[l(he,{modelValue:ze.value.operation_id,"onUpdate:modelValue":e[69]||(e[69]=t=>ze.value.operation_id=t),items:ea.value,"item-title":"name","item-value":"id",label:"Операция",rules:[t=>!!t||"Обязательно"],density:"comfortable","return-object":"",class:"mb-3"},{item:s(({props:t,item:n})=>[l(Ft,il(nl(t)),{default:s(()=>[l(zl,null,{default:s(()=>[r(d(n.raw.category),1)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","items","rules"]),l(D,{modelValue:ze.value.quantity,"onUpdate:modelValue":e[70]||(e[70]=t=>ze.value.quantity=t),modelModifiers:{number:!0},label:"Количество",type:"number",min:"0.01",step:"0.01",density:"comfortable",class:"mb-3"},null,8,["modelValue"]),l(D,{modelValue:ze.value.note,"onUpdate:modelValue":e[71]||(e[71]=t=>ze.value.note=t),label:"Примечание (опционально)",density:"comfortable"},null,8,["modelValue"])]),_:1}),l(De,null,{default:s(()=>[l(Q),l(b,{onClick:e[72]||(e[72]=t=>kt.value=!1)},{default:s(()=>[...e[200]||(e[200]=[r("Отмена",-1)])]),_:1}),l(b,{color:"primary",onClick:Ss},{default:s(()=>[...e[201]||(e[201]=[r("Сохранить",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Pe,{modelValue:xt.value,"onUpdate:modelValue":e[80]||(e[80]=t=>xt.value=t),"max-width":"600"},{default:s(()=>[l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[r(d(Le.value?"Редактировать работу":"Добавить работу"),1)]),_:1}),l(G,null,{default:s(()=>[l(rl,{ref_key:"laborWorkFormRef",ref:la,onSubmit:we(oa,["prevent"])},{default:s(()=>[l(D,{modelValue:oe.value.title,"onUpdate:modelValue":e[74]||(e[74]=t=>oe.value.title=t),label:"Наименование работы",rules:[t=>!!t||"Обязательно",t=>t&&t.length<=255||"Максимум 255 символов"],density:"comfortable",class:"mb-3"},null,8,["modelValue","rules"]),l(D,{modelValue:oe.value.basis,"onUpdate:modelValue":e[75]||(e[75]=t=>oe.value.basis=t),label:"Основание (ГОСТ/ТУ)",placeholder:"Например: п. 5.2.4 ГОСТ 16371-2014",rules:[t=>!t||t.length<=500||"Максимум 500 символов"],density:"comfortable",class:"mb-3"},null,8,["modelValue","rules"]),l(D,{modelValue:oe.value.hours,"onUpdate:modelValue":e[76]||(e[76]=t=>oe.value.hours=t),modelModifiers:{number:!0},label:"Норма, ч",type:"number",min:"0",step:"0.25",readonly:Le.value&&Le.value.hours_source==="from_steps",rules:[t=>t!=null&&t!==""||"Обязательно",t=>t>=0||"Не может быть меньше 0",t=>t<=999.99||"Не может быть больше 999.99"],density:"comfortable",class:"mb-3"},Qs({_:2},[Le.value&&Le.value.hours_source==="from_steps"?{name:"hint",fn:s(()=>[e[202]||(e[202]=r(' ⚠️ Поле заблокировано. Часы рассчитываются из подопераций. Отредактируйте их в "Детализации". ',-1))]),key:"0"}:void 0]),1032,["modelValue","readonly","rules"]),l(Ve,{modelValue:oe.value.position_profile_id,"onUpdate:modelValue":e[77]||(e[77]=t=>oe.value.position_profile_id=t),label:"Профиль должности (опционально)",items:ta.value,"item-title":"name","item-value":"id",placeholder:"Выберите профиль для расчета ставки...",density:"comfortable",class:"mb-3",clearable:""},null,8,["modelValue","items"]),l(at,{modelValue:oe.value.note,"onUpdate:modelValue":e[78]||(e[78]=t=>oe.value.note=t),label:"Примечание (опционально)",placeholder:"Что включено в работу, дополнительные условия...",rules:[t=>!t||t.length<=5e3||"Максимум 5000 символов"],rows:"3",density:"comfortable",class:"mb-3"},null,8,["modelValue","rules"]),oe.value.hours?(v(),$(We,{key:0,type:"info",variant:"tonal",class:"mb-3"},{default:s(()=>[i.value.normohour_rate?(v(),w("div",Pn,[e[203]||(e[203]=o("strong",null,"Приблизительная сумма:",-1)),r(" "+d((oe.value.hours*(i.value.normohour_rate||0)).toFixed(2))+" ₽ ",1),o("div",Nn," ("+d(oe.value.hours.toFixed(2))+" ч × "+d((i.value.normohour_rate||0).toFixed(2))+" ₽/ч) ",1),e[204]||(e[204]=o("div",{class:"text-caption mt-2"}," * Расчет на основе ставки по умолчанию. Фактическая сумма зависит от назначенного профиля ",-1))])):(v(),w("div",qn," Фактическая сумма будет рассчитана после назначения профиля и установки ставок "))]),_:1})):h("",!0)]),_:1},512)]),_:1}),l(De,null,{default:s(()=>[l(Q),l(b,{onClick:e[79]||(e[79]=t=>xt.value=!1)},{default:s(()=>[...e[205]||(e[205]=[r("Отмена",-1)])]),_:1}),l(b,{color:"primary",onClick:oa,loading:Cl.value},{default:s(()=>[...e[206]||(e[206]=[r("Сохранить",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Pe,{modelValue:Xt.value,"onUpdate:modelValue":e[100]||(e[100]=t=>Xt.value=t),"max-width":"1000",scrollable:"",transition:"dialog-bottom-transition"},{default:s(()=>[l(R,{class:"steps-dialog-card"},{default:s(()=>[o("div",Mn,[o("div",Ln,[o("div",En,[l(S,{size:"20",class:"mr-2"},{default:s(()=>[...e[207]||(e[207]=[r("mdi-format-list-checks",-1)])]),_:1}),e[208]||(e[208]=r(" Детализация работы ",-1))]),o("div",In,d(Z.value?.title),1)]),o("div",Tn,[o("div",On,[o("span",Rn,d(zt.value.length),1),o("span",Wn,d(zt.value.length===1?"этап":"этапов"),1)]),e[210]||(e[210]=o("div",{class:"stat-divider"},null,-1)),o("div",Bn,[o("span",Hn,d(al.value.toFixed(2)),1),e[209]||(e[209]=o("span",{class:"stat-label"},"часов",-1))])]),l(b,{icon:"",variant:"text",onClick:na,class:"close-btn"},{default:s(()=>[l(S,null,{default:s(()=>[...e[211]||(e[211]=[r("mdi-close",-1)])]),_:1})]),_:1})]),l(ye),o("div",Jn,[o("div",Kn,[o("div",Xn,[l(D,{modelValue:ht.value,"onUpdate:modelValue":e[81]||(e[81]=t=>ht.value=t),placeholder:"Поиск...","prepend-inner-icon":"mdi-magnify",density:"compact",variant:"solo-filled",flat:"","hide-details":"",clearable:"",class:"search-field"},null,8,["modelValue"])]),o("div",Qn,[zt.value.length===0&&!ht.value?(v(),w("div",Gn,[l(S,{size:"48",color:"grey-lighten-1"},{default:s(()=>[...e[212]||(e[212]=[r("mdi-clipboard-list-outline",-1)])]),_:1}),e[213]||(e[213]=o("div",{class:"empty-title"},"Этапов пока нет",-1)),e[214]||(e[214]=o("div",{class:"empty-text"},"Добавьте первый этап работы, чтобы детализировать нормо-часы",-1))])):zt.value.length===0&&ht.value?(v(),w("div",Yn,[l(S,{size:"48",color:"grey-lighten-1"},{default:s(()=>[...e[215]||(e[215]=[r("mdi-magnify",-1)])]),_:1}),e[216]||(e[216]=o("div",{class:"empty-title"},"Ничего не найдено",-1)),e[217]||(e[217]=o("div",{class:"empty-text"},"Попробуйте изменить запрос",-1))])):(v(),w("div",Zn,[(v(!0),w(ie,null,be(zt.value,(t,n)=>(v(),w("div",{key:t.id,class:ct(["step-item",{"step-dragging":Vt.value===t.id,"step-editing":xe.value===t.id}]),draggable:"true",onDragstart:p=>Os(t),onDragend:Rs,onDragover:e[82]||(e[82]=we(()=>{},["prevent"])),onDrop:p=>Ws(t),onClick:p=>Is(t)},[o("div",tr,[l(S,{class:"drag-handle",size:"16"},{default:s(()=>[...e[218]||(e[218]=[r("mdi-drag",-1)])]),_:1}),o("span",lr,d(n+1),1)]),o("div",ar,[o("div",sr,d(t.title),1),t.input_data||t.basis?(v(),w("div",or,[t.input_data?(v(),w("span",{key:0,class:"meta-item",title:t.input_data},[l(S,{size:"12"},{default:s(()=>[...e[219]||(e[219]=[r("mdi-cube-outline",-1)])]),_:1}),r(" "+d(t.input_data),1)],8,ir)):h("",!0),t.basis?(v(),w("span",{key:1,class:"meta-item",title:t.basis},[l(S,{size:"12"},{default:s(()=>[...e[220]||(e[220]=[r("mdi-book-open-page-variant-outline",-1)])]),_:1}),r(" "+d(t.basis),1)],8,nr)):h("",!0)])):h("",!0)]),o("div",rr,d(cl(t.hours))+" ч ",1),o("div",ur,[l(b,{icon:"",variant:"text",density:"compact",size:"small",color:"error",onClick:we(p=>Bs(t),["stop"]),title:"Удалить"},{default:s(()=>[l(S,{size:"18"},{default:s(()=>[...e[221]||(e[221]=[r("mdi-delete-outline",-1)])]),_:1})]),_:1},8,["onClick"])])],42,er))),128))]))])]),o("div",dr,[o("div",cr,[o("div",pr,[l(S,{size:"20",class:"mr-2",color:"purple"},{default:s(()=>[...e[222]||(e[222]=[r("mdi-robot-outline",-1)])]),_:1}),e[223]||(e[223]=o("span",null,"AI помощник",-1)),l(Q),fe.value&&fe.value.status?(v(),$(te,{key:0,size:"x-small",color:fe.value.status==="verified"?"success":fe.value.status==="candidate"?"info":"warning",variant:"flat"},{default:s(()=>[r(d(fe.value.status==="verified"?"Проверено":fe.value.status==="candidate"?"Рекомендовано":"Черновик AI"),1)]),_:1},8,["color"])):h("",!0)]),o("div",mr,[l(Ve,{modelValue:E.value.domain,"onUpdate:modelValue":e[83]||(e[83]=t=>E.value.domain=t),items:vs,label:"Область",density:"compact",variant:"outlined","hide-details":"",clearable:""},null,8,["modelValue"]),l(Ve,{modelValue:E.value.action_type,"onUpdate:modelValue":e[84]||(e[84]=t=>E.value.action_type=t),items:fs,label:"Тип действия",density:"compact",variant:"outlined","hide-details":"",clearable:""},null,8,["modelValue"]),l(Ve,{modelValue:E.value.constraints,"onUpdate:modelValue":e[85]||(e[85]=t=>E.value.constraints=t),items:_s,label:"Условия",density:"compact",variant:"outlined","hide-details":"",clearable:""},null,8,["modelValue"]),l(Ve,{modelValue:E.value.site_state,"onUpdate:modelValue":e[86]||(e[86]=t=>E.value.site_state=t),items:gs,label:"Состояние объекта",density:"compact",variant:"outlined","hide-details":"",clearable:""},null,8,["modelValue"])]),l(Mt,null,{default:s(()=>[ll.value?(v(),w("div",vr,[l(D,{modelValue:E.value.material,"onUpdate:modelValue":e[87]||(e[87]=t=>E.value.material=t),label:"Материал",density:"compact",variant:"outlined","hide-details":"",placeholder:"ЛДСП, МДФ..."},null,8,["modelValue"]),l(D,{modelValue:E.value.object_type,"onUpdate:modelValue":e[88]||(e[88]=t=>E.value.object_type=t),label:"Тип объекта",density:"compact",variant:"outlined","hide-details":"",placeholder:"Шкаф, кухня..."},null,8,["modelValue"])])):h("",!0)]),_:1}),o("div",fr,[l(b,{variant:"text",size:"x-small",onClick:e[89]||(e[89]=t=>ll.value=!ll.value)},{default:s(()=>[r(d(ll.value?"Скрыть":"Больше опций"),1)]),_:1}),l(Q),l(D,{modelValue:Zt.value,"onUpdate:modelValue":e[90]||(e[90]=t=>Zt.value=t),modelModifiers:{number:!0},type:"number",min:"0",step:"0.5",label:"Желаемые часы",density:"compact",variant:"outlined","hide-details":"",style:{"max-width":"120px"}},null,8,["modelValue"])]),l(b,{color:"purple",variant:"flat",block:"","prepend-icon":"mdi-auto-fix",loading:el.value,disabled:!Z.value?.title,onClick:Ms},{default:s(()=>[...e[224]||(e[224]=[r(" Сгенерировать этапы (AI) ",-1)])]),_:1},8,["loading","disabled"]),l(Mt,null,{default:s(()=>[fe.value&&fe.value.steps&&!el.value?(v(),w("div",_r,[o("div",gr,[e[225]||(e[225]=o("span",{class:"ai-preview-title"},"Предложение AI",-1)),l(te,{size:"x-small",color:"primary",variant:"tonal"},{default:s(()=>[r(d((fe.value.total_hours??0).toFixed(2))+" ч ",1)]),_:1})]),o("div",yr,[(v(!0),w(ie,null,be(fe.value.steps,(t,n)=>(v(),w("div",{key:n,class:"ai-preview-item"},[o("span",wr,d(n+1)+".",1),o("span",br,d(t.title),1),o("span",kr,d(t.hours)+" ч",1)]))),128))]),o("div",xr,[l(b,{color:"success",variant:"flat",size:"small","prepend-icon":"mdi-swap-horizontal",loading:tl.value,onClick:e[91]||(e[91]=t=>ia("replace"))},{default:s(()=>[...e[226]||(e[226]=[r(" Заменить всё ",-1)])]),_:1},8,["loading"]),l(b,{color:"primary",variant:"outlined",size:"small","prepend-icon":"mdi-plus",loading:tl.value,onClick:e[92]||(e[92]=t=>ia("append"))},{default:s(()=>[...e[227]||(e[227]=[r(" Добавить ",-1)])]),_:1},8,["loading"]),l(b,{variant:"text",size:"small",onClick:e[93]||(e[93]=t=>fe.value=null)},{default:s(()=>[...e[228]||(e[228]=[r(" Отмена ",-1)])]),_:1})])])):h("",!0)]),_:1})]),l(ye,{class:"my-3"}),o("div",hr,[l(S,{size:"20",class:"mr-2",color:xe.value?"warning":"success"},{default:s(()=>[r(d(xe.value?"mdi-pencil":"mdi-plus-circle"),1)]),_:1},8,["color"]),o("span",null,d(xe.value?"Редактирование":"Новый этап"),1),l(Q),xe.value?(v(),$(b,{key:0,variant:"text",size:"small",onClick:Ts},{default:s(()=>[...e[229]||(e[229]=[r(" Отменить ",-1)])]),_:1})):h("",!0)]),l(rl,{onSubmit:we(Es,["prevent"]),ref_key:"stepFormRef",ref:aa,class:"step-form"},{default:s(()=>[o("div",Vr,[e[230]||(e[230]=o("label",{class:"field-label required"},"Наименование этапа",-1)),l(at,{modelValue:le.value.title,"onUpdate:modelValue":e[94]||(e[94]=t=>le.value.title=t),placeholder:"Например: Демонтаж холодильника",rules:[t=>!!t||"Обязательно"],variant:"outlined",density:"compact",rows:"2","auto-grow":"","hide-details":"auto",autofocus:""},null,8,["modelValue","rules"])]),o("div",$r,[o("div",Cr,[e[231]||(e[231]=o("label",{class:"field-label required"},"Время",-1)),l(D,{modelValue:le.value.hours,"onUpdate:modelValue":e[95]||(e[95]=t=>le.value.hours=t),modelModifiers:{number:!0},type:"number",min:"0",step:"0.25",inputmode:"decimal",suffix:"ч",rules:[t=>t!=null&&t!==""||"Обязательно",t=>Number(t)>0||"Больше 0"],variant:"outlined",density:"compact","hide-details":"auto"},null,8,["modelValue","rules"])]),o("div",Fr,[e[232]||(e[232]=o("label",{class:"field-label"},"Объём / входные данные",-1)),l(D,{modelValue:le.value.input_data,"onUpdate:modelValue":e[96]||(e[96]=t=>le.value.input_data=t),placeholder:"1 шт., 6 модулей, 2.5 м²...",variant:"outlined",density:"compact","hide-details":""},null,8,["modelValue"])])]),o("div",Sr,[e[233]||(e[233]=o("label",{class:"field-label"},"Основание",-1)),l(D,{modelValue:le.value.basis,"onUpdate:modelValue":e[97]||(e[97]=t=>le.value.basis=t),placeholder:"ГОСТ, СНиП, методика...",variant:"outlined",density:"compact","hide-details":""},null,8,["modelValue"])]),l(Mt,null,{default:s(()=>[Gs(o("div",jr,[e[234]||(e[234]=o("label",{class:"field-label"},"Примечание",-1)),l(at,{modelValue:le.value.note,"onUpdate:modelValue":e[98]||(e[98]=t=>le.value.note=t),placeholder:"Особые условия, ограничения...",rows:"2","auto-grow":"",variant:"outlined",density:"compact","hide-details":""},null,8,["modelValue"])],512),[[Ys,Gt.value||le.value.note]])]),_:1}),!Gt.value&&!le.value.note?(v(),w("div",Ur,[l(b,{variant:"text",size:"small","prepend-icon":"mdi-plus",onClick:e[99]||(e[99]=t=>Gt.value=!0)},{default:s(()=>[...e[235]||(e[235]=[r(" Добавить примечание ",-1)])]),_:1})])):h("",!0),o("div",Dr,[l(b,{variant:"text",size:"small",onClick:Dl,disabled:Qt.value},{default:s(()=>[...e[236]||(e[236]=[r(" Очистить ",-1)])]),_:1},8,["disabled"]),l(b,{type:"submit",color:xe.value?"warning":"success","prepend-icon":xe.value?"mdi-check":"mdi-plus",loading:Qt.value,variant:"flat"},{default:s(()=>[r(d(xe.value?"Сохранить":"Добавить"),1)]),_:1},8,["color","prepend-icon","loading"])])]),_:1},512)])]),l(ye),o("div",Ar,[o("div",zr,[l(S,{color:"primary",size:"20"},{default:s(()=>[...e[237]||(e[237]=[r("mdi-sigma",-1)])]),_:1}),e[238]||(e[238]=o("span",{class:"summary-label"},"Итого:",-1)),o("span",Pr,d(al.value.toFixed(2))+" ч",1),Z.value?.hours!==al.value?(v(),w("span",Nr," (в смете: "+d(Z.value?.hours)+" ч) ",1)):h("",!0)]),l(Q),l(b,{variant:"outlined",onClick:na},{default:s(()=>[...e[239]||(e[239]=[r(" Закрыть ",-1)])]),_:1})])]),_:1})]),_:1},8,["modelValue"]),l(Pe,{modelValue:Fl.value,"onUpdate:modelValue":e[102]||(e[102]=t=>Fl.value=t),"max-width":"420"},{default:s(()=>[l(R,null,{default:s(()=>[l(ee,null,{default:s(()=>[...e[240]||(e[240]=[r("Удалить подоперацию?",-1)])]),_:1}),l(G,{class:"text-medium-emphasis"},{default:s(()=>[r(d(a.stepToDelete?.title),1)]),_:1}),l(De,null,{default:s(()=>[l(Q),l(b,{variant:"text",onClick:e[101]||(e[101]=t=>Fl.value=!1)},{default:s(()=>[...e[241]||(e[241]=[r("Отмена",-1)])]),_:1}),l(b,{color:"error",onClick:a.deleteStepConfirmed},{default:s(()=>[...e[242]||(e[242]=[r("Удалить",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ao,{modelValue:Ge.value.show,"onUpdate:modelValue":e[103]||(e[103]=t=>Ge.value.show=t),timeout:Ge.value.timeout,color:Ge.value.color,location:"bottom right"},{default:s(()=>[r(d(Ge.value.message),1)]),_:1},8,["modelValue","timeout","color"])],64))}}),Er=dl(qr,[["__scopeId","data-v-193095a4"]]);export{Er as default};
