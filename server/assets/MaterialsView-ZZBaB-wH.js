import{f as be,d as w,m as L,c as v,n as K,k as Q,g as u,b as f,o as h,p as Z,q as _,r as P,s as x,h as ee,i as le,t as te,j as ae,a as we,v as xe,w as ke,x as se,y as Ce,_ as Ue}from"./index-Cph0VrJn.js";import{W as Te,r as d,a as ie,d as ze,X as De,C as g,D as s,G as a,z as n,aY as m,ab as Ie,$ as q,a2 as p,a0 as j,F as c}from"./vendor-Cpjz-SYi.js";const qe={class:"d-flex flex-wrap align-center ga-3"},Ne={class:"d-flex flex-column"},Me={class:"font-weight-medium"},Fe={class:"text-caption text-medium-emphasis"},Oe=["href"],Be={key:1,class:"text-medium-emphasis"},Se={class:"d-flex ga-2 justify-end"},$e={class:"text-center pa-8"},Re={class:"text-h6"},Le={class:"flex-grow-1"},Pe={class:"d-flex align-center"},je={class:"text-caption text-medium-emphasis mt-1"},Ee=["href"],He={key:1},Xe=Te({__name:"MaterialsView",setup(Ye){const re=[{title:"Название / Артикул",key:"name",width:"480px"},{title:"Источник",key:"origin",width:"140px",align:"center"},{title:"Тип",key:"type",width:"50px"},{title:"Ед.",key:"unit",width:"30px",align:"center"},{title:"Цена",key:"price_per_unit",width:"120px",align:"end"},{title:"Версия",key:"version",width:"90px",align:"center"},{title:"Статус",key:"is_active",width:"110px"},{title:"Ссылка",key:"source_url",width:"100px"},{title:"",key:"actions",width:"120px",sortable:!1,align:"end"}],oe=[{title:"Дата",key:"valid_from",width:"140px"},{title:"Версия",key:"version",width:"100px",align:"center"},{title:"Цена",key:"price_per_unit",width:"120px",align:"end"},{title:"Ссылка",key:"source_url",width:"120px"}],E=[{label:"Плита",value:"plate"},{label:"Кромка",value:"edge"},{label:"Фурнитура",value:"hardware"}],H=["м²","м.п.","шт"],ne=[{label:"Пользователь",value:"user"},{label:"Парсер",value:"parser"}],ue={plate:"Плита",edge:"Кромка",hardware:"Фурнитура"},de={plate:"м²",edge:"м.п.",hardware:"шт"},X=d([]),N=d([]),k=d(!1),M=d(!1),C=d(!1),b=d(!1),y=d(null),F=d(!1),Y=d(),U=d(""),T=d(null),z=d(null),D=d(null),t=ie({origin:"user",name:"",article:"",type:"plate",unit:"м²",price_per_unit:0,source_url:"",last_price_screenshot_path:"",is_active:!0,version:1,operation_ids:[],length_mm:void 0,width_mm:void 0,thickness_mm:void 0}),r=ie({show:!1,message:"",color:"success"}),I=d(!1),A=d(null),O=d([]),V={required:i=>!!i||"Обязательное поле",nonNegative:i=>i>=0||"Не может быть отрицательной",url:i=>!i||/^https?:\/\//.test(i)||"Должен начинаться с http:// или https://"},me=ze(()=>{const i=U.value.trim().toLowerCase();return X.value.filter(e=>{const l=!i||e.name.toLowerCase().includes(i)||e.article.toLowerCase().includes(i),o=!T.value||e.type===T.value,$=!z.value||e.unit===z.value,R=!D.value||e.origin===D.value;return l&&o&&$&&R})}),G=i=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB"}).format(i||0),pe=()=>{t.unit=de[t.type]||t.unit,t.type!=="plate"&&(t.length_mm=void 0,t.width_mm=void 0,t.thickness_mm=void 0)};let W;const ce=()=>{clearTimeout(W),W=setTimeout(()=>{if(t.type!=="plate"||!t.name)return;const i=ve(t.name);i&&(t.length_mm=i[0],t.width_mm=i[1],t.thickness_mm=i[2])},300)},ve=i=>{if(!i)return null;let e=i.replace(/[×*xX]/g,"х");const l=/(\d+)\s*х\s*(\d+)\s*х\s*(\d+)\s*мм/u;let o=e.match(l);if(o)return[parseInt(o[1]),parseInt(o[2]),parseInt(o[3])];const $=/(\d+)\s*х\s*(\d+)\s*х\s*(\d+)(?:\s|$)/u;if(o=e.match($),o)return[parseInt(o[1]),parseInt(o[2]),parseInt(o[3])];const R=/(\d+)\s*х\s*(\d+)/u;return o=e.match(R),o?[parseInt(o[1]),parseInt(o[2]),null]:null},B=async()=>{k.value=!0;try{const i=await w.get("/api/materials");X.value=i.data}catch(i){console.error(i),r.message="Ошибка загрузки материалов",r.color="error",r.show=!0}finally{k.value=!1}},fe=async()=>{try{const i=await w.get("/api/operations");N.value=i.data}catch(i){console.error(i),N.value=[]}},_e=()=>{t.id=void 0,t.origin="user",t.name="",t.article="",t.type="plate",t.unit="м²",t.price_per_unit=0,t.source_url="",t.last_price_screenshot_path="",t.is_active=!0,t.version=1,t.operation_ids=[],t.length_mm=void 0,t.width_mm=void 0,t.thickness_mm=void 0},J=()=>{y.value=null,_e(),b.value=!0},ye=i=>{y.value=i.id,Object.assign(t,{...i}),b.value=!0},ge=async i=>{A.value=i,I.value=!0;try{const e=await w.get(`/api/materials/${i.id}/history`);O.value=e.data}catch{O.value=[]}},S=()=>{b.value=!1},Ve=async()=>{if(!t.source_url){r.message="Сначала введите ссылку",r.color="warning",r.show=!0;return}C.value=!0;try{const e=(await w.post("/api/materials/fetch",{source_url:t.source_url})).data;if(e.material){Object.assign(t,{name:e.material.name??"",article:e.material.article??"",type:e.material.type??t.type,unit:e.material.unit??t.unit,price_per_unit:Number(e.material.price_per_unit??t.price_per_unit),source_url:e.material.source_url??t.source_url,last_price_screenshot_path:e.material.last_price_screenshot_path??"",is_active:e.material.is_active??!0,version:e.material.version??t.version}),r.message="Данные подставлены из базы",r.color="success",r.show=!0;return}if(e.suggested){const l=e.suggested;l.name&&(t.name=l.name),l.article&&(t.article=l.article),l.price_per_unit!==null&&l.price_per_unit!==void 0&&(t.price_per_unit=Number(l.price_per_unit)),l.type&&(t.type=l.type),l.unit&&(t.unit=l.unit),l.source_url&&(t.source_url=l.source_url),t.last_price_screenshot_path="";let o="success";e.source==="blocked"?o="error":(e.source==="fetch_failed"||e.source==="fetched"&&!l.name)&&(o="warning"),r.message=e.message||"Данные получены со страницы",r.color=o,r.show=!0;return}r.message="Не удалось получить данные по ссылке",r.color="warning",r.show=!0}catch(i){console.error(i),r.message="Ошибка при запросе ссылки",r.color="error",r.show=!0}finally{C.value=!1}},he=async()=>{if((await Y.value?.validate())?.valid??!1){M.value=!0;try{const e=y.value?`/api/materials/${y.value}`:"/api/materials",l=y.value?"PUT":"POST",o=await w({method:l,url:e,data:t});await B(),S(),r.message=y.value?"Материал обновлён":"Материал создан",r.color="success",r.show=!0}catch(e){console.error("Error saving material:",e),r.message=e.response?.data?.message||e.message||"Ошибка при сохранении",r.color="error",r.show=!0}finally{M.value=!1}}};return De(async()=>{await B(),await fe()}),(i,e)=>(c(),g(be,{fluid:"",class:"pa-0"},{default:s(()=>[a(K,{class:"pa-4",color:"surface"},{default:s(()=>[n("div",qe,[e[24]||(e[24]=n("div",null,[n("div",{class:"text-h5 font-weight-medium"},"Материалы"),n("div",{class:"text-medium-emphasis"},"Просмотр и корректировка свойств")],-1)),a(L),a(v,{color:"primary","prepend-icon":"mdi-plus",class:"text-none",onClick:J},{default:s(()=>[...e[22]||(e[22]=[m(" Добавить ",-1)])]),_:1}),a(v,{variant:"text","prepend-icon":"mdi-refresh",class:"text-none",loading:k.value,onClick:B},{default:s(()=>[...e[23]||(e[23]=[m(" Обновить ",-1)])]),_:1},8,["loading"])])]),_:1}),a(K,{class:"pa-4"},{default:s(()=>[a(Q,{class:"mb-3",align:"center",dense:""},{default:s(()=>[a(u,{cols:"12",md:"4"},{default:s(()=>[a(f,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=l=>U.value=l),label:"Поиск по названию или артикулу","prepend-inner-icon":"mdi-magnify","hide-details":"",clearable:"","onClick:clear":e[1]||(e[1]=l=>U.value="")},null,8,["modelValue"])]),_:1}),a(u,{cols:"12",md:"3"},{default:s(()=>[a(h,{modelValue:T.value,"onUpdate:modelValue":e[2]||(e[2]=l=>T.value=l),items:E,"item-title":"label","item-value":"value",label:"Тип",clearable:"","hide-details":""},null,8,["modelValue"])]),_:1}),a(u,{cols:"12",md:"2"},{default:s(()=>[a(h,{modelValue:z.value,"onUpdate:modelValue":e[3]||(e[3]=l=>z.value=l),items:H,label:"Ед. изм.",clearable:"","hide-details":""},null,8,["modelValue"])]),_:1}),a(u,{cols:"12",md:"3"},{default:s(()=>[a(h,{modelValue:D.value,"onUpdate:modelValue":e[4]||(e[4]=l=>D.value=l),items:ne,"item-title":"label","item-value":"value",label:"Источник",clearable:"","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1}),a(Z,{headers:re,items:me.value,loading:k.value,class:"elevation-1","item-key":"id",density:"comfortable"},{"item.origin":s(({item:l})=>[a(x,{size:"small",color:l.origin==="parser"?"orange":"blue",variant:"tonal",class:"text-caption"},{default:s(()=>[l.origin==="parser"?(c(),g(_,{key:0,start:"",icon:"mdi-robot",size:"small"})):(c(),g(_,{key:1,start:"",icon:"mdi-account",size:"small"})),m(" "+p(l.origin==="parser"?"Парсер":"Пользователь"),1)]),_:2},1032,["color"])]),"item.name":s(({item:l})=>[n("div",Ne,[n("span",Me,p(l.name),1),n("span",Fe,p(l.article),1)])]),"item.type":s(({item:l})=>[a(x,{size:"small",variant:"tonal",color:"primary"},{default:s(()=>[m(p(ue[l.type]??l.type),1)]),_:2},1024)]),"item.unit":s(({item:l})=>[a(x,{size:"small",variant:"text"},{default:s(()=>[m(p(l.unit),1)]),_:2},1024)]),"item.price_per_unit":s(({item:l})=>[m(p(G(l.price_per_unit)),1)]),"item.version":s(({item:l})=>[a(x,{size:"small",variant:"outlined"},{default:s(()=>[m(" v"+p(l.version??1),1)]),_:2},1024)]),"item.is_active":s(({item:l})=>[a(x,{size:"small",color:l.is_active?"success":"grey",variant:"tonal"},{default:s(()=>[m(p(l.is_active?"Активен":"Выключен"),1)]),_:2},1032,["color"])]),"item.source_url":s(({item:l})=>[l.source_url?(c(),q("a",{key:0,href:l.source_url,target:"_blank",rel:"noreferrer",class:"text-primary"}," Ссылка ",8,Oe)):(c(),q("span",Be,"—"))]),"item.actions":s(({item:l})=>[n("div",Se,[a(v,{icon:"",size:"small",variant:"text",onClick:o=>ge(l)},{default:s(()=>[a(_,{icon:"mdi-history",size:"small"}),a(P,{activator:"parent",location:"top"},{default:s(()=>[...e[25]||(e[25]=[m(" История цен ",-1)])]),_:1})]),_:1},8,["onClick"]),l.origin==="user"?(c(),g(v,{key:0,icon:"",size:"small",variant:"text",color:"primary",onClick:o=>ye(l)},{default:s(()=>[a(_,{icon:"mdi-pencil",size:"small"}),a(P,{activator:"parent",location:"top"},{default:s(()=>[...e[26]||(e[26]=[m(" Редактировать ",-1)])]),_:1})]),_:1},8,["onClick"])):(c(),g(P,{key:1,location:"top"},{activator:s(({props:o})=>[a(_,Ie(o,{icon:"mdi-lock-outline",size:"small",color:"grey-darken-1"}),null,16)]),default:s(()=>[e[27]||(e[27]=n("span",null,"Редактирование недоступно (загружено парсером)",-1))]),_:1}))])]),"no-data":s(()=>[n("div",$e,[e[29]||(e[29]=n("div",{class:"text-subtitle-1 mb-2"},"Нет материалов",-1)),e[30]||(e[30]=n("div",{class:"text-medium-emphasis mb-4"}," Добавьте материал вручную или запустите парсер ",-1)),a(v,{color:"primary","prepend-icon":"mdi-plus",onClick:J},{default:s(()=>[...e[28]||(e[28]=[m(" Добавить материал ",-1)])]),_:1})])]),_:1},8,["items","loading"])]),_:1}),a(se,{modelValue:b.value,"onUpdate:modelValue":e[18]||(e[18]=l=>b.value=l),"max-width":"640",persistent:""},{default:s(()=>[a(ee,null,{default:s(()=>[a(le,{class:"d-flex align-center"},{default:s(()=>[a(_,{class:"mr-2",icon:y.value?"mdi-pencil":"mdi-plus"},null,8,["icon"]),n("span",Re,p(y.value?"Редактировать материал":"Новый материал"),1),a(L),a(v,{icon:"",variant:"text",onClick:S},{default:s(()=>[a(_,{icon:"mdi-close"})]),_:1})]),_:1}),a(te),a(ae,null,{default:s(()=>[a(we,{ref_key:"formRef",ref:Y,modelValue:F.value,"onUpdate:modelValue":e[17]||(e[17]=l=>F.value=l)},{default:s(()=>[a(Q,{dense:""},{default:s(()=>[a(u,{cols:"12",md:"6"},{default:s(()=>[a(f,{modelValue:t.name,"onUpdate:modelValue":e[5]||(e[5]=l=>t.name=l),label:"Название",rules:[V.required],required:"",onBlur:ce},null,8,["modelValue","rules"])]),_:1}),a(u,{cols:"12",md:"6"},{default:s(()=>[a(f,{modelValue:t.article,"onUpdate:modelValue":e[6]||(e[6]=l=>t.article=l),label:"Артикул",rules:[V.required],required:""},null,8,["modelValue","rules"])]),_:1}),a(u,{cols:"12",md:"6"},{default:s(()=>[a(h,{modelValue:t.type,"onUpdate:modelValue":[e[7]||(e[7]=l=>t.type=l),pe],items:E,"item-title":"label","item-value":"value",label:"Тип",rules:[V.required],required:""},null,8,["modelValue","rules"])]),_:1}),a(u,{cols:"12",md:"6"},{default:s(()=>[a(h,{modelValue:t.unit,"onUpdate:modelValue":e[8]||(e[8]=l=>t.unit=l),items:H,label:"Единица",rules:[V.required],required:"",readonly:t.type==="plate",hint:t.type==="plate"?"Для плит всегда м²":"","persistent-hint":""},null,8,["modelValue","rules","readonly","hint"])]),_:1}),t.type==="plate"?(c(),g(u,{key:0,cols:"12",md:"4"},{default:s(()=>[a(f,{modelValue:t.length_mm,"onUpdate:modelValue":e[9]||(e[9]=l=>t.length_mm=l),modelModifiers:{number:!0},label:"Длина листа, мм",type:"number",min:"1",hint:"Длина листа в миллиметрах","persistent-hint":""},null,8,["modelValue"])]),_:1})):j("",!0),t.type==="plate"?(c(),g(u,{key:1,cols:"12",md:"4"},{default:s(()=>[a(f,{modelValue:t.width_mm,"onUpdate:modelValue":e[10]||(e[10]=l=>t.width_mm=l),modelModifiers:{number:!0},label:"Ширина листа, мм",type:"number",min:"1",hint:"Ширина листа в миллиметрах","persistent-hint":""},null,8,["modelValue"])]),_:1})):j("",!0),t.type==="plate"?(c(),g(u,{key:2,cols:"12",md:"4"},{default:s(()=>[a(f,{modelValue:t.thickness_mm,"onUpdate:modelValue":e[11]||(e[11]=l=>t.thickness_mm=l),modelModifiers:{number:!0},label:"Толщина, мм",type:"number",min:"0.1",step:"0.1",hint:"Толщина листа в миллиметрах","persistent-hint":""},null,8,["modelValue"])]),_:1})):j("",!0),a(u,{cols:"12",md:"6"},{default:s(()=>[a(f,{modelValue:t.price_per_unit,"onUpdate:modelValue":e[12]||(e[12]=l=>t.price_per_unit=l),modelModifiers:{number:!0},label:"Цена за единицу",type:"number",min:"0",step:"0.01",rules:[V.required,V.nonNegative],required:"",prefix:"₽"},null,8,["modelValue","rules"])]),_:1}),a(u,{cols:"12",md:"6"},{default:s(()=>[a(f,{modelValue:t.source_url,"onUpdate:modelValue":e[13]||(e[13]=l=>t.source_url=l),label:"Ссылка на товар",placeholder:"https://",type:"url",loading:C.value,"append-inner-icon":C.value?"mdi-loading":"mdi-cloud-download","onClick:appendInner":Ve,rules:[V.url]},null,8,["modelValue","loading","append-inner-icon","rules"])]),_:1}),a(u,{cols:"12",md:"6"},{default:s(()=>[a(f,{modelValue:t.last_price_screenshot_path,"onUpdate:modelValue":e[14]||(e[14]=l=>t.last_price_screenshot_path=l),label:"Скриншот",placeholder:"URL или путь"},null,8,["modelValue"])]),_:1}),a(u,{cols:"12"},{default:s(()=>[a(h,{modelValue:t.operation_ids,"onUpdate:modelValue":e[15]||(e[15]=l=>t.operation_ids=l),items:N.value,"item-title":"name","item-value":"id",label:"Связанные операции",multiple:"",chips:"",clearable:"","hide-details":""},null,8,["modelValue","items"])]),_:1}),a(u,{cols:"12"},{default:s(()=>[a(xe,{modelValue:t.is_active,"onUpdate:modelValue":e[16]||(e[16]=l=>t.is_active=l),color:"primary",inset:"",label:"Материал активен"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(ke,{class:"px-4 pb-4"},{default:s(()=>[a(L),a(v,{variant:"text",class:"text-none",onClick:S},{default:s(()=>[...e[31]||(e[31]=[m(" Отмена ",-1)])]),_:1}),a(v,{color:"primary",class:"text-none",loading:M.value,disabled:!F.value,onClick:he},{default:s(()=>[...e[32]||(e[32]=[m(" Сохранить ",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(se,{modelValue:I.value,"onUpdate:modelValue":e[20]||(e[20]=l=>I.value=l),"max-width":"720"},{default:s(()=>[a(ee,null,{default:s(()=>[a(le,{class:"d-flex align-center"},{default:s(()=>[n("div",Le,[n("div",Pe,[a(_,{class:"mr-2",icon:"mdi-history"}),e[33]||(e[33]=n("span",{class:"text-h6"},"История цен",-1))]),n("div",je,p(A.value?.name),1)]),a(v,{icon:"",variant:"text",onClick:e[19]||(e[19]=l=>I.value=!1)},{default:s(()=>[a(_,{icon:"mdi-close"})]),_:1})]),_:1}),a(te),a(ae,null,{default:s(()=>[a(Z,{headers:oe,items:O.value,density:"comfortable"},{"item.price_per_unit":s(({item:l})=>[m(p(G(l.price_per_unit)),1)]),"item.valid_from":s(({item:l})=>[m(p(new Date(l.valid_from).toLocaleDateString("ru-RU")),1)]),"item.source_url":s(({item:l})=>[l.source_url?(c(),q("a",{key:0,href:l.source_url,target:"_blank",rel:"noreferrer"}," Ссылка ",8,Ee)):(c(),q("span",He,"—"))]),"no-data":s(()=>[...e[34]||(e[34]=[n("div",{class:"text-center pa-4 text-medium-emphasis"}," Нет записей истории цен ",-1)])]),_:1},8,["items"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(Ce,{modelValue:r.show,"onUpdate:modelValue":e[21]||(e[21]=l=>r.show=l),color:r.color,timeout:"3000"},{default:s(()=>[m(p(r.message),1)]),_:1},8,["modelValue","color"])]),_:1}))}}),We=Ue(Xe,[["__scopeId","data-v-09816d05"]]);export{We as default};
