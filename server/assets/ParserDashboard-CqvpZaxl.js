import{W as Q,r as h,X as Z,Y as ee,C as S,D as s,G as a,z as r,a2 as u,$ as L,a4 as le,a3 as ae,aW as f,a_ as te,F as V,B as se,a0 as oe}from"./vendor-BCQqBE-6.js";import{a5 as p,k as b,g as m,c as d,V as re,h as I,i as U,j as $,a as ne,C as ie,w as D,m as R,x as P,o as ue,y as ce,f as de,q as T,s as fe,t as B,a4 as ve,_ as pe}from"./index-IpZUhCov.js";import{f as me}from"./formatDistanceToNow-B6Nhz5gL.js";import"./en-US-CEnKpqyg.js";const ge={class:"text-h6"},_e={class:"text-subtitle-2"},ye={class:"d-flex align-center"},he={class:"text-h6"},Ve={key:0,class:"activity-pulse"},Ce={class:"text-caption ml-1"},Se={class:"metric-value"},ke={class:"metric-value"},we={class:"metric-value"},xe={class:"text-h5"},be={class:"text-h6"},Ie=Q({__name:"ParserDashboard",setup(Ue){const k=te();let o=!1;const v=h(null),F=h([]),n=h({status:!1,suppliers:!1,run:{},collect:{},stop:{}}),c=h({open:!1,supplier:"",config:"{}"}),i=h({open:!1,supplier:"",profileId:null,profileItems:[],loading:!1}),C=h({show:!1,message:"",color:"success"});let w=null;Z(()=>{o=!1,x(),w=window.setInterval(x,1e4)}),ee(()=>{o=!0,w&&clearInterval(w)});async function x(){o||await Promise.all([N(),O()])}async function N(){if(!o)try{n.value.status=!0;const l=await p.getSystemStatus();o||(v.value=l)}catch(l){o||console.error("Failed to load system status:",l)}finally{o||(n.value.status=!1)}}async function O(){if(!o)try{n.value.suppliers=!0;const l=await p.getSuppliersHealth();console.log("Suppliers data received:",l),o||(F.value=l)}catch(l){o||console.error("Failed to load suppliers:",l)}finally{o||(n.value.suppliers=!1)}}function H(l){return l.current_pid?"mdi-sync":l.active?l.health_score>=80?"mdi-check-circle":l.health_score>=50?"mdi-alert-circle":"mdi-close-circle":"mdi-pause-circle"}function z(l){return l.current_pid?"primary":l.active?l.health_score>=80?"success":l.health_score>=50?"warning":"error":"grey"}function A(l){return l.current_pid?"card-running":l.active?"":"card-disabled"}function J(l){return l>=80?"success":l>=50?"warning":"error"}function W(l){if(!l)return"Never";try{return me(new Date(l),{addSuffix:!0})}catch{return"Unknown"}}function j(l){c.value={open:!0,supplier:l,config:"{}"}}async function q(l){if(!o){i.value={open:!0,supplier:l,profileId:null,profileItems:[{title:"Без профиля (базовая конфигурация)",value:null}],loading:!0};try{const e=await p.getCollectProfiles(l),t=e.map(y=>({title:y.is_default?`${y.name} (по умолчанию)`:y.name,value:y.id})),_=e.find(y=>y.is_default);i.value.profileItems=[{title:"Без профиля (базовая конфигурация)",value:null},...t],i.value.profileId=_?.id??null}catch(e){o||(console.error("Failed to load collect profiles:",e),g("Не удалось загрузить профили сбора URL.","error"))}finally{o||(i.value.loading=!1)}}}async function E(){if(o)return;const l=i.value.supplier;try{n.value.collect[l]=!0;const e=await p.collectSupplierUrlsWithProfile(l,i.value.profileId??void 0);if(!o){i.value.open=!1;const t=e?.session_id?` (session #${e.session_id})`:"";g(`URL сбор запущен для ${l}${t}`,"success")}}catch(e){o||(console.error("Failed to collect URLs:",e),g("Не удалось запустить сбор URL. Проверьте консоль.","error"))}finally{o||(n.value.collect[l]=!1)}}function G(l){try{return JSON.parse(l),!0}catch{return"Invalid JSON"}}async function M(){if(!o)try{const l=JSON.parse(c.value.config);l.collect_urls=!1,n.value.run[c.value.supplier]=!0;const e=await p.createSession(c.value.supplier,l);o||(c.value.open=!1,k.push(`/parser/sessions/${e.id}`))}catch(l){o||(console.error("Failed to start parser:",l),g("Не удалось запустить парсер. Проверьте консоль.","error"))}finally{o||(n.value.run[c.value.supplier]=!1)}}async function X(l){if(!(o||!l.current_pid))try{n.value.stop[l.supplier]=!0;const e=await p.getSessions({supplier_id:l.supplier,status:"running"});if(e.data&&e.data.length>0){const t=e.data[0];await p.stopSession(t.id),o||(g(`Сеанс парсирования ${l.supplier} остановлен`,"success"),await x())}}catch(e){o||(console.error("Failed to stop supplier:",e),g("Не удалось остановить парсирование. Проверьте консоль.","error"))}finally{o||(n.value.stop[l.supplier]=!1)}}function Y(l){k.push(`/parser/history?supplier=${l}`)}function K(l){k.push(`/parser/suppliers/${l}/config`)}function g(l,e="success"){o||(C.value={show:!0,message:l,color:e})}return(l,e)=>(V(),S(de,{fluid:"",class:"parser-dashboard"},{default:s(()=>[a(re,{type:v.value?.scheduler_running?"success":"error",icon:v.value?.scheduler_running?"mdi-check-circle":"mdi-alert-circle",prominent:"",class:"mb-6 system-status-alert"},{default:s(()=>[a(b,{align:"center"},{default:s(()=>[a(m,null,{default:s(()=>[r("div",ge,u(v.value?.scheduler_running?"System Operational":"Scheduler Offline"),1),r("div",_e," Active Sessions: "+u(v.value?.active_sessions||0)+" | 24h Total: "+u(v.value?.total_sessions_24h||0)+" | Health Score: "+u(v.value?.health_score||0)+"% ",1)]),_:1}),a(m,{cols:"auto"},{default:s(()=>[a(d,{icon:"mdi-refresh",variant:"text",onClick:N,loading:n.value.status},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["type","icon"]),a(b,null,{default:s(()=>[(V(!0),L(ae,null,le(F.value,t=>(V(),S(m,{key:t.supplier,cols:"12",md:"6",lg:"4"},{default:s(()=>[a(I,{class:se(["supplier-card",A(t)]),elevation:"2"},{default:s(()=>[a(U,{class:"d-flex align-center justify-space-between"},{default:s(()=>[r("div",ye,[a(T,{icon:H(t),color:z(t),class:"mr-2",size:"large"},null,8,["icon","color"]),r("div",null,[r("div",he,u(t.supplier),1),a(fe,{color:t.active?"success":"grey",size:"small",class:"mt-1"},{default:s(()=>[f(u(t.active?"Active":"Disabled"),1)]),_:2},1032,["color"])])]),t.current_pid?(V(),L("div",Ve,[a(T,{icon:"mdi-circle",color:"primary",size:"small",class:"pulse-icon"}),r("span",Ce,"PID: "+u(t.current_pid),1)])):oe("",!0)]),_:2},1024),a(B),a($,null,{default:s(()=>[a(b,{dense:""},{default:s(()=>[a(m,{cols:"12"},{default:s(()=>[e[7]||(e[7]=r("div",{class:"metric-label"},"Health Score (24h)",-1)),a(ve,{"model-value":t.health_score,color:J(t.health_score),height:"20",class:"health-bar"},{default:s(()=>[r("strong",null,u(t.health_score)+"%",1)]),_:2},1032,["model-value","color"])]),_:2},1024),a(m,{cols:"6"},{default:s(()=>[e[8]||(e[8]=r("div",{class:"metric-label"},"Last Sync",-1)),r("div",Se,u(W(t.last_sync)),1)]),_:2},1024),a(m,{cols:"6"},{default:s(()=>[e[9]||(e[9]=r("div",{class:"metric-label"},"Success Rate",-1)),r("div",ke,u(t.success_rate_24h)+"% ",1)]),_:2},1024),a(m,{cols:"12"},{default:s(()=>[e[10]||(e[10]=r("div",{class:"metric-label"},"Sessions (24h)",-1)),r("div",we,u(t.sessions_count_24h)+" runs ",1)]),_:2},1024)]),_:2},1024)]),_:2},1024),a(B),a(D,{class:"px-4 py-3"},{default:s(()=>[t.current_pid?(V(),S(d,{key:1,color:"error",variant:"elevated","prepend-icon":"mdi-stop-circle",onClick:_=>X(t),loading:n.value.stop?.[t.supplier]},{default:s(()=>[...e[12]||(e[12]=[f(" Force Stop ",-1)])]),_:1},8,["onClick","loading"])):(V(),S(d,{key:0,color:"primary",variant:"elevated","prepend-icon":"mdi-play",onClick:_=>j(t.supplier),disabled:!t.active,loading:n.value.run[t.supplier]},{default:s(()=>[...e[11]||(e[11]=[f(" Run ",-1)])]),_:1},8,["onClick","disabled","loading"])),a(d,{color:"secondary",variant:"outlined","prepend-icon":"mdi-link-variant",class:"ml-2",onClick:_=>q(t.supplier),disabled:!t.active,loading:n.value.collect[t.supplier]},{default:s(()=>[...e[13]||(e[13]=[f(" Collect URLs ",-1)])]),_:1},8,["onClick","disabled","loading"]),a(R),a(d,{variant:"text",icon:"mdi-history",onClick:_=>Y(t.supplier),title:"View History"},null,8,["onClick"]),a(d,{variant:"text",icon:"mdi-cog",onClick:_=>K(t.supplier),title:"Settings"},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["class"])]),_:2},1024))),128))]),_:1}),a(P,{modelValue:c.value.open,"onUpdate:modelValue":e[2]||(e[2]=t=>c.value.open=t),"max-width":"600"},{default:s(()=>[a(I,null,{default:s(()=>[a(U,null,{default:s(()=>[r("span",xe,"Run Parser: "+u(c.value.supplier),1)]),_:1}),a($,null,{default:s(()=>[a(ne,{ref:"runForm"},{default:s(()=>[a(ie,{modelValue:c.value.config,"onUpdate:modelValue":e[0]||(e[0]=t=>c.value.config=t),label:"Configuration (JSON)",placeholder:"{}",rows:"10",variant:"outlined",class:"mono-font",rules:[G]},null,8,["modelValue","rules"])]),_:1},512)]),_:1}),a(D,null,{default:s(()=>[a(R),a(d,{variant:"text",onClick:e[1]||(e[1]=t=>c.value.open=!1)},{default:s(()=>[...e[14]||(e[14]=[f(" Cancel ",-1)])]),_:1}),a(d,{color:"primary",variant:"elevated",onClick:M,loading:n.value.run[c.value.supplier]},{default:s(()=>[...e[15]||(e[15]=[f(" Start ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(P,{modelValue:i.value.open,"onUpdate:modelValue":e[5]||(e[5]=t=>i.value.open=t),"max-width":"520"},{default:s(()=>[a(I,null,{default:s(()=>[a(U,null,{default:s(()=>[r("span",be,"Collect URLs: "+u(i.value.supplier),1)]),_:1}),a($,null,{default:s(()=>[a(ue,{modelValue:i.value.profileId,"onUpdate:modelValue":e[3]||(e[3]=t=>i.value.profileId=t),items:i.value.profileItems,label:"Профиль сбора",variant:"outlined",density:"compact",loading:i.value.loading},null,8,["modelValue","items","loading"]),e[16]||(e[16]=r("div",{class:"text-caption text-grey-darken-1 mt-2"}," Профиль задаёт фильтры/категории для collect-urls. Без профиля используется базовая конфигурация. ",-1))]),_:1}),a(D,null,{default:s(()=>[a(R),a(d,{variant:"text",onClick:e[4]||(e[4]=t=>i.value.open=!1)},{default:s(()=>[...e[17]||(e[17]=[f("Отмена",-1)])]),_:1}),a(d,{color:"primary",loading:n.value.collect[i.value.supplier],onClick:E},{default:s(()=>[...e[18]||(e[18]=[f(" Запустить ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ce,{modelValue:C.value.show,"onUpdate:modelValue":e[6]||(e[6]=t=>C.value.show=t),color:C.value.color},{default:s(()=>[f(u(C.value.message),1)]),_:1},8,["modelValue","color"])]),_:1}))}}),Ne=pe(Ie,[["__scopeId","data-v-310b49ff"]]);export{Ne as default};
