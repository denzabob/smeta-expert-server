import{be as le,r as g,f as x,ac as oe,a6 as re,w as ne,bf as ie,C as S,D as a,bj as v,G as s,z as o,bi as p,aB as r,bg as b,B as H,bh as ue,a9 as ce,n as de,bk as ve,F as u}from"./vendor-Cu69IzCA.js";import{R as I,j as V,b as L,c as U,i as _,q as R,a as c,d as E,S as fe,o as B,T as me,r as ge,D as $,F as pe,V as _e,_ as ye}from"./index-BbPvUMNu.js";import{d as j}from"./en-US-CEnKpqyg.js";import{f as O}from"./format-BraVObjy.js";import{f as we}from"./formatDistanceToNow-B6Nhz5gL.js";const xe={class:"d-flex align-center"},Se={class:"ml-3"},be={class:"text-h5"},ke={class:"text-subtitle-2 text-grey"},Ce={key:0,class:"ml-2"},he={class:"d-flex align-center gap-2"},Ve={class:"stat-box success-stat"},Ae={class:"stat-value"},De={class:"stat-box error-stat"},Ne={class:"stat-value"},Ie={class:"metric-value"},Le={class:"metric-value"},Be={class:"metric-value"},Te={class:"d-flex align-center"},Fe={class:"d-flex align-center gap-2"},Me={class:"log-timestamp"},ze={class:"log-level"},Pe={class:"log-message"},He={key:0,class:"log-context"},Ue={key:0,class:"text-center pa-4 text-grey"},Re={key:1,class:"text-center pa-4"},Ee=le({__name:"SessionMonitor",setup($e){const q=ve(),T=ie();let n=!1;const t=g(null),f=g([]),m=g({session:!1,logs:!1}),A=g(!1),C=g(null),d=g(!0),k=g("all"),y=g(null);let D=null,N=null;const F=x(()=>!t.value||!t.value.total_urls?0:Math.round(t.value.processed_count/t.value.total_urls*100)),G=x(()=>{if(!t.value?.started_at)return"N/A";try{return we(new Date(t.value.started_at),{includeSeconds:!0})}catch{return"N/A"}}),w=x(()=>{if(!t.value||t.value.status!=="running"||!t.value.started_at||t.value.processed_count===0)return 0;const l=j(new Date,new Date(t.value.started_at)),e=t.value.total_urls-t.value.processed_count,i=t.value.processed_count/l;return i===0?0:Math.round(e/i/60)}),J=x(()=>{if(!t.value||t.value.status!=="running")return"N/A";if(w.value===0)return"Calculating...";if(w.value>60){const l=Math.floor(w.value/60),e=w.value%60;return`${l}h ${e}m`}return`${w.value}m`}),W=x(()=>{if(!t.value?.started_at||t.value.processed_count===0)return"N/A";const l=j(new Date,new Date(t.value.started_at));return l===0?"N/A":`${(t.value.processed_count/l).toFixed(2)} items/sec`}),K=x(()=>k.value==="all"?f.value:k.value==="error"?f.value.filter(l=>l.level==="error"||l.level==="critical"):k.value==="warning"?f.value.filter(l=>l.level==="warning"):f.value);oe(()=>{n=!1,Q(),D=window.setInterval(h,5e3),N=window.setInterval(M,2e3)}),re(()=>{n=!0,D&&clearInterval(D),N&&clearInterval(N)}),ne(()=>f.value.length,()=>{d.value&&!n&&P()});async function Q(){n||await Promise.all([h(),M()])}async function h(){if(!n)try{m.value.session=!0,C.value=null;const l=Number(T.params.id),e=await I.getSession(l);n||(t.value=e)}catch(l){n||(C.value=l.message||"Unknown error",console.error("Failed to load session:",l))}finally{n||(m.value.session=!1)}}async function M(){if(!n)try{m.value.logs=!0;const l=Number(T.params.id),e=await I.getSessionLogs(l,{per_page:500});n||(f.value=e.data)}catch(l){n||console.error("Failed to load logs:",l)}finally{n||(m.value.logs=!1)}}async function X(){if(!(n||!t.value)&&confirm("Are you sure you want to force stop this session?"))try{A.value=!0,await I.stopSession(t.value.id),n||await h()}catch(l){n||(console.error("Failed to stop session:",l),alert("Failed to stop session"))}finally{n||(A.value=!1)}}function z(l){switch(l){case"completed":return"success";case"running":return"primary";case"failed":return"error";case"stopped":return"warning";case"pending":return"grey";default:return"grey"}}function Y(l){if(!l)return"N/A";try{return O(new Date(l),"MMM dd, HH:mm:ss")}catch{return"Invalid date"}}function Z(l){try{return O(new Date(l),"HH:mm:ss.SSS")}catch{return""}}function ee(){d.value=!d.value,d.value&&P()}function te(){f.value=[]}function P(){de(()=>{y.value&&!n&&(y.value.scrollTop=y.value.scrollHeight)})}function se(){if(!y.value)return;const{scrollTop:l,scrollHeight:e,clientHeight:i}=y.value;!(l+i>=e-10)&&d.value&&(d.value=!1)}function ae(){q.push("/parser")}return(l,e)=>(u(),S(_e,{fluid:"",class:"session-monitor"},{default:a(()=>[t.value?(u(),S(V,{key:0},{default:a(()=>[s(c,{cols:"12"},{default:a(()=>[s(L,{class:"session-header",elevation:"2"},{default:a(()=>[s(U,{class:"d-flex align-center justify-space-between"},{default:a(()=>[o("div",xe,[s(_,{icon:"mdi-arrow-left",variant:"text",onClick:ae}),o("div",Se,[o("div",be,[p(r(t.value.supplier)+" ",1),s(R,{color:z(t.value.status),class:"ml-2",size:"small"},{default:a(()=>[p(r(t.value.status.toUpperCase()),1)]),_:1},8,["color"])]),o("div",ke,[p(" Session #"+r(t.value.id)+" | Started: "+r(Y(t.value.started_at))+" ",1),t.value.pid?(u(),b("span",Ce,"| PID: "+r(t.value.pid),1)):v("",!0)])])]),o("div",he,[t.value.status==="running"?(u(),S(_,{key:0,color:"error",variant:"elevated","prepend-icon":"mdi-stop",onClick:X,loading:A.value},{default:a(()=>[...e[1]||(e[1]=[p(" Force Stop ",-1)])]),_:1},8,["loading"])):v("",!0),s(_,{icon:"mdi-refresh",variant:"text",onClick:h,loading:m.value.session},null,8,["loading"])])]),_:1})]),_:1})]),_:1}),s(c,{cols:"12"},{default:a(()=>[s(L,{class:"metrics-card",elevation:"2"},{default:a(()=>[s(E,null,{default:a(()=>[s(V,{align:"center"},{default:a(()=>[s(c,{cols:"12",md:"6"},{default:a(()=>[e[2]||(e[2]=o("div",{class:"metric-label mb-2"},"Processing Progress",-1)),s(fe,{"model-value":F.value,color:z(t.value.status),height:"30",class:"progress-bar"},{default:a(()=>[o("strong",null,r(t.value.processed_count)+" / "+r(t.value.total_urls||"?")+" ("+r(F.value)+"%) ",1)]),_:1},8,["model-value","color"])]),_:1}),s(c,{cols:"6",md:"3"},{default:a(()=>[o("div",Ve,[s(B,{icon:"mdi-check-circle",size:"large",color:"success"}),o("div",Ae,r(t.value.success_count),1),e[3]||(e[3]=o("div",{class:"stat-label"},"Success",-1))])]),_:1}),s(c,{cols:"6",md:"3"},{default:a(()=>[o("div",De,[s(B,{icon:"mdi-alert-circle",size:"large",color:"error"}),o("div",Ne,r(t.value.error_count),1),e[4]||(e[4]=o("div",{class:"stat-label"},"Errors",-1))])]),_:1}),s(c,{cols:"6",md:"3"},{default:a(()=>[e[5]||(e[5]=o("div",{class:"metric-label"},"Runtime",-1)),o("div",Ie,r(G.value),1)]),_:1}),s(c,{cols:"6",md:"3"},{default:a(()=>[e[6]||(e[6]=o("div",{class:"metric-label"},"ETA",-1)),o("div",{class:H(["metric-value",{"text-warning":w.value>30}])},r(J.value),3)]),_:1}),s(c,{cols:"6",md:"3"},{default:a(()=>[e[7]||(e[7]=o("div",{class:"metric-label"},"Speed",-1)),o("div",Le,r(W.value),1)]),_:1}),s(c,{cols:"6",md:"3"},{default:a(()=>[e[8]||(e[8]=o("div",{class:"metric-label"},"Screenshots",-1)),o("div",Be,r(t.value.screenshots_taken),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(c,{cols:"12"},{default:a(()=>[s(L,{class:"logs-terminal",elevation:"2"},{default:a(()=>[s(U,{class:"d-flex align-center justify-space-between"},{default:a(()=>[o("div",Te,[s(B,{icon:"mdi-console",class:"mr-2"}),e[10]||(e[10]=o("span",null,"Live Logs",-1)),d.value?(u(),S(R,{key:0,color:"primary",size:"small",class:"ml-2"},{default:a(()=>[...e[9]||(e[9]=[p(" AUTO-SCROLL ",-1)])]),_:1})):v("",!0)]),o("div",Fe,[s(me,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=i=>k.value=i),variant:"outlined",density:"compact",mandatory:""},{default:a(()=>[s(_,{value:"all"},{default:a(()=>[...e[11]||(e[11]=[p("All",-1)])]),_:1}),s(_,{value:"error",color:"error"},{default:a(()=>[...e[12]||(e[12]=[p("Errors",-1)])]),_:1}),s(_,{value:"warning",color:"warning"},{default:a(()=>[...e[13]||(e[13]=[p("Warnings",-1)])]),_:1})]),_:1},8,["modelValue"]),s(_,{icon:d.value?"mdi-pause":"mdi-play",color:d.value?"primary":"grey",variant:"text",onClick:ee,title:d.value?"Disable Auto-scroll":"Enable Auto-scroll"},null,8,["icon","color","title"]),s(_,{icon:"mdi-delete",variant:"text",onClick:te,title:"Clear Logs"})])]),_:1}),s(ge),s(E,{class:"pa-0"},{default:a(()=>[o("div",{ref_key:"logsContainer",ref:y,class:"logs-container",onScroll:se},[(u(!0),b(ce,null,ue(K.value,i=>(u(),b("div",{key:i.id,class:H(["log-line",`log-${i.level||"info"}`])},[o("span",Me,r(Z(i.created_at)),1),o("span",ze,r((i.level||"INFO").toUpperCase()),1),o("span",Pe,r(i.message),1),i.context?(u(),b("span",He,r(JSON.stringify(i.context)),1)):v("",!0)],2))),128)),f.value.length===0?(u(),b("div",Ue," No logs yet... ")):v("",!0),m.value.logs?(u(),b("div",Re,[s($,{indeterminate:"",size:"32"})])):v("",!0)],544)]),_:1})]),_:1})]),_:1})]),_:1})):v("",!0),!t.value&&m.value.session?(u(),S(V,{key:1},{default:a(()=>[s(c,{cols:"12",class:"text-center pa-8"},{default:a(()=>[s($,{indeterminate:"",size:"64"}),e[14]||(e[14]=o("div",{class:"mt-4 text-h6"},"Loading session...",-1))]),_:1})]),_:1})):v("",!0),!t.value&&!m.value.session&&C.value?(u(),S(V,{key:2},{default:a(()=>[s(c,{cols:"12"},{default:a(()=>[s(pe,{type:"error",prominent:""},{default:a(()=>[e[15]||(e[15]=o("div",{class:"text-h6"},"Failed to load session",-1)),o("div",null,r(C.value),1)]),_:1})]),_:1})]),_:1})):v("",!0)]),_:1}))}}),Ke=ye(Ee,[["__scopeId","data-v-08c11a71"]]);export{Ke as default};
